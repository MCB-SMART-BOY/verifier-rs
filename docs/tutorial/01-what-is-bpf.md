# 第一章：什么是 BPF？

# Chapter 1: What is BPF?

```
+-----------------------------------------------------------------------------------+
|                                                                                   |
|    ██████+ ██████+ ███████+    ██+   ██+███████+██████+ ██+███████+██+███████+    |
|    ██+--██+██+--██+██+----+    ██|   ██|██+----+██+--██+██|██+----+██|██+----+    |
|    ██████++██████++█████+      ██|   ██|█████+  ██████++██|█████+  ██|█████+      |
|    ██+--██+██+---+ ██+--+      +██+ ██++██+--+  ██+--██+██|██+--+  ██|██+--+      |
|    ██████++██|     ██|          +████++ ███████+██|  ██|██|██|     ██|███████+    |
|    +-----+ +-+     +-+           +---+  +------++-+  +-++-++-+     +-++------+    |
|                                                                                   |
|                       Berkeley Packet Filter / Extended BPF                       |
|                          安全地在内核中运行用户代码                                   |
+-----------------------------------------------------------------------------------+
```

## 一个根本性的问题 | A Fundamental Question

假设你是 Linux 内核的守护者。每天有无数程序想在内核里运行代码。

**核心问题：你怎么知道这些代码是安全的？**

```
+-----------------------------------------------------------------------------------+
|                              内核安全的三大威胁                                   |
|                     Three Major Threats to Kernel Security                        |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-----------------+     +-----------------+     +-----------------+             |
|   |  💀 系统崩溃    |     |  🔓 数据泄露    |     |  🔄 系统卡死    |             |
|   |  System Crash   |     |   Data Leak     |     |  System Hang    |             |
|   +-----------------+     +-----------------+     +-----------------+             |
|   |                 |     |                 |     |                 |             |
|   |  代码有 bug     |     |  恶意代码窃取   |     |  死循环导致     |             |
|   |  导致内核崩溃   |     |  敏感内存数据   |     |  CPU 100%       |             |
|   |                 |     |                 |     |                 |             |
|   |  例如:          |     |  例如:          |     |  例如:          |             |
|   |  • 空指针解引用 |     |  • 读取密码     |     |  while(1) {}    |             |
|   |  • 越界访问     |     |  • 读取密钥     |     |  无限递归       |             |
|   |  • 栈溢出       |     |  • 读取其他进程 |     |                 |             |
|   +-----------------+     +-----------------+     +-----------------+             |
|                                                                                   |
|                         BPF 验证器的使命：阻止这一切！                            |
+-----------------------------------------------------------------------------------+
```

---

## BPF 的历史演进 | History of BPF

### 1992 年：经典 BPF 诞生 | Classic BPF (cBPF)

BPF 最初是 **Berkeley Packet Filter**（伯克利包过滤器），用于高效的网络包过滤。

```
+-----------------------------------------------------------------------------------+
|                           网络包过滤的性能问题                                    |
|                   The Performance Problem of Packet Filtering                     |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|  问题场景：你想抓取特定的网络包（如 TCP 端口 80）                                 |
|                                                                                   |
|  -------------------------------------------------------------------------------  |
|                                                                                   |
|  【方案 A：在用户空间过滤】                                                       |
|                                                                                   |
|      网卡                  内核                      用户空间                     |
|    +------+            +----------+              +--------------+                 |
|    | 📦📦📦 | --------->|  复制到  | ----------->|   过滤程序   |                 |
|    | 📦📦📦 |  10万包/秒 | 用户空间 |  10万次复制 |  "只要80端口" |                 |
|    | 📦📦📦 |            |          |     😰      |              |                 |
|    +------+            +----------+              +--------------+                 |
|                              |                          |                         |
|                              v                          v                         |
|                        CPU 负载爆炸！              99% 的包被丢弃                 |
|                        复制成本太高                但复制成本已经付出             |
|                                                                                   |
|  -------------------------------------------------------------------------------  |
|                                                                                   |
|  【方案 B：在内核中过滤（BPF）】                                                  |
|                                                                                   |
|      网卡                  内核 (BPF 过滤器)          用户空间                    |
|    +------+            +----------------+         +--------------+                |
|    | 📦📦📦 | --------->| if port != 80  | ------->|   过滤程序   |                |
|    | 📦📦📦 |  10万包/秒 |   drop;        |  100包  |  只收到想要的 |                |
|    | 📦📦📦 |            | else           |   😊    |  100 个包！  |                |
|    +------+            |   pass;        |         |              |                |
|                        +----------------+         +--------------+                |
|                              |                                                    |
|                              v                                                    |
|                        99.9% 的包在内核                                           |
|                        就被丢弃了！                                               |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

**经典 BPF 的关键洞察**：与其把所有数据复制到用户空间再过滤，不如把过滤逻辑放到内核中执行。

### 2014 年：eBPF 革命 | The eBPF Revolution

Linux 内核 3.18 引入了 **eBPF**（extended BPF），这是一次革命性的扩展：

```
+-----------------------------------------------------------------------------------+
|                            cBPF vs eBPF 对比                                      |
|                          cBPF vs eBPF Comparison                                  |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|      特性              经典 BPF (1992)            eBPF (2014+)                    |
|    -------------------------------------------------------------------------      |
|                                                                                   |
|      寄存器数量              2 个                      11 个                      |
|                           (A, X)                (R0-R10, 64位)                    |
|                                                                                   |
|      寄存器宽度            32 位                      64 位                       |
|                                                                                   |
|      栈大小                 16 字节                   512 字节                    |
|                                                                                   |
|      指令数量              ~30 条                     100+ 条                     |
|                                                                                   |
|      可调用函数             无                       辅助函数 (200+)              |
|                                                                                   |
|      应用场景            仅网络包过滤            网络、追踪、安全...             |
|                                                                                   |
|      Map 支持               无                    Hash/Array/...                  |
|                                                                                   |
|      JIT 编译              可选                      标准                         |
|                                                                                   |
|      验证器              简单检查                   完整静态分析                  |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### eBPF 的安全模型 | eBPF Security Model

```
+-----------------------------------------------------------------------------------+
|                           eBPF 程序的生命周期                                     |
|                        Lifecycle of an eBPF Program                               |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|                                 用户空间                                          |
|    +-----------------------------------------------------------------------+      |
|    |                                                                       |      |
|    |   +--------------+      +--------------+      +--------------+        |      |
|    |   |    C 代码    |      |   Clang/     |      |  BPF 字节码  |        |      |
|    |   |  int foo() { | ---> |    LLVM      | ---> |   .o 文件    |        |      |
|    |   |    ...       |      |   编译器     |      |              |        |      |
|    |   |  }           |      +--------------+      +------+-------+        |      |
|    |   +--------------+                                   |                |      |
|    |                                                      |                |      |
|    |                          bpf() 系统调用              |                |      |
|    +------------------------------------------------------+----------------+      |
|                                                           |                       |
|    -------------------------------------------------------+-------------------    |
|                                                           |                       |
|                                 内核空间                  v                       |
|    +-----------------------------------------------------------------------+      |
|    |                                                                       |      |
|    |   +---------------------------------------------------------------+   |      |
|    |   |                          验证器                               |   |      |
|    |   |                         Verifier                              |   |      |
|    |   |                                                               |   |      |
|    |   |  +-------------+   +-------------+   +-------------+          |   |      |
|    |   |  |  CFG 分析   |   |  类型检查   |   |  边界检查   |          |   |      |
|    |   |  | 检测死循环  |   | 追踪寄存器  |   | 防止越界    |          |   |      |
|    |   |  +-------------+   +-------------+   +-------------+          |   |      |
|    |   |  +-------------+   +-------------+   +-------------+          |   |      |
|    |   |  |  指令限制   |   |  资源追踪   |   |  权限检查   |          |   |      |
|    |   |  | 最多100万条 |   | 引用计数    |   | CAP_BPF     |          |   |      |
|    |   |  +-------------+   +-------------+   +-------------+          |   |      |
|    |   +----------------------------+----------------------------------+   |      |
|    |                                |                                      |      |
|    |                +---------------+---------------+                      |      |
|    |                v                               v                      |      |
|    |       +--------------+               +--------------+                 |      |
|    |       |   ✓ 通过     |               |   ✗ 拒绝     |                 |      |
|    |       +------+-------+               +--------------+                 |      |
|    |              |                                                        |      |
|    |              v                                                        |      |
|    |     +--------------+                                                  |      |
|    |     |  JIT 编译器  |  将 BPF 字节码编译为                             |      |
|    |     |              |  本地机器码 (x86, ARM...)                        |      |
|    |     +------+-------+                                                  |      |
|    |            |                                                          |      |
|    |            v                                                          |      |
|    |   +---------------------------------------------------------------+   |      |
|    |   |                      挂载点 (Attachment)                      |   |      |
|    |   |                                                               |   |      |
|    |   |  +--------+  +--------+  +--------+  +--------+  +--------+   |   |      |
|    |   |  | kprobe |  |  XDP   |  |  TC    |  | socket |  | cgroup |   |   |      |
|    |   |  |内核函数|  |网卡驱动|  |流量控制|  |套接字  |  |容器组  |   |   |      |
|    |   |  +--------+  +--------+  +--------+  +--------+  +--------+   |   |      |
|    |   +---------------------------------------------------------------+   |      |
|    |                                                                       |      |
|    +-----------------------------------------------------------------------+      |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## BPF 的应用场景 | BPF Use Cases

### 1. 网络 | Networking

```
+-----------------------------------------------------------------------------------+
|                              BPF 网络应用                                         |
|                         BPF Networking Applications                               |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|                          +-----------------+                                      |
|                          |    网络数据包   |                                      |
|                          |  Network Packet |                                      |
|                          +--------+--------+                                      |
|                                   |                                               |
|                                   v                                               |
|  +-------------------------------------------------------------------------+      |
|  |                          XDP (eXpress Data Path)                        |      |
|  |                                                                         |      |
|  |   位置: 网卡驱动层 (最早的处理点)                                       |      |
|  |   性能: 可达 10M+ 包/秒                                                 |      |
|  |   用途: DDoS 防护、负载均衡、包转发                                     |      |
|  |                                                                         |      |
|  |   动作:  XDP_DROP    XDP_PASS    XDP_TX       XDP_REDIRECT              |      |
|  |          丢弃        继续处理    从同一网卡    转发到其他               |      |
|  |                                  发回         网卡/CPU                  |      |
|  +-------------------------------------------------------------------------+      |
|                                   |                                               |
|                                   v                                               |
|  +-------------------------------------------------------------------------+      |
|  |                          TC (Traffic Control)                           |      |
|  |                                                                         |      |
|  |   位置: 网络协议栈入口/出口                                             |      |
|  |   用途: QoS、流量整形、NAT、容器网络                                    |      |
|  |                                                                         |      |
|  |   +-------------+                +-------------+                        |      |
|  |   |  TC ingress |                |  TC egress  |                        |      |
|  |   |   入站处理  |                |   出站处理  |                        |      |
|  |   +-------------+                +-------------+                        |      |
|  +-------------------------------------------------------------------------+      |
|                                   |                                               |
|                                   v                                               |
|  +-------------------------------------------------------------------------+      |
|  |                          Socket Programs                                |      |
|  |                                                                         |      |
|  |   +--------------+    +--------------+    +--------------+              |      |
|  |   | SO_ATTACH_   |    | SK_SKB       |    | SK_MSG       |              |      |
|  |   | BPF          |    | sockmap 重定向|    | 消息级别处理 |              |      |
|  |   | 套接字过滤   |    |              |    |              |              |      |
|  |   +--------------+    +--------------+    +--------------+              |      |
|  +-------------------------------------------------------------------------+      |
|                                                                                   |
|  实际案例:                                                                        |
|  • Cilium - Kubernetes 网络和安全                                                 |
|  • Katran - Facebook 的 L4 负载均衡器 (10M+ 请求/秒)                              |
|  • Cloudflare - DDoS 防护                                                         |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### 2. 可观测性 | Observability

```
+-----------------------------------------------------------------------------------+
|                            BPF 可观测性应用                                       |
|                        BPF Observability Applications                             |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|  +---------------------------------------------------------------------------+    |
|  |                                                                           |    |
|  |                           用户空间                                        |    |
|  |   +-----------------------------------------------------------------+     |    |
|  |   |     应用程序           应用程序           应用程序              |     |    |
|  |   |    +-------+          +-------+          +-------+              |     |    |
|  |   |    | nginx |          | mysql |          | redis |              |     |    |
|  |   |    +---+---+          +---+---+          +---+---+              |     |    |
|  |   |        | uprobe           | uprobe           | uprobe           |     |    |
|  |   |        v                  v                  v                  |     |    |
|  |   |   +---------------------------------------------------------+   |     |    |
|  |   |   |                  BPF 探针收集数据                       |   |     |    |
|  |   |   |  • 函数调用延迟    • 参数值      • 返回值               |   |     |    |
|  |   |   +---------------------------------------------------------+   |     |    |
|  |   +-----------------------------------------------------------------+     |    |
|  |                                                                           |    |
|  |  ---------------------------------------------------------------------    |    |
|  |                                                                           |    |
|  |                           内核空间                                        |    |
|  |   +-----------------------------------------------------------------+     |    |
|  |   |                                                                 |     |    |
|  |   |  +-------------+  +-------------+  +-------------+              |     |    |
|  |   |  |   kprobe    |  | tracepoint  |  |   fentry    |              |     |    |
|  |   |  |  动态探针   |  |  静态探针   |  |  高效探针   |              |     |    |
|  |   |  |             |  |             |  |  (BTF-based)|              |     |    |
|  |   |  +------+------+  +------+------+  +------+------+              |     |    |
|  |   |         |                |                |                     |     |    |
|  |   |         v                v                v                     |     |    |
|  |   |   +-------------------------------------------------------+     |     |    |
|  |   |   |                    内核函数                           |     |     |    |
|  |   |   |                                                       |     |     |    |
|  |   |   |  sys_read()  tcp_sendmsg()  schedule()  ...           |     |     |    |
|  |   |   |                                                       |     |     |    |
|  |   |   +-------------------------------------------------------+     |     |    |
|  |   |                                                                 |     |    |
|  |   +-----------------------------------------------------------------+     |    |
|  |                                                                           |    |
|  +---------------------------------------------------------------------------+    |
|                                                                                   |
|  探针类型详解:                                                                    |
|  +-------------------------------------------------------------------------+      |
|  |  类型         位置           开销      稳定性     用途                  |      |
|  |  ---------------------------------------------------------------------  |      |
|  |  kprobe      任意内核函数    中等      低        调试、探索             |      |
|  |  kretprobe   函数返回点      中等      低        获取返回值             |      |
|  |  tracepoint  预定义位置      低        高        生产环境监控           |      |
|  |  fentry/fexit BTF定义的函数  最低      高        推荐用于新项目         |      |
|  |  uprobe      用户空间函数    高        中        应用层追踪             |      |
|  +-------------------------------------------------------------------------+      |
|                                                                                   |
|  实际案例:                                                                        |
|  • bpftrace - 高级追踪语言 (类似 DTrace)                                          |
|  • BCC - Python/Lua 工具集                                                        |
|  • Pixie - Kubernetes 可观测性平台                                                |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### 3. 安全 | Security

```
+-----------------------------------------------------------------------------------+
|                              BPF 安全应用                                         |
|                          BPF Security Applications                                |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|  +---------------------------------------------------------------------------+    |
|  |                            Seccomp-BPF                                    |    |
|  |                                                                           |    |
|  |   用途: 限制进程可以调用的系统调用                                        |    |
|  |                                                                           |    |
|  |   +-------------+           +-----------------------------+               |    |
|  |   |   应用程序  | --------> |      Seccomp-BPF 过滤器     |               |    |
|  |   |  syscall()  |           |                             |               |    |
|  |   +-------------+           |   if (syscall == execve)    |               |    |
|  |                             |       return KILL;          |               |    |
|  |                             |   if (syscall == open &&    |               |    |
|  |                             |       path.startswith("/etc"))              |    |
|  |                             |       return ERRNO(EACCES); |               |    |
|  |                             |   return ALLOW;             |               |    |
|  |                             +-----------------------------+               |    |
|  |                                                                           |    |
|  |   应用: Docker/Kubernetes 容器沙箱, Chrome 沙箱                           |    |
|  +---------------------------------------------------------------------------+    |
|                                                                                   |
|  +---------------------------------------------------------------------------+    |
|  |                              LSM BPF                                      |    |
|  |                     (Linux Security Module)                               |    |
|  |                                                                           |    |
|  |   用途: 实现自定义的安全策略                                              |    |
|  |                                                                           |    |
|  |        安全决策点                             BPF 程序                    |    |
|  |   +----------------+                     +-----------------+              |    |
|  |   | file_open()    | ------------------> | 检查文件路径    |              |    |
|  |   | socket_bind()  | ------------------> | 检查端口号      |              |    |
|  |   | task_alloc()   | ------------------> | 检查进程创建    |              |    |
|  |   | bpf_prog_load()| ------------------> | 检查 BPF 加载   |              |    |
|  |   +----------------+                     +-----------------+              |    |
|  |                                                                           |    |
|  |   应用: 容器运行时安全, 零信任网络                                        |    |
|  +---------------------------------------------------------------------------+    |
|                                                                                   |
|  +---------------------------------------------------------------------------+    |
|  |                            运行时安全检测                                 |    |
|  |                                                                           |    |
|  |   用途: 实时检测可疑行为                                                  |    |
|  |                                                                           |    |
|  |   +-------------------------------------------------------------------+   |    |
|  |   |                          监控的行为                               |   |    |
|  |   |                                                                   |   |    |
|  |   |   • 进程执行              execve() / execveat()                   |   |    |
|  |   |   • 文件访问              open() / unlink() / rename()            |   |    |
|  |   |   • 网络连接              connect() / accept() / bind()           |   |    |
|  |   |   • 权限提升              setuid() / capabilities                 |   |    |
|  |   |   • 内核模块              init_module() / finit_module()          |   |    |
|  |   |   • 容器逃逸              mount namespace / ptrace                |   |    |
|  |   +-------------------------------------------------------------------+   |    |
|  |                                                                           |    |
|  |   应用: Falco, Tetragon, Tracee                                           |    |
|  +---------------------------------------------------------------------------+    |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## BPF 虚拟机详解 | BPF Virtual Machine Details

### 寄存器架构 | Register Architecture

```
+-----------------------------------------------------------------------------------+
|                            BPF 寄存器模型                                         |
|                          BPF Register Model                                       |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +--------------------------------------------------------------------------+    |
|   |                         11 个 64 位寄存器                                |    |
|   |                        11 64-bit Registers                               |    |
|   +--------------------------------------------------------------------------+    |
|   |                                                                          |    |
|   |   +------+-----------------------------------------------------------+   |    |
|   |   |  R0  | 返回值寄存器 / 辅助函数返回值                             |   |    |
|   |   |      | Return value register / Helper function return value     |   |    |
|   |   |      |                                                           |   |    |
|   |   |      | • BPF 程序结束时，R0 的值就是程序的返回值                 |   |    |
|   |   |      | • 调用辅助函数后，返回值存放在 R0                         |   |    |
|   |   |      | • 例如: XDP 程序通过 R0 返回 XDP_PASS/XDP_DROP            |   |    |
|   |   +------+-----------------------------------------------------------+   |    |
|   |                                                                          |    |
|   |   +------+-----------------------------------------------------------+   |    |
|   |   |  R1  | 第一个参数 / 程序上下文指针                               |   |    |
|   |   |      | First argument / Program context pointer                 |   |    |
|   |   |      |                                                           |   |    |
|   |   |      | • 程序启动时，R1 指向程序类型特定的上下文结构             |   |    |
|   |   |      | • XDP 程序: R1 -> struct xdp_md                          |   |    |
|   |   |      | • kprobe: R1 -> struct pt_regs                           |   |    |
|   |   |      | • socket filter: R1 -> struct __sk_buff                  |   |    |
|   |   +------+-----------------------------------------------------------+   |    |
|   |                                                                          |    |
|   |   +------+-----------------------------------------------------------+   |    |
|   |   |R2-R5 | 函数参数寄存器                                            |   |    |
|   |   |      | Function argument registers                              |   |    |
|   |   |      |                                                           |   |    |
|   |   |      | • 调用辅助函数时传递参数                                  |   |    |
|   |   |      | • 遵循标准调用约定: arg1=R1, arg2=R2, ..., arg5=R5       |   |    |
|   |   |      | • BPF 函数最多 5 个参数                                   |   |    |
|   |   +------+-----------------------------------------------------------+   |    |
|   |                                                                          |    |
|   |   +------+-----------------------------------------------------------+   |    |
|   |   |R6-R9 | 被调用者保存寄存器 (Callee-saved)                         |   |    |
|   |   |      | Callee-saved registers                                   |   |    |
|   |   |      |                                                           |   |    |
|   |   |      | • 调用辅助函数时，这些寄存器的值会被保留                  |   |    |
|   |   |      | • 可以用来保存跨函数调用需要保持的值                      |   |    |
|   |   |      | • 类似于 x86 的 rbx, rbp, r12-r15                        |   |    |
|   |   +------+-----------------------------------------------------------+   |    |
|   |                                                                          |    |
|   |   +------+-----------------------------------------------------------+   |    |
|   |   | R10  | 栈帧指针 (只读)                                           |   |    |
|   |   |      | Stack frame pointer (read-only)                          |   |    |
|   |   |      |                                                           |   |    |
|   |   |      | • 始终指向栈帧的顶部                                      |   |    |
|   |   |      | • 不能被修改                                              |   |    |
|   |   |      | • 栈向下增长: R10-8 是第一个栈槽                         |   |    |
|   |   |      | • 栈大小: 512 字节 (可访问 R10-1 到 R10-512)              |   |    |
|   |   +------+-----------------------------------------------------------+   |    |
|   |                                                                          |    |
|   +--------------------------------------------------------------------------+    |
|                                                                                   |
|   调用约定可视化:                                                                 |
|                                                                                   |
|   helper_func(arg1, arg2, arg3, arg4, arg5)                                       |
|               |     |     |     |     |                                           |
|               v     v     v     v     v                                           |
|              R1    R2    R3    R4    R5                                           |
|                                                                                   |
|   返回值 <--- R0                                                                  |
|                                                                                   |
|   保留值 ---> R6, R7, R8, R9 (函数调用后值不变)                                   |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### 栈模型 | Stack Model

```
+-----------------------------------------------------------------------------------+
|                              BPF 栈模型                                           |
|                            BPF Stack Model                                        |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|                            R10 (栈帧指针)                                         |
|                                 |                                                 |
|                                 v                                                 |
|   偏移量    +----------------------------------------+                            |
|   Offset    |                                        |                            |
|             |             栈顶 (不可访问)            |                            |
|      0 -----+----------------------------------------+<--- R10 指向这里           |
|             |▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓|                            |
|     -8 -----+----------------------------------------+                            |
|             |          栈槽 1 (8 字节)               |                            |
|             |     例如: 局部变量 u64 var1            |                            |
|    -16 -----+----------------------------------------+                            |
|             |          栈槽 2 (8 字节)               |                            |
|             |     例如: 临时保存 R6                  |                            |
|    -24 -----+----------------------------------------+                            |
|             |          栈槽 3 (8 字节)               |                            |
|             |                                        |                            |
|    -32 -----+----------------------------------------+                            |
|             |                                        |                            |
|             |              ...                       |                            |
|             |                                        |                            |
|             |     (更多栈空间，共 512 字节)          |                            |
|             |                                        |                            |
|   -504 -----+----------------------------------------+                            |
|             |          栈槽 63 (8 字节)              |                            |
|             |                                        |                            |
|   -512 -----+----------------------------------------+                            |
|             |▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓|                            |
|             |            栈底 (不可访问)             |                            |
|             +----------------------------------------+                            |
|                                                                                   |
|   栈访问规则:                                                                     |
|   +--------------------------------------------------------------------------+    |
|   |                                                                          |    |
|   |   ✓ 有效访问: *(R10 - 8) = value     // 写入第一个栈槽                   |    |
|   |   ✓ 有效访问: value = *(R10 - 512)   // 读取最后一个栈槽                 |    |
|   |                                                                          |    |
|   |   ✗ 无效访问: *(R10 + 0) = value     // 偏移量必须为负                   |    |
|   |   ✗ 无效访问: *(R10 - 520) = value   // 超出 512 字节限制                |    |
|   |   ✗ 无效访问: R10 = R10 + 8          // R10 是只读的                     |    |
|   |                                                                          |    |
|   +--------------------------------------------------------------------------+    |
|                                                                                   |
|   栈的典型用途:                                                                   |
|   +--------------------------------------------------------------------------+    |
|   |                                                                          |    |
|   |   1. 局部变量                                                            |    |
|   |      u64 key;                                                            |    |
|   |      *(u64 *)(r10 - 8) = 0;  // key = 0                                  |    |
|   |                                                                          |    |
|   |   2. 辅助函数参数 (需要指针时)                                           |    |
|   |      r2 = r10 - 8;           // &key                                     |    |
|   |      call bpf_map_lookup_elem // 传递栈上变量的地址                      |    |
|   |                                                                          |    |
|   |   3. 临时保存寄存器                                                      |    |
|   |      *(u64 *)(r10 - 16) = r6; // 保存 R6                                 |    |
|   |      // ... 使用 R6 做其他事 ...                                         |    |
|   |      r6 = *(u64 *)(r10 - 16); // 恢复 R6                                 |    |
|   |                                                                          |    |
|   +--------------------------------------------------------------------------+    |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### 指令格式 | Instruction Format

```
+-----------------------------------------------------------------------------------+
|                             BPF 指令格式                                          |
|                        BPF Instruction Format                                     |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   每条指令 64 位 (8 字节):                                                        |
|   Each instruction is 64 bits (8 bytes):                                          |
|                                                                                   |
|   +-------------------------------------------------------------------------+     |
|   |  字节 0   |  字节 1   | 字节 2-3  |          字节 4-7                   |     |
|   |  Byte 0   |  Byte 1   | Byte 2-3  |          Byte 4-7                   |     |
|   +-----------+-----------+-----------+-------------------------------------+     |
|   |           |           |           |                                     |     |
|   |  opcode   |  dst:src  |  offset   |           immediate                 |     |
|   |  操作码   |  寄存器   |   偏移    |            立即数                   |     |
|   |           |           |           |                                     |     |
|   |  8 bits   | 4:4 bits  |  16 bits  |            32 bits                  |     |
|   |           |           |  (有符号) |            (有符号)                 |     |
|   |           |           |           |                                     |     |
|   +-----------+-----------+-----------+-------------------------------------+     |
|                                                                                   |
|   -------------------------------------------------------------------------       |
|                                                                                   |
|   操作码 (opcode) 结构:                                                           |
|                                                                                   |
|   +--------------------------------------------------------------------------+    |
|   |                           8 位操作码                                     |    |
|   |                                                                          |    |
|   |    位 7  位 6  位 5  位 4 | 位 3  位 2  位 1  位 0                       |    |
|   |   +---------------------+-------------------------+                      |    |
|   |   |     操作 (op)       |      类别 (class)       |                      |    |
|   |   |     4 bits          |        3 bits           |                      |    |
|   |   +---------------------+-------------------------+                      |    |
|   |                                                                          |    |
|   |   类别 (class):                                                          |    |
|   |   +----------+----------------------------------------------------+      |    |
|   |   |   值     |  含义                                              |      |    |
|   |   +----------+----------------------------------------------------+      |    |
|   |   |  0x00    |  LD    - 加载 (遗留，很少使用)                     |      |    |
|   |   |  0x01    |  LDX   - 加载到寄存器                              |      |    |
|   |   |  0x02    |  ST    - 存储立即数                                |      |    |
|   |   |  0x03    |  STX   - 存储寄存器值                              |      |    |
|   |   |  0x04    |  ALU   - 32位算术运算                              |      |    |
|   |   |  0x05    |  JMP   - 64位跳转                                  |      |    |
|   |   |  0x06    |  JMP32 - 32位跳转                                  |      |    |
|   |   |  0x07    |  ALU64 - 64位算术运算                              |      |    |
|   |   +----------+----------------------------------------------------+      |    |
|   |                                                                          |    |
|   +--------------------------------------------------------------------------+    |
|                                                                                   |
|   -------------------------------------------------------------------------       |
|                                                                                   |
|   寄存器编码:                                                                     |
|                                                                                   |
|   +--------------------------------------------------------------------------+    |
|   |                           字节 1                                         |    |
|   |                                                                          |    |
|   |         高 4 位              |           低 4 位                         |    |
|   |   +-------------------------+-------------------------+                  |    |
|   |   |     src (源寄存器)      |     dst (目标寄存器)    |                  |    |
|   |   |         4 bits          |           4 bits        |                  |    |
|   |   +-------------------------+-------------------------+                  |    |
|   |                                                                          |    |
|   |   例如: 0x21 表示 src=R2, dst=R1                                         |    |
|   |                                                                          |    |
|   +--------------------------------------------------------------------------+    |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### 指令示例 | Instruction Examples

```
+-----------------------------------------------------------------------------------+
|                            常见指令示例                                           |
|                       Common Instruction Examples                                 |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|  +---------------------------------------------------------------------------+    |
|  |  示例 1: r1 = 42  (MOV64_IMM)                                             |    |
|  |                                                                           |    |
|  |  字节表示: b7 01 00 00 2a 00 00 00                                        |    |
|  |                                                                           |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |  |  0xb7  |  0x01  |  0x0000  |           0x0000002a                |     |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |  | opcode |  regs  |  offset  |           immediate                 |     |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |  | ALU64  |dst=R1  |  未使用  |              42                     |     |    |
|  |  | +MOV   |src=R0  |          |                                     |     |    |
|  |  | +IMM   |(unused)|          |                                     |     |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |                                                                           |    |
|  |  操作码分解: 0xb7 = 0b1011_0111                                           |    |
|  |              = (MOV << 4) | ALU64 | BPF_K                                 |    |
|  |              = (0xb << 4) | 0x07                                          |    |
|  +---------------------------------------------------------------------------+    |
|                                                                                   |
|  +---------------------------------------------------------------------------+    |
|  |  示例 2: r0 = r1 + r2  (ADD64_REG)                                        |    |
|  |                                                                           |    |
|  |  字节表示: 0f 20 00 00 00 00 00 00                                        |    |
|  |                                                                           |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |  |  0x0f  |  0x20  |  0x0000  |           0x00000000                |     |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |  | ALU64  |dst=R0  |  未使用  |             未使用                  |     |    |
|  |  | +ADD   |src=R2  |          |                                     |     |    |
|  |  | +REG   |        |          |                                     |     |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |                                                                           |    |
|  |  注意: 0x20 分解为 src=2, dst=0                                           |    |
|  |        先执行 r0 = r0 + r2，这里假设之前 r0 = r1                          |    |
|  +---------------------------------------------------------------------------+    |
|                                                                                   |
|  +---------------------------------------------------------------------------+    |
|  |  示例 3: if r1 > 10 goto +5  (JGT_IMM)                                    |    |
|  |                                                                           |    |
|  |  字节表示: 25 01 05 00 0a 00 00 00                                        |    |
|  |                                                                           |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |  |  0x25  |  0x01  |  0x0005  |           0x0000000a                |     |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |  |  JMP   |dst=R1  |  +5 条   |              10                     |     |    |
|  |  | +JGT   |        |  指令    |         (比较的值)                  |     |    |
|  |  | +IMM   |        |          |                                     |     |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |                                                                           |    |
|  |  语义: 如果 R1 > 10，跳转到 PC+1+5 = PC+6                                 |    |
|  |        否则继续执行下一条指令                                             |    |
|  +---------------------------------------------------------------------------+    |
|                                                                                   |
|  +---------------------------------------------------------------------------+    |
|  |  示例 4: r0 = *(u32 *)(r1 + 16)  (LDX_MEM)                                |    |
|  |                                                                           |    |
|  |  字节表示: 61 10 10 00 00 00 00 00                                        |    |
|  |                                                                           |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |  |  0x61  |  0x10  |  0x0010  |           0x00000000                |     |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |  |  LDX   |dst=R0  |   +16    |             未使用                  |     |    |
|  |  | +MEM   |src=R1  |  (偏移)  |                                     |     |    |
|  |  | +W(32) |        |          |                                     |     |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |                                                                           |    |
|  |  语义: 从地址 (R1 + 16) 读取 32 位 (4 字节) 值到 R0                       |    |
|  |        0x61 中的 '6' 表示 32 位操作 (W = word)                            |    |
|  +---------------------------------------------------------------------------+    |
|                                                                                   |
|  +---------------------------------------------------------------------------+    |
|  |  示例 5: exit  (EXIT)                                                     |    |
|  |                                                                           |    |
|  |  字节表示: 95 00 00 00 00 00 00 00                                        |    |
|  |                                                                           |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |  |  0x95  |  0x00  |  0x0000  |           0x00000000                |     |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |  |  JMP   |  全零  |   全零   |              全零                   |     |    |
|  |  | +EXIT  |        |          |                                     |     |    |
|  |  +--------+--------+----------+-------------------------------------+     |    |
|  |                                                                           |    |
|  |  语义: 结束程序执行，返回 R0 的值                                         |    |
|  +---------------------------------------------------------------------------+    |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## 为什么不直接运行机器码？ | Why Not Run Machine Code Directly?

```
+-----------------------------------------------------------------------------------+
|                      直接运行机器码 vs 使用 BPF                                   |
|                 Direct Machine Code vs Using BPF                                  |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|  【方案 A: 直接运行用户提供的机器码】                                             |
|                                                                                   |
|      用户代码                            内核空间                                 |
|    +------------+                     +------------------------------------+      |
|    |            |                     |                                    |      |
|    |  x86 机器码 | -----------------> |   ???  可能做任何事情 !!!          |      |
|    |   (二进制)  |      直接加载      |                                    |      |
|    |            |                     |   • 读取 /etc/shadow               |      |
|    +------------+                     |   • 修改内核数据结构               |      |
|                                       |   • 关闭安全机制                   |      |
|         😈 恶意用户                   |   • 安装 rootkit                   |      |
|                                       |   • 无限循环导致 DoS               |      |
|                                       |                                    |      |
|                                       +------------------------------------+      |
|                                                                                   |
|                                💀 灾难性后果！                                    |
|                                                                                   |
|  -------------------------------------------------------------------------------  |
|                                                                                   |
|  【方案 B: 使用 BPF 虚拟机 + 验证器】                                             |
|                                                                                   |
|      用户代码                    验证器                      内核空间             |
|    +------------+           +----------------+          +------------------+      |
|    |            |           |                |          |                  |      |
|    |  BPF 字节码 | -------->|   静态分析     |          |   安全的代码     |      |
|    |            |           |                |          |                  |      |
|    +------------+           | • 类型检查     |          |  • 只能访问      |      |
|                             | • 边界检查     | -------->|    允许的内存    |      |
|         😈 恶意用户         | • 终止性证明   |    ✓     |  • 保证会终止    |      |
|                             | • 权限检查     |          |  • 受限的能力    |      |
|                             |                |          |                  |      |
|                             +-------+--------+          +------------------+      |
|                                     |                                             |
|                                     | ✗ 拒绝!                                     |
|                                     v                                             |
|                             +----------------+                                    |
|                             |  错误信息:     |                                    |
|                             |  "invalid mem  |                                    |
|                             |   access"      |                                    |
|                             +----------------+                                    |
|                                                                                   |
|                                😊 安全！                                          |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### BPF 安全保证 | BPF Security Guarantees

```
+-----------------------------------------------------------------------------------+
|                          验证器提供的安全保证                                     |
|                     Security Guarantees from Verifier                             |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +--------------------------------------------------------------------------+    |
|   |                                                                          |    |
|   |  1. 内存安全 (Memory Safety)                                             |    |
|   |     -------------------------                                            |    |
|   |     • 所有内存访问都在有效范围内                                         |    |
|   |     • 栈访问: R10-1 到 R10-512                                           |    |
|   |     • Map 访问: 有效的 value 指针 + 偏移                                 |    |
|   |     • 上下文访问: 程序类型允许的字段                                     |    |
|   |     • 数据包访问: data 到 data_end 范围内                                |    |
|   |                                                                          |    |
|   |  2. 类型安全 (Type Safety)                                               |    |
|   |     -----------------------                                              |    |
|   |     • 每个寄存器都有明确的类型                                           |    |
|   |     • 指针不能用于算术运算 (除了加常量偏移)                              |    |
|   |     • 标量不能用作指针解引用                                             |    |
|   |     • 函数参数类型必须匹配                                               |    |
|   |                                                                          |    |
|   |  3. 程序终止 (Termination)                                               |    |
|   |     -------------------                                                  |    |
|   |     • 禁止无限循环 (有界循环除外)                                        |    |
|   |     • 指令数限制 (默认 100 万条)                                         |    |
|   |     • 所有路径都能到达 exit                                              |    |
|   |                                                                          |    |
|   |  4. 资源安全 (Resource Safety)                                           |    |
|   |     ---------------------                                                |    |
|   |     • 获取的引用必须释放                                                 |    |
|   |     • Map 查找返回的指针不能泄露                                         |    |
|   |     • 锁的获取和释放必须配对                                             |    |
|   |                                                                          |    |
|   |  5. 信息流控制 (Information Flow)                                        |    |
|   |     -------------------------                                            |    |
|   |     • 程序只能访问其类型允许的数据                                       |    |
|   |     • 不能泄露内核地址到用户空间                                         |    |
|   |     • 敏感操作需要适当的权限 (CAP_BPF 等)                                |    |
|   |                                                                          |    |
|   +--------------------------------------------------------------------------+    |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## 章节小结 | Chapter Summary

```
+-----------------------------------------------------------------------------------+
|                              本章要点                                             |
|                           Key Takeaways                                           |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   你现在了解了:                                                                   |
|   You now understand:                                                             |
|                                                                                   |
|   +--------------------------------------------------------------------------+    |
|   |                                                                          |    |
|   |   1. BPF 是什么                                                          |    |
|   |      • 一种在内核中安全运行用户代码的技术                                |    |
|   |      • 从 1992 年的包过滤器演变为今天的通用内核扩展机制                  |    |
|   |                                                                          |    |
|   |   2. 为什么需要 BPF                                                      |    |
|   |      • 内核中运行代码比用户空间快得多 (避免复制、上下文切换)             |    |
|   |      • 但直接运行用户代码太危险                                          |    |
|   |      • BPF 通过验证器实现安全与性能的平衡                                |    |
|   |                                                                          |    |
|   |   3. BPF 能做什么                                                        |    |
|   |      • 网络: 包过滤、负载均衡、DDoS 防护                                 |    |
|   |      • 可观测性: 追踪、性能分析、监控                                    |    |
|   |      • 安全: 系统调用过滤、运行时检测                                    |    |
|   |                                                                          |    |
|   |   4. BPF 虚拟机结构                                                      |    |
|   |      • 11 个 64 位寄存器 (R0-R10)                                        |    |
|   |      • 512 字节栈空间                                                    |    |
|   |      • 64 位固定长度指令                                                 |    |
|   |                                                                          |    |
|   |   5. 验证器的作用                                                        |    |
|   |      • 在程序运行前进行静态分析                                          |    |
|   |      • 保证内存安全、类型安全、终止性                                    |    |
|   |      • 拒绝不安全的程序                                                  |    |
|   |                                                                          |    |
|   +--------------------------------------------------------------------------+    |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## 思考题 | Discussion Questions

```
+-----------------------------------------------------------------------------------+
|                                思考题                                             |
|                          Discussion Questions                                     |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   1. 为什么 BPF 程序需要保证"一定会终止"？                                        |
|      如果不终止会怎样？                                                           |
|                                                                                   |
|      提示: 考虑 BPF 程序运行的上下文 (中断、系统调用路径...)                      |
|                                                                                   |
|   -------------------------------------------------------------------------       |
|                                                                                   |
|   2. 为什么 BPF 只有 11 个寄存器？更多寄存器会有什么问题？                        |
|                                                                                   |
|      提示: 考虑跨平台 JIT 编译的复杂性                                            |
|                                                                                   |
|   -------------------------------------------------------------------------       |
|                                                                                   |
|   3. 512 字节的栈够用吗？如果不够怎么办？                                         |
|                                                                                   |
|      提示: 考虑 BPF Map 的作用                                                    |
|                                                                                   |
|   -------------------------------------------------------------------------       |
|                                                                                   |
|   4. 如果验证器有 bug，让一个恶意程序通过了验证，会发生什么？                     |
|                                                                                   |
|      提示: 这就是为什么验证器代码需要极其谨慎地编写和审查                         |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## 延伸阅读 | Further Reading

- [eBPF 官方网站](https://ebpf.io/) - 最权威的入门资源
- [BPF and XDP Reference Guide (Cilium)](https://docs.cilium.io/en/stable/bpf/) - 深入的技术文档
- [BPF Performance Tools (Brendan Gregg)](http://www.brendangregg.com/bpf-performance-tools-book.html) - 性能分析圣经
- [Linux 内核 BPF 文档](https://www.kernel.org/doc/html/latest/bpf/index.html) - 官方内核文档

---

[返回目录](00-introduction.md) | [下一章：BPF 指令集入门 ➡️](02-bpf-instructions.md)
