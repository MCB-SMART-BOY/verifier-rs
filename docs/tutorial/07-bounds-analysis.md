# Á¨¨‰∏ÉÁ´†ÔºöËæπÁïåÂàÜÊûê | Chapter 7: Bounds Analysis

```
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   "ËæπÁïåÂàÜÊûêÊòØÈ™åËØÅÂô®ÁöÑÁúºÁùõ‚Äî‚ÄîÂÆÉËÆ©È™åËØÅÂô®ÁúãËßÅÊØè‰∏™ÂÄºÂèØËÉΩÁöÑËåÉÂõ¥"                   |
|   "Bounds analysis is the verifier's eyes‚Äîit lets the verifier see           |
|    the possible range of every value"                                         |
|                                                                                   |
|   Ê≤°ÊúâËæπÁïåÂàÜÊûêÔºåÈ™åËØÅÂô®Â∞±ÂÉèÂú®ÈªëÊöó‰∏≠Êë∏Á¥¢                                        |
|   Without bounds analysis, the verifier would be groping in the dark          |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

## üéØ Êú¨Á´†ÁõÆÊ†á | Chapter Goals

Â≠¶ÂÆåËøôÁ´†Ôºå‰Ω†‰ºöÁêÜËß£Ôºö
- ‰∏∫‰ªÄ‰πàËæπÁïåÂàÜÊûêËá≥ÂÖ≥ÈáçË¶Å (Why bounds analysis is crucial)
- ‰∏âÁßçËæπÁïåÁ±ªÂûãÂèäÂÖ∂ÂÖ≥Á≥ª (Three bound types and their relationships)
- Tnum Â¶Ç‰ΩïÂÆûÁé∞‰ΩçÁ∫ßÂà´Á≤æÂ∫¶ (How Tnum achieves bit-level precision)
- ËæπÁïåÂ¶Ç‰ΩïÈöèËøêÁÆóÊõ¥Êñ∞ (How bounds update with operations)
- Êù°‰ª∂Ë∑≥ËΩ¨Â¶Ç‰ΩïÁªÜÂåñËæπÁïå (How conditional jumps refine bounds)

---

## üìä ‰∏∫‰ªÄ‰πàÈúÄË¶ÅËæπÁïåÂàÜÊûê | Why Bounds Analysis

```
+-----------------------------------------------------------------------------------+
|                          ËæπÁïåÂàÜÊûêÁöÑÂøÖË¶ÅÊÄß                                      |
|                   The Necessity of Bounds Analysis                            |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   ÈóÆÈ¢òÂú∫ÊôØ | Problem Scenario:                                                |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   BPF Á®ãÂ∫èË¶ÅËÆøÈóÆ‰∏Ä‰∏™ 256 Â≠óËäÇÁöÑÁºìÂÜ≤Âå∫:                                  | |
|   |   A BPF program wants to access a 256-byte buffer:                      | |
|   |                                                                         | |
|   |   r2 = *(u32*)(r1 + 0)    // ‰ªéÊï∞ÊçÆÂåÖËØªÂèñÂÅèÁßªÈáè                         | |
|   |   r3 = r1 + r2            // ËÆ°ÁÆóÁõÆÊ†áÂú∞ÂùÄ                               | |
|   |   r4 = *(u8*)(r3 + 0)     // ËØªÂèñÁõÆÊ†á‰ΩçÁΩÆ                               | |
|   |                                                                         | |
|   |   ÈóÆÈ¢ò: r2 ÂèØËÉΩÊòØ‰ªªÊÑè 32 ‰ΩçÂÄºÔºÅ                                         | |
|   |   Problem: r2 could be any 32-bit value!                                | |
|   |                                                                         | |
|   |   Â¶ÇÊûú r2 = 0x10000ÔºåËÆøÈóÆÂ∞±‰ºöË∂äÁïå                                       | |
|   |   If r2 = 0x10000, the access would be out of bounds                    | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   Ëß£ÂÜ≥ÊñπÊ°à | Solution:                                                        |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ËæπÁïåËøΩË∏™ + Ê£ÄÊü•:                                                      | |
|   |   Bounds tracking + checking:                                           | |
|   |                                                                         | |
|   |   r2 = *(u32*)(r1 + 0)    // r2 ‚àà [0, 2^32-1]                          | |
|   |   if r2 > 255 goto error  // <- ËøôÈáåËåÉÂõ¥Êî∂Á™Ñ!                           | |
|   |   //                      // r2 ‚àà [0, 255] ‚úì                           | |
|   |   r3 = r1 + r2            // Áé∞Âú®ÂÅèÁßªÊúâÁïå!                              | |
|   |   r4 = *(u8*)(r3 + 0)     // ÂêàÊ≥ïËÆøÈóÆ ‚úì                                 | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   ÂõæÁ§∫ | Diagram:                                                             |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ÂàùÂßãËåÉÂõ¥:                                                             | |
|   |   [0---------------------------------------------------------2^32-1]   | |
|   |                                                                         | |
|   |   Ê£ÄÊü•Âêé (r2 <= 255):                                                   | |
|   |   [0---255]                                                             | |
|   |      ‚Üë                                                                  | |
|   |      +-- ËåÉÂõ¥Â§ßÂπÖÊî∂Á™ÑÔºåÁé∞Âú®ÂèØ‰ª•ÂÆâÂÖ®ËÆøÈóÆ 256 Â≠óËäÇÁºìÂÜ≤Âå∫                  | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## üìê ËæπÁïåË°®Á§∫Ê≥ï | Bounds Representation

### ‰∏âÁßçËæπÁïåÁ±ªÂûã | Three Bound Types

```
+-----------------------------------------------------------------------------------+
|                          ‰∏âÁßçËæπÁïåÁ±ªÂûã                                          |
|                       Three Bound Types                                       |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   1. Êó†Á¨¶Âè∑ËæπÁïå (Unsigned Bounds)                                       | |
|   |   -----------------------------------------------------------------    | |
|   |   ‚Ä¢ umin_value: Êó†Á¨¶Âè∑ÊúÄÂ∞èÂÄº (ÈªòËÆ§: 0)                                  | |
|   |   ‚Ä¢ umax_value: Êó†Á¨¶Âè∑ÊúÄÂ§ßÂÄº (ÈªòËÆ§: 2^64-1)                             | |
|   |                                                                         | |
|   |   Ë°®Á§∫: [umin, umax]                                                    | |
|   |                                                                         | |
|   |   Êï∞ËΩ¥:                                                                 | |
|   |   0 --------------------------------------------------------- 2^64-1    | |
|   |   |             [umin-------------------umax]                |          | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   2. ÊúâÁ¨¶Âè∑ËæπÁïå (Signed Bounds)                                         | |
|   |   -----------------------------------------------------------------    | |
|   |   ‚Ä¢ smin_value: ÊúâÁ¨¶Âè∑ÊúÄÂ∞èÂÄº (ÈªòËÆ§: -2^63)                              | |
|   |   ‚Ä¢ smax_value: ÊúâÁ¨¶Âè∑ÊúÄÂ§ßÂÄº (ÈªòËÆ§: 2^63-1)                             | |
|   |                                                                         | |
|   |   Ë°®Á§∫: [smin, smax]                                                    | |
|   |                                                                         | |
|   |   Êï∞ËΩ¥:                                                                 | |
|   |   -2^63 ----------------- 0 ------------------------------- 2^63-1      | |
|   |         |    [smin--------------------smax]     |                       | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   3. ‰ΩçÁ∫ßËøΩË∏™ (Bit-level Tracking via Tnum)                             | |
|   |   -----------------------------------------------------------------    | |
|   |   ‚Ä¢ value: Â∑≤Áü•‰ΩçÁöÑÂÄº                                                   | |
|   |   ‚Ä¢ mask: Êú™Áü•‰ΩçÁöÑÊé©Á†Å (1=Êú™Áü•, 0=Â∑≤Áü•)                                 | |
|   |                                                                         | |
|   |   Ë°®Á§∫: ÊØè‰∏Ä‰ΩçÂçïÁã¨ËøΩË∏™                                                  | |
|   |                                                                         | |
|   |   ‰ΩçÂõæ (8‰ΩçÁ§∫‰æã):                                                       | |
|   |   +---+---+---+---+---+---+---+---+                                    | |
|   |   | 1 | 0 | ? | ? | 1 | ? | 0 | 1 |                                    | |
|   |   +---+---+---+---+---+---+---+---+                                    | |
|   |     ‚Üë   ‚Üë   ‚Üë   ‚Üë   ‚Üë   ‚Üë   ‚Üë   ‚Üë                                      | |
|   |    Â∑≤Áü• Â∑≤Áü• Êú™Áü• Êú™Áü• Â∑≤Áü• Êú™Áü• Â∑≤Áü• Â∑≤Áü•                                | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### ËæπÁïåÁªìÊûÑÂÆö‰πâ | Bounds Structure Definition

```rust
// Êñá‰ª∂‰ΩçÁΩÆ: crates/bpf-verifier-core/src/bounds/scalar.rs

/// Ê†áÈáèÂÄºÁöÑÂÆåÊï¥ËæπÁïå‰ø°ÊÅØ
/// Complete bounds information for a scalar value
pub struct ScalarBounds {
    // -----------------------------------------------------------
    // Êó†Á¨¶Âè∑ËæπÁïå | Unsigned Bounds
    // -----------------------------------------------------------
    
    /// Êó†Á¨¶Âè∑ÊúÄÂ∞èÂÄº | Unsigned minimum
    pub umin_value: u64,  // ÈªòËÆ§: 0
    
    /// Êó†Á¨¶Âè∑ÊúÄÂ§ßÂÄº | Unsigned maximum
    pub umax_value: u64,  // ÈªòËÆ§: u64::MAX
    
    // -----------------------------------------------------------
    // ÊúâÁ¨¶Âè∑ËæπÁïå | Signed Bounds
    // -----------------------------------------------------------
    
    /// ÊúâÁ¨¶Âè∑ÊúÄÂ∞èÂÄº | Signed minimum
    pub smin_value: i64,  // ÈªòËÆ§: i64::MIN
    
    /// ÊúâÁ¨¶Âè∑ÊúÄÂ§ßÂÄº | Signed maximum
    pub smax_value: i64,  // ÈªòËÆ§: i64::MAX
    
    // -----------------------------------------------------------
    // 32‰ΩçËæπÁïå | 32-bit Bounds
    // -----------------------------------------------------------
    
    /// 32‰ΩçÊó†Á¨¶Âè∑ËæπÁïå | 32-bit unsigned bounds
    pub u32_min_value: u32,
    pub u32_max_value: u32,
    
    /// 32‰ΩçÊúâÁ¨¶Âè∑ËæπÁïå | 32-bit signed bounds
    pub s32_min_value: i32,
    pub s32_max_value: i32,
    
    // -----------------------------------------------------------
    // ‰ΩçÁ∫ßËøΩË∏™ | Bit-level Tracking
    // -----------------------------------------------------------
    
    /// Tnum: ËøΩË∏™ÊØè‰∏Ä‰ΩçÁöÑÁ°ÆÂÆöÊÄß
    /// Tnum: Tracks certainty of each bit
    pub var_off: Tnum,
}
```

### ‰∏âÁßçËæπÁïåÁöÑÂÖ≥Á≥ª | Relationship Between Three Bounds

```
+-----------------------------------------------------------------------------------+
|                         ‰∏âÁßçËæπÁïåÂ¶Ç‰Ωï‰∫íË°•                                       |
|                   How Three Bounds Complement Each Other                      |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   Á§∫‰æãÂÄº: 0x0000_00FF (ÂçÅËøõÂà∂ 255)                                            |
|   Example value: 0x0000_00FF (decimal 255)                                    |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   Êó†Á¨¶Âè∑ËßÜËßí | Unsigned View:                                           | |
|   |   -----------------------------------------------------------------    | |
|   |   0 ------------------- 255 --------------------------- 2^64-1          | |
|   |                          ^                                              | |
|   |                 umin = umax = 255                                       | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ÊúâÁ¨¶Âè∑ËßÜËßí | Signed View:                                             | |
|   |   -----------------------------------------------------------------    | |
|   |   -2^63 --------------- 0 ---- 255 --------------------- 2^63-1         | |
|   |                               ^                                         | |
|   |                      smin = smax = 255                                  | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ‰ΩçÁ∫ßËßÜËßí | Bit-level View:                                            | |
|   |   -----------------------------------------------------------------    | |
|   |   Tnum { value: 0xFF, mask: 0x00 }                                      | |
|   |                                                                         | |
|   |   64‰Ωç‰∫åËøõÂà∂:                                                           | |
|   |   0000_0000_0000_0000_0000_0000_0000_0000_                              | |
|   |   0000_0000_0000_0000_0000_0000_1111_1111                               | |
|   |                                                                         | |
|   |   ÊâÄÊúâ‰ΩçÈÉΩÂ∑≤Áü• (mask = 0)                                               | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   ‰∏∫‰ªÄ‰πàÈúÄË¶Å‰∏âÁßçËæπÁïåÔºü                                                        |
|   Why do we need three bounds?                                                |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   Âú∫ÊôØ 1: ÊúâÁ¨¶Âè∑ÊØîËæÉ jsgt r1, 0 (r1 > 0 ÊúâÁ¨¶Âè∑)                         | |
|   |   -> ÈúÄË¶ÅÊúâÁ¨¶Âè∑ËæπÁïåÊù•Âà§Êñ≠Êù°‰ª∂                                            | |
|   |                                                                         | |
|   |   Âú∫ÊôØ 2: Êó†Á¨¶Âè∑ÊØîËæÉ jgt r1, 100 (r1 > 100 Êó†Á¨¶Âè∑)                       | |
|   |   -> ÈúÄË¶ÅÊó†Á¨¶Âè∑ËæπÁïåÊù•Âà§Êñ≠Êù°‰ª∂                                            | |
|   |                                                                         | |
|   |   Âú∫ÊôØ 3: ‰ΩçËøêÁÆó r1 &= 0x0F                                             | |
|   |   -> ÈúÄË¶Å Tnum Êù•Á≤æÁ°ÆËøΩË∏™‰ΩçÁ∫ßÂà´ÂèòÂåñ                                      | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## üî¢ TnumÔºö‰ΩçÁ∫ßËøΩË∏™ | Tnum: Bit-level Tracking

### Tnum ÁªìÊûÑËØ¶Ëß£ | Tnum Structure Explained

```
+-----------------------------------------------------------------------------------+
|                            Tnum ËØ¶Ëß£                                           |
|                         Tnum Explained                                        |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   ÁªìÊûÑÂÆö‰πâ | Structure Definition:                                            |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   pub struct Tnum {                                                     | |
|   |       pub value: u64,  // Â∑≤Áü•‰ΩçÁöÑÂÄº                                    | |
|   |       pub mask: u64,   // Êú™Áü•‰ΩçÊé©Á†Å (1=Êú™Áü•, 0=Â∑≤Áü•)                    | |
|   |   }                                                                     | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   Â∑•‰ΩúÂéüÁêÜ | How It Works:                                                    |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ÂØπ‰∫éÊØè‰∏Ä‰Ωç i:                                                         | |
|   |   For each bit i:                                                       | |
|   |                                                                         | |
|   |   +----------------+----------------+--------------------------------+  | |
|   |   | mask Á¨¨ i ‰Ωç   | value Á¨¨ i ‰Ωç  | Âê´‰πâ                           |  | |
|   |   +----------------+----------------+--------------------------------+  | |
|   |   |      0         |      0         | ËØ•‰ΩçÂ∑≤Áü•‰∏∫ 0                   |  | |
|   |   |      0         |      1         | ËØ•‰ΩçÂ∑≤Áü•‰∏∫ 1                   |  | |
|   |   |      1         |      0         | ËØ•‰ΩçÊú™Áü• (ÂèØËÉΩÊòØ 0 Êàñ 1)       |  | |
|   |   |      1         |      1         | Êó†ÊïàÁä∂ÊÄÅ (‰∏çÂ∫îÂá∫Áé∞)            |  | |
|   |   +----------------+----------------+--------------------------------+  | |
|   |                                                                         | |
|   |   ‰∏çÂèòÈáè: (value & mask) == 0                                           | |
|   |   Invariant: (value & mask) == 0                                        | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   Á§∫‰æã | Examples:                                                            |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ‰æã 1: Á≤æÁ°ÆÂÄº 42                                                       | |
|   |   Example 1: Exact value 42                                             | |
|   |                                                                         | |
|   |   42 = 0b00101010                                                       | |
|   |                                                                         | |
|   |        ‰Ωç:  7   6   5   4   3   2   1   0                               | |
|   |   value:    0   0   1   0   1   0   1   0  = 0x2A                       | |
|   |   mask:     0   0   0   0   0   0   0   0  = 0x00                       | |
|   |                                                                         | |
|   |   Ë°®Á§∫: ÊâÄÊúâ‰ΩçÈÉΩÂ∑≤Áü•ÔºåÂÄºÂ∞±ÊòØ 42                                         | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ‰æã 2: ‰Ωé 3 ‰ΩçÊú™Áü•                                                     | |
|   |   Example 2: Low 3 bits unknown                                         | |
|   |                                                                         | |
|   |        ‰Ωç:  7   6   5   4   3   2   1   0                               | |
|   |   value:    0   0   1   0   1   0   0   0  = 0x28                       | |
|   |   mask:     0   0   0   0   0   1   1   1  = 0x07                       | |
|   |                                                                         | |
|   |   Ë°®Á§∫: 0b00101???                                                      | |
|   |   ÂèØËÉΩÂÄº: 40, 41, 42, 43, 44, 45, 46, 47                                | |
|   |   ËåÉÂõ¥: [40, 47]                                                        | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ‰æã 3: 8 Â≠óËäÇÂØπÈΩêÂú∞ÂùÄ                                                  | |
|   |   Example 3: 8-byte aligned address                                     | |
|   |                                                                         | |
|   |   8 Â≠óËäÇÂØπÈΩêÊÑèÂë≥ÁùÄ‰Ωé 3 ‰ΩçÂøÖÈ°ª‰∏∫ 0                                       | |
|   |                                                                         | |
|   |        ‰Ωç:  7   6   5   4   3   2   1   0   ...                         | |
|   |   value:    ?   ?   ?   ?   ?   0   0   0   ...                         | |
|   |   mask:     1   1   1   1   1   0   0   0   ...                         | |
|   |                                                                         | |
|   |   È´ò‰ΩçÊú™Áü•Ôºå‰ΩÜ‰Ωé 3 ‰ΩçÁ°ÆÂÆö‰∏∫ 0                                           | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ‰æã 4: ÂÆåÂÖ®Êú™Áü•                                                        | |
|   |   Example 4: Completely unknown                                         | |
|   |                                                                         | |
|   |   value = 0x0000_0000_0000_0000                                         | |
|   |   mask  = 0xFFFF_FFFF_FFFF_FFFF                                         | |
|   |                                                                         | |
|   |   Ë°®Á§∫: ÊâÄÊúâ‰ΩçÈÉΩÊú™Áü•ÔºåÂèØ‰ª•ÊòØ‰ªªÊÑè 64 ‰ΩçÂÄº                                | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### Tnum ËøêÁÆó | Tnum Operations

```
+-----------------------------------------------------------------------------------+
|                           Tnum ËøêÁÆóËØ¶Ëß£                                        |
|                      Tnum Operations Explained                                |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                        Êåâ‰Ωç‰∏é (AND)                                      | |
|   |                      Bitwise AND                                        | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ËßÑÂàô:                                                                 | |
|   |   ‚Ä¢ 0 AND ? = 0 (Â∑≤Áü•!)                                                 | |
|   |   ‚Ä¢ 1 AND ? = ?                                                         | |
|   |   ‚Ä¢ ? AND ? = ?                                                         | |
|   |                                                                         | |
|   |   Á§∫‰æã:                                                                 | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |   A: { value: 0b1010, mask: 0b0101 }  Ë°®Á§∫: 1?1?                |   | |
|   |   |   B: { value: 0b1100, mask: 0b0011 }  Ë°®Á§∫: 11??                |   | |
|   |   |                                                                 |   | |
|   |   |   A AND B:                                                      |   | |
|   |   |      1 ? 1 ?    A                                               |   | |
|   |   |   &  1 1 ? ?    B                                               |   | |
|   |   |   ----------                                                    |   | |
|   |   |      1 ? ? ?    ÁªìÊûú                                            |   | |
|   |   |                                                                 |   | |
|   |   |   ÁªìÊûú: { value: 0b1000, mask: 0b0111 }                         |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                        Êåâ‰ΩçÊàñ (OR)                                       | |
|   |                       Bitwise OR                                        | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ËßÑÂàô:                                                                 | |
|   |   ‚Ä¢ 1 OR ? = 1 (Â∑≤Áü•!)                                                  | |
|   |   ‚Ä¢ 0 OR ? = ?                                                          | |
|   |   ‚Ä¢ ? OR ? = ?                                                          | |
|   |                                                                         | |
|   |   Á§∫‰æã:                                                                 | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |   A: { value: 0b1010, mask: 0b0101 }  Ë°®Á§∫: 1?1?                |   | |
|   |   |   B: { value: 0b1100, mask: 0b0011 }  Ë°®Á§∫: 11??                |   | |
|   |   |                                                                 |   | |
|   |   |   A OR B:                                                       |   | |
|   |   |      1 ? 1 ?    A                                               |   | |
|   |   |   |  1 1 ? ?    B                                               |   | |
|   |   |   ----------                                                    |   | |
|   |   |      1 1 ? ?    ÁªìÊûú                                            |   | |
|   |   |                                                                 |   | |
|   |   |   ÁªìÊûú: { value: 0b1100, mask: 0b0011 }                         |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                          Âä†Ê≥ï (ADD)                                      | |
|   |                         Addition                                        | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   Âä†Ê≥ïÁöÑÂ§çÊùÇÊÄß: Ëøõ‰Ωç‰ºö‰º†Êí≠‰∏çÁ°ÆÂÆöÊÄß                                      | |
|   |   Complexity of addition: Carries propagate uncertainty                 | |
|   |                                                                         | |
|   |   Á§∫‰æã:                                                                 | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |   A: { value: 0b0010, mask: 0b0001 }  Ë°®Á§∫: 001?  (2 Êàñ 3)      |   | |
|   |   |   B: { value: 0b0001, mask: 0b0000 }  Ë°®Á§∫: 0001  (Á≤æÁ°ÆÂÄº 1)    |   | |
|   |   |                                                                 |   | |
|   |   |   A + B:                                                        |   | |
|   |   |   Â¶ÇÊûú A=2: 2+1=3 (0011)                                        |   | |
|   |   |   Â¶ÇÊûú A=3: 3+1=4 (0100) <- Ê≥®ÊÑè: Ëøõ‰ΩçÂΩ±Âìç‰∫ÜÊõ¥È´ò‰Ωç!              |   | |
|   |   |                                                                 |   | |
|   |   |   ÁªìÊûúÂèØËÉΩÊòØ 3 Êàñ 4                                             |   | |
|   |   |   0011 Êàñ 0100                                                  |   | |
|   |   |                                                                 |   | |
|   |   |   Tnum ÁªìÊûú: { value: 0b0000, mask: 0b0111 }                    |   | |
|   |   |   Ë°®Á§∫: 0???  (ËåÉÂõ¥ [0, 7]Ôºå‰ΩÜÂÆûÈôÖÂè™ËÉΩÊòØ 3 Êàñ 4)                |   | |
|   |   |                                                                 |   | |
|   |   |   Ê≥®ÊÑè: Tnum Âä†Ê≥ïÊòØ‰øùÂÆàÁöÑÔºåÂèØËÉΩ‰∏¢Â§±Á≤æÂ∫¶                         |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### Tnum ‰ª£Á†ÅÂÆûÁé∞ | Tnum Code Implementation

```rust
// Êñá‰ª∂‰ΩçÁΩÆ: crates/bpf-verifier-core/src/bounds/tnum.rs

impl Tnum {
    /// ÂàõÂª∫Â∏∏Èáè Tnum
    /// Create constant Tnum
    pub const fn const_value(value: u64) -> Self {
        Tnum { value, mask: 0 }
    }
    
    /// ÂàõÂª∫ÂÆåÂÖ®Êú™Áü•ÁöÑ Tnum
    /// Create completely unknown Tnum
    pub const fn unknown() -> Self {
        Tnum { value: 0, mask: u64::MAX }
    }
    
    /// Êåâ‰Ωç‰∏éËøêÁÆó
    /// Bitwise AND operation
    pub fn and(self, other: Tnum) -> Tnum {
        // 0 AND ? = 0 (Â∑≤Áü•)
        // 1 AND 1 = 1 (Â∑≤Áü•)
        // 1 AND ? = ?
        // ? AND ? = ?
        
        let alpha = self.value | self.mask;   // ÂèØËÉΩ‰∏∫ 1 ÁöÑ‰Ωç
        let beta = other.value | other.mask;  // ÂèØËÉΩ‰∏∫ 1 ÁöÑ‰Ωç
        let v = self.value & other.value;     // Á°ÆÂÆö‰∏∫ 1 ÁöÑ‰Ωç
        
        Tnum {
            value: v,
            mask: alpha & beta & !v,  // ÂèØËÉΩ‰∏∫ 1 ‰ΩÜ‰∏çÁ°ÆÂÆöÁöÑ‰Ωç
        }
    }
    
    /// Êåâ‰ΩçÊàñËøêÁÆó
    /// Bitwise OR operation
    pub fn or(self, other: Tnum) -> Tnum {
        // 1 OR ? = 1 (Â∑≤Áü•)
        // 0 OR 0 = 0 (Â∑≤Áü•)
        // 0 OR ? = ?
        
        let v = self.value | other.value;     // Á°ÆÂÆö‰∏∫ 1 ÁöÑ‰Ωç
        let m = self.mask | other.mask;       // ‰ªª‰∏Ä‰æßÊú™Áü•ÁöÑ‰Ωç
        
        Tnum {
            value: v,
            mask: m & !v,  // Êú™Áü•‰∏î‰∏çÁ°ÆÂÆö‰∏∫ 1 ÁöÑ‰Ωç
        }
    }
    
    /// Âä†Ê≥ïËøêÁÆó
    /// Addition operation
    pub fn add(self, other: Tnum) -> Tnum {
        let sm = self.mask.wrapping_add(other.mask);
        let sv = self.value.wrapping_add(other.value);
        let sigma = sm.wrapping_add(sv);
        let chi = sigma ^ sv;
        let mu = chi | self.mask | other.mask;
        
        Tnum {
            value: sv & !mu,
            mask: mu,
        }
    }
    
    /// Ëé∑ÂèñÂèØËÉΩÁöÑÊúÄÂ∞èÂÄº
    /// Get possible minimum value
    pub fn min(&self) -> u64 {
        self.value  // ÊâÄÊúâÊú™Áü•‰ΩçÂèñ 0
    }
    
    /// Ëé∑ÂèñÂèØËÉΩÁöÑÊúÄÂ§ßÂÄº
    /// Get possible maximum value
    pub fn max(&self) -> u64 {
        self.value | self.mask  // ÊâÄÊúâÊú™Áü•‰ΩçÂèñ 1
    }
    
    /// Ê£ÄÊü•ÊòØÂê¶‰∏∫Â∏∏Èáè
    /// Check if constant
    pub fn is_const(&self) -> bool {
        self.mask == 0
    }
}
```

---

## üîÑ ËæπÁïåÁªÜÂåñ | Bounds Refinement

### Êù°‰ª∂Ë∑≥ËΩ¨ÁªÜÂåñ | Conditional Jump Refinement

```
+-----------------------------------------------------------------------------------+
|                          Êù°‰ª∂Ë∑≥ËΩ¨ËæπÁïåÁªÜÂåñ                                      |
|                  Conditional Jump Bounds Refinement                           |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   Êù°‰ª∂Ë∑≥ËΩ¨‰∫ßÁîü‰∏§‰∏™ÂàÜÊîØÔºåÊØè‰∏™ÂàÜÊîØÊúâ‰∏çÂêåÁöÑËæπÁïå:                                 |
|   Conditional jumps produce two branches with different bounds:               |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ÂéüÂßãÁä∂ÊÄÅ: r1 ‚àà [0, 1000]                                              | |
|   |   Initial: r1 ‚àà [0, 1000]                                               | |
|   |                                                                         | |
|   |                     +---------------+                                   | |
|   |                     | if r1 > 100   |                                   | |
|   |                     |   goto target |                                   | |
|   |                     +-------+-------+                                   | |
|   |                             |                                           | |
|   |              +--------------+--------------+                            | |
|   |              |                             |                            | |
|   |              v                             v                            | |
|   |   +---------------------+     +---------------------+                   | |
|   |   |  True ÂàÜÊîØ (jump)   |     | False ÂàÜÊîØ (fall)   |                   | |
|   |   |                     |     |                     |                   | |
|   |   |  Êù°‰ª∂: r1 > 100     |     |  Êù°‰ª∂: r1 <= 100    |                   | |
|   |   |  ÁªÜÂåñ: r1 >= 101    |     |  ÁªÜÂåñ: r1 <= 100    |                   | |
|   |   |                     |     |                     |                   | |
|   |   |  r1 ‚àà [101, 1000]   |     |  r1 ‚àà [0, 100]      |                   | |
|   |   +---------------------+     +---------------------+                   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   ÊâÄÊúâÊØîËæÉÊìç‰ΩúÁöÑÁªÜÂåñËßÑÂàô:                                                     |
|   Refinement rules for all comparison operations:                             |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   Êù°‰ª∂       | True ÂàÜÊîØÁªÜÂåñ          | False ÂàÜÊîØÁªÜÂåñ                  | |
|   |   ------------------------------------------------------------------   | |
|   |   JGT >      | dst_min = max(min,v+1) | dst_max = min(max, v)          | |
|   |   JGE >=     | dst_min = max(min, v)  | dst_max = min(max, v-1)        | |
|   |   JLT <      | dst_max = min(max,v-1) | dst_min = max(min, v)          | |
|   |   JLE <=     | dst_max = min(max, v)  | dst_min = max(min, v+1)        | |
|   |   JEQ ==     | dst = v (Á≤æÁ°ÆÂÄº)       | (‰∏çÂèò)                          | |
|   |   JNE !=     | (‰∏çÂèò)                 | dst = v (Á≤æÁ°ÆÂÄº)                | |
|   |                                                                         | |
|   |   v = ÊØîËæÉÁöÑÂÄº                                                          | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### ËæπÁïåÁªÜÂåñ‰ª£Á†Å | Bounds Refinement Code

```rust
// Êñá‰ª∂‰ΩçÁΩÆ: crates/bpf-verifier-core/src/bounds/range_refine.rs

/// Â§ÑÁêÜÊù°‰ª∂Ë∑≥ËΩ¨ÁöÑËæπÁïåÁªÜÂåñ
/// Handle bounds refinement for conditional jumps
pub fn reg_set_min_max(
    true_state: &mut BpfVerifierState,   // ÁúüÂàÜÊîØÁä∂ÊÄÅ
    false_state: &mut BpfVerifierState,  // ÂÅáÂàÜÊîØÁä∂ÊÄÅ
    dst_regno: usize,
    src_val: u64,
    opcode: u8,
) -> Result<()> {
    let true_reg = &mut true_state.cur_func_mut()?.regs[dst_regno];
    let false_reg = &mut false_state.cur_func_mut()?.regs[dst_regno];
    
    match opcode & 0xf0 {
        BPF_JGT => {
            // Êó†Á¨¶Âè∑Â§ß‰∫é: dst > src
            
            // True ÂàÜÊîØ: dst > src, Âç≥ dst >= src + 1
            true_reg.umin_value = true_reg.umin_value
                .max(src_val.saturating_add(1));
            
            // False ÂàÜÊîØ: dst <= src
            false_reg.umax_value = false_reg.umax_value
                .min(src_val);
        }
        
        BPF_JGE => {
            // Êó†Á¨¶Âè∑Â§ß‰∫éÁ≠â‰∫é: dst >= src
            
            // True ÂàÜÊîØ: dst >= src
            true_reg.umin_value = true_reg.umin_value
                .max(src_val);
            
            // False ÂàÜÊîØ: dst < src, Âç≥ dst <= src - 1
            false_reg.umax_value = false_reg.umax_value
                .min(src_val.saturating_sub(1));
        }
        
        BPF_JEQ => {
            // Á≠â‰∫é: dst == src
            
            // True ÂàÜÊîØ: dst ÊòØÁ≤æÁ°ÆÂÄº
            true_reg.umin_value = src_val;
            true_reg.umax_value = src_val;
            true_reg.var_off = Tnum::const_value(src_val);
            
            // False ÂàÜÊîØ: dst != src (ËæπÁïåÈÄöÂ∏∏‰∏çÂèò)
            // ÁâπÊÆäÊÉÖÂÜµ: Â¶ÇÊûúÂéüËåÉÂõ¥Ê≠£Â•ΩÊòØ [src, src]ÔºåÂàô‰∏çÂèØËææ
        }
        
        BPF_JSGT => {
            // ÊúâÁ¨¶Âè∑Â§ß‰∫é: (i64)dst > (i64)src
            let src_signed = src_val as i64;
            
            // True ÂàÜÊîØ: smin >= src + 1
            true_reg.smin_value = true_reg.smin_value
                .max(src_signed.saturating_add(1));
            
            // False ÂàÜÊîØ: smax <= src
            false_reg.smax_value = false_reg.smax_value
                .min(src_signed);
        }
        
        _ => { /* ÂÖ∂‰ªñÊìç‰ΩúÁ†Å */ }
    }
    
    // ÂêåÊ≠•ÂêÑÁßçËæπÁïå
    reg_bounds_sync(true_reg);
    reg_bounds_sync(false_reg);
    
    // Ê£ÄÊü•ËæπÁïåÊòØÂê¶ÁüõÁõæÔºàË°®Á§∫ÂàÜÊîØ‰∏çÂèØËææÔºâ
    if true_reg.umin_value > true_reg.umax_value {
        true_state.mark_unreachable();
    }
    if false_reg.umin_value > false_reg.umax_value {
        false_state.mark_unreachable();
    }
    
    Ok(())
}
```

---

## üìà ËæπÁïå‰º†Êí≠ | Bounds Propagation

### ALU ËøêÁÆóËæπÁïåÊõ¥Êñ∞ | ALU Operation Bounds Update

```
+-----------------------------------------------------------------------------------+
|                          ALU ËøêÁÆóËæπÁïåÊõ¥Êñ∞                                      |
|                    ALU Operation Bounds Update                                |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                           Âä†Ê≥ï ADD                                       | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ËßÑÂàô:                                                                 | |
|   |   ‚Ä¢ Êó†Ê∫¢Âá∫: [a_min + b_min, a_max + b_max]                              | |
|   |   ‚Ä¢ ÊúâÊ∫¢Âá∫: [0, 2^64-1] (ÂÖ®ËåÉÂõ¥)                                        | |
|   |                                                                         | |
|   |   Á§∫‰æã:                                                                 | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |   r1 ‚àà [10, 100]                                                |   | |
|   |   |   r2 ‚àà [5, 20]                                                  |   | |
|   |   |   r1 + r2 -> r1 ‚àà [15, 120]                                      |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   |   Ê∫¢Âá∫Á§∫‰æã:                                                             | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |   r1 ‚àà [0xFFFFFFFF_FFFFFFF0, 0xFFFFFFFF_FFFFFFFF]               |   | |
|   |   |   r2 ‚àà [0x10, 0x20]                                             |   | |
|   |   |   r1 + r2 -> ÂèØËÉΩÊ∫¢Âá∫! -> r1 ‚àà [0, 2^64-1]                        |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                           Êåâ‰Ωç‰∏é AND                                     | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ËßÑÂàô:                                                                 | |
|   |   ‚Ä¢ max Âè™‰ºöÂèòÂ∞è: new_max = min(a_max, b_max)                           | |
|   |   ‚Ä¢ Tnum ÂèØ‰ª•Êèê‰æõÊõ¥Á≤æÁ°ÆÁöÑ‰ø°ÊÅØ                                           | |
|   |                                                                         | |
|   |   Á§∫‰æã:                                                                 | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |   r1 ‚àà [0, 2^32-1]  (‰ªéÂÜÖÂ≠òÂä†ËΩΩÁöÑÂÄº)                            |   | |
|   |   |   r1 & 0xFF                                                     |   | |
|   |   |   -> r1 ‚àà [0, 255]                                               |   | |
|   |   |                                                                 |   | |
|   |   |   Tnum ÂàÜÊûê:                                                    |   | |
|   |   |   Âéü: { value: 0, mask: 0xFFFFFFFF }                            |   | |
|   |   |   & { value: 0xFF, mask: 0 }                                    |   | |
|   |   |   ÁªìÊûú: { value: 0, mask: 0xFF }                                |   | |
|   |   |   È´ò 56 ‰ΩçÂ∑≤Áü•‰∏∫ 0!                                             |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                           Â∑¶Áßª LSH                                       | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ËßÑÂàô:                                                                 | |
|   |   ‚Ä¢ Â¶ÇÊûúÁßª‰ΩçÈáèÂ∑≤Áü•: min << shift, max << shift                          | |
|   |   ‚Ä¢ ÈúÄË¶ÅÊ£ÄÊü•ÊòØÂê¶‰ºöÊ∫¢Âá∫                                                  | |
|   |                                                                         | |
|   |   Á§∫‰æã:                                                                 | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |   r1 ‚àà [1, 4]                                                   |   | |
|   |   |   r1 << 3                                                       |   | |
|   |   |   -> r1 ‚àà [8, 32]                                                |   | |
|   |   |                                                                 |   | |
|   |   |   Tnum: ‰Ωé 3 ‰ΩçÁé∞Âú®Â∑≤Áü•‰∏∫ 0                                     |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                           Âè≥Áßª RSH                                       | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ËßÑÂàô:                                                                 | |
|   |   ‚Ä¢ ÈÄªËæëÂè≥Áßª: min >> shift, max >> shift                                | |
|   |   ‚Ä¢ È´ò‰ΩçÂ°´ÂÖÖ 0                                                          | |
|   |                                                                         | |
|   |   Á§∫‰æã:                                                                 | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |   r1 ‚àà [1000, 2000]                                             |   | |
|   |   |   r1 >> 3                                                       |   | |
|   |   |   -> r1 ‚àà [125, 250]                                             |   | |
|   |   |                                                                 |   | |
|   |   |   Tnum: È´ò 3 ‰ΩçÁé∞Âú®Â∑≤Áü•‰∏∫ 0                                     |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### ËæπÁïåÂêåÊ≠• | Bounds Synchronization

```rust
// Êñá‰ª∂‰ΩçÁΩÆ: crates/bpf-verifier-core/src/bounds/scalar.rs

/// ÂêåÊ≠•ÊâÄÊúâËæπÁïå‰ø°ÊÅØÔºåÁ°Æ‰øù‰∏ÄËá¥ÊÄß
/// Synchronize all bounds to ensure consistency
pub fn reg_bounds_sync(reg: &mut BpfRegState) {
    // -----------------------------------------------------------
    // Ê≠•È™§ 1: ‰ªé Tnum Êé®ÂØºËåÉÂõ¥ËæπÁïå
    // Step 1: Derive range bounds from Tnum
    // -----------------------------------------------------------
    
    // Tnum ÁöÑÊúÄÂ∞èÂÄº (ÊâÄÊúâÊú™Áü•‰ΩçÂèñ 0)
    let tnum_min = reg.var_off.min();
    // Tnum ÁöÑÊúÄÂ§ßÂÄº (ÊâÄÊúâÊú™Áü•‰ΩçÂèñ 1)
    let tnum_max = reg.var_off.max();
    
    // ÂèñÊõ¥Á¥ßÁöÑËæπÁïå
    reg.umin_value = reg.umin_value.max(tnum_min);
    reg.umax_value = reg.umax_value.min(tnum_max);
    
    // -----------------------------------------------------------
    // Ê≠•È™§ 2: ÊúâÁ¨¶Âè∑/Êó†Á¨¶Âè∑ËæπÁïåÁõ∏‰∫íÊé®ÂØº
    // Step 2: Cross-derive signed/unsigned bounds
    // -----------------------------------------------------------
    
    // Â¶ÇÊûúÊó†Á¨¶Âè∑ËåÉÂõ¥ÂÆåÂÖ®Âú®Ê≠£Êï∞Âå∫Èó¥
    if reg.umax_value <= i64::MAX as u64 {
        reg.smin_value = reg.smin_value.max(reg.umin_value as i64);
        reg.smax_value = reg.smax_value.min(reg.umax_value as i64);
    }
    
    // Â¶ÇÊûúÊúâÁ¨¶Âè∑ËåÉÂõ¥ÂÆåÂÖ®ÈùûË¥ü
    if reg.smin_value >= 0 {
        reg.umin_value = reg.umin_value.max(reg.smin_value as u64);
        reg.umax_value = reg.umax_value.min(reg.smax_value as u64);
    }
    
    // -----------------------------------------------------------
    // Ê≠•È™§ 3: ‰ªéËåÉÂõ¥Êé®ÂØº Tnum
    // Step 3: Derive Tnum from range
    // -----------------------------------------------------------
    
    if reg.umin_value == reg.umax_value {
        // Á≤æÁ°ÆÂ∏∏Èáè
        reg.var_off = Tnum::const_value(reg.umin_value);
    } else {
        // Ê†πÊçÆËåÉÂõ¥Êé®ÂØºÈ´ò‰Ωç
        // Â¶ÇÊûú umax < 2^nÔºåÂàôÈ´ò‰∫é n ÁöÑ‰ΩçÈÉΩÊòØ 0
        let leading_zeros = reg.umax_value.leading_zeros();
        if leading_zeros > 0 {
            let known_zero_bits = !((1u64 << (64 - leading_zeros)) - 1);
            reg.var_off.mask &= !known_zero_bits;
            reg.var_off.value &= !known_zero_bits;
        }
    }
    
    // -----------------------------------------------------------
    // Ê≠•È™§ 4: Ê£ÄÊü•ËæπÁïåÊúâÊïàÊÄß
    // Step 4: Check bounds validity
    // -----------------------------------------------------------
    
    // Â¶ÇÊûú min > maxÔºåË°®Á§∫‰∏çÂèØËÉΩÁöÑÁä∂ÊÄÅ
    // ËøôÈÄöÂ∏∏ÊÑèÂë≥ÁùÄÂΩìÂâçË∑ØÂæÑ‰∏çÂèØËææ
    if reg.umin_value > reg.umax_value {
        // Ê†áËÆ∞‰∏∫ÁüõÁõæÁä∂ÊÄÅ
    }
    if reg.smin_value > reg.smax_value {
        // Ê†áËÆ∞‰∏∫ÁüõÁõæÁä∂ÊÄÅ
    }
}
```

---

## üìã ÂÆåÊï¥Á§∫‰æãÔºöËæπÁïåÂàÜÊûêËøΩË∏™ | Complete Example: Bounds Analysis Trace

```
+-----------------------------------------------------------------------------------+
|                          ËæπÁïåÂàÜÊûêÂÆåÊï¥ËøΩË∏™                                      |
|                   Complete Bounds Analysis Trace                              |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   Á®ãÂ∫è | Program:                                                             |
|   +-------------------------------------------------------------------------+ |
|   |  0: r2 = *(u32*)(r1 + 0)    // ‰ªé ctx Âä†ËΩΩ 32 ‰ΩçÂÄº                      | |
|   |  1: r2 &= 0xFF              // Â±èËîΩÈ´ò‰Ωç                                  | |
|   |  2: if r2 > 100 goto 5      // ËæπÁïåÊ£ÄÊü•                                 | |
|   |  3: r3 = r1 + r2            // ËÆ°ÁÆóÂú∞ÂùÄ                                 | |
|   |  4: r0 = *(u8*)(r3 + 0)     // ËØªÂèñÊï∞ÊçÆ                                 | |
|   |  5: exit                                                                | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   Êåá‰ª§ 0: r2 = *(u32*)(r1 + 0)                                                |
|   +-------------------------------------------------------------------------+ |
|   |  Êìç‰Ωú: ‰ªé‰∏ä‰∏ãÊñáÂä†ËΩΩ 32 ‰ΩçÊó†Á¨¶Âè∑ÂÄº                                       | |
|   |                                                                         | |
|   |  r2 Áä∂ÊÄÅ:                                                               | |
|   |  +-- umin = 0                                                           | |
|   |  +-- umax = 0xFFFFFFFF (2^32-1)                                         | |
|   |  +-- smin = 0                                                           | |
|   |  +-- smax = 0xFFFFFFFF                                                  | |
|   |  +-- var_off = { value: 0, mask: 0xFFFFFFFF }                           | |
|   |                                                                         | |
|   |  ÂõæÁ§∫:                                                                  | |
|   |  [0-------------------------------------------------------0xFFFFFFFF]   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   Êåá‰ª§ 1: r2 &= 0xFF                                                          |
|   +-------------------------------------------------------------------------+ |
|   |  Êìç‰Ωú: Êåâ‰Ωç‰∏éÔºåÂè™‰øùÁïô‰Ωé 8 ‰Ωç                                            | |
|   |                                                                         | |
|   |  r2 Áä∂ÊÄÅÊõ¥Êñ∞:                                                           | |
|   |  +-- umin = 0                                                           | |
|   |  +-- umax = 0xFF (255)       <- Â§ßÂπÖÊî∂Á™Ñ!                                | |
|   |  +-- smin = 0                                                           | |
|   |  +-- smax = 255                                                         | |
|   |  +-- var_off = { value: 0, mask: 0xFF }  <- È´ò 56 ‰ΩçÂ∑≤Áü•‰∏∫ 0!            | |
|   |                                                                         | |
|   |  ÂõæÁ§∫:                                                                  | |
|   |  [0-------255]                                                          | |
|   |                                                                         | |
|   |  Tnum ‰ΩçÂõæ (8‰ΩçÁÆÄÂåñ):                                                   | |
|   |  +---+---+---+---+---+---+---+---+------------------------------------+ | |
|   |  | ? | ? | ? | ? | ? | ? | ? | ? | 0  0  0  0  ... (È´ò 56 ‰Ωç)         | | |
|   |  +---+---+---+---+---+---+---+---+------------------------------------+ | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   Êåá‰ª§ 2: if r2 > 100 goto 5                                                  |
|   +-------------------------------------------------------------------------+ |
|   |  Êìç‰Ωú: Êù°‰ª∂ÂàÜÊîØ                                                         | |
|   |                                                                         | |
|   |  ÂàÜÊîØÂâç r2 ‚àà [0, 255]                                                   | |
|   |                                                                         | |
|   |           +---------------+                                             | |
|   |           |  r2 > 100 ?   |                                             | |
|   |           +-------+-------+                                             | |
|   |                   |                                                     | |
|   |        +----------+----------+                                          | |
|   |        |                     |                                          | |
|   |   True (goto 5)         False (fall)                                    | |
|   |   r2 ‚àà [101, 255]       r2 ‚àà [0, 100]                                   | |
|   |        |                     |                                          | |
|   |        v                     v                                          | |
|   |   +---------+         +-------------+                                   | |
|   |   | Ë∑≥Âà∞ 5  |         | ÁªßÁª≠Êåá‰ª§ 3  |                                   | |
|   |   | (exit)  |         |             |                                   | |
|   |   +---------+         +-------------+                                   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   Êåá‰ª§ 3 (False ÂàÜÊîØ): r3 = r1 + r2                                           |
|   +-------------------------------------------------------------------------+ |
|   |  ÂâçÁΩÆÊù°‰ª∂:                                                              | |
|   |  +-- r1 = PTR_TO_CTX (ÂÅáËÆæ ctx Â§ßÂ∞è 256 Â≠óËäÇ)                           | |
|   |  +-- r2 ‚àà [0, 100]                                                      | |
|   |                                                                         | |
|   |  ËÆ°ÁÆó:                                                                  | |
|   |  +-- r3 = r1 + r2                                                       | |
|   |  +-- r3 Á±ªÂûã = PTR_TO_CTX                                               | |
|   |  +-- r3 ÂÅèÁßª ‚àà [0, 100]                                                 | |
|   |                                                                         | |
|   |  ÂÆâÂÖ®ÊÄßÈ™åËØÅ:                                                            | |
|   |  ÂÅèÁßªËåÉÂõ¥ [0, 100] ‚äÇ ctx Â§ßÂ∞è [0, 255] ‚úì                                | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   Êåá‰ª§ 4: r0 = *(u8*)(r3 + 0)                                                 |
|   +-------------------------------------------------------------------------+ |
|   |  ÂÜÖÂ≠òËÆøÈóÆÊ£ÄÊü•:                                                          | |
|   |                                                                         | |
|   |  +-- Âü∫ÂùÄ: r3 = PTR_TO_CTX                                              | |
|   |  +-- ÈùôÊÄÅÂÅèÁßª: 0                                                        | |
|   |  +-- ÂèòÈáèÂÅèÁßª: [0, 100]                                                 | |
|   |  +-- ËÆøÈóÆÂ§ßÂ∞è: 1 Â≠óËäÇ                                                   | |
|   |  +-- ÊÄªÂÅèÁßªËåÉÂõ¥: [0, 100]                                               | |
|   |                                                                         | |
|   |  Ê£ÄÊü•: [0, 100] + 1 ‚â§ 256 ?                                             | |
|   |        [0, 101] ‚äÇ [0, 256] ‚úì                                            | |
|   |                                                                         | |
|   |  ÁªìÊûú: ÂÆâÂÖ®! ÂÖÅËÆ∏ËÆøÈóÆ ‚úì                                                 | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ‚ö†Ô∏è Â∏∏ËßÅËæπÁïåÈóÆÈ¢ò | Common Bounds Issues

```
+-----------------------------------------------------------------------------------+
|                          Â∏∏ËßÅËæπÁïåÈóÆÈ¢ò                                          |
|                       Common Bounds Issues                                    |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                      ÈóÆÈ¢ò 1: Êï¥Êï∞Ê∫¢Âá∫                                    | |
|   |                   Issue 1: Integer Overflow                             | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ÈóÆÈ¢ò‰ª£Á†Å:                                                             | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |  r1 = 0xFFFFFFFF_FFFFFFFF                                       |   | |
|   |   |  r1 += 1                      // Ê∫¢Âá∫! r1 = 0                   |   | |
|   |   |  if r1 < 100 goto ok          // Êù°‰ª∂ÊàêÁ´ã!                      |   | |
|   |   |  // ÊîªÂáªËÄÖÊúüÊúõÁªïËøáËæπÁïåÊ£ÄÊü•                                      |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   |   È™åËØÅÂô®Â§ÑÁêÜ:                                                           | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |  Âä†Ê≥ïÂâç: r1 ‚àà [0xFFFF..., 0xFFFF...]                            |   | |
|   |   |  Âä†Ê≥ïÂêé: Ê£ÄÊµãÂà∞ÂèØËÉΩÊ∫¢Âá∫ -> r1 ‚àà [0, 2^64-1]                      |   | |
|   |   |  ËæπÁïåÊâ©Â±ï‰∏∫ÂÖ®ËåÉÂõ¥ÔºåÂêéÁª≠Ê£ÄÊü•‰ºöÊõ¥‰∏•Ê†º                             |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                     ÈóÆÈ¢ò 2: Á¨¶Âè∑Êâ©Â±ïÊ∑∑Ê∑Ü                                 | |
|   |                Issue 2: Sign Extension Confusion                        | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ÈóÆÈ¢ò‰ª£Á†Å:                                                             | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |  r1 = *(s8*)(r0 + 0)   // Âä†ËΩΩÊúâÁ¨¶Âè∑Â≠óËäÇ                        |   | |
|   |   |  // Â¶ÇÊûúÂÄºÊòØ -1 (0xFF), Á¨¶Âè∑Êâ©Â±ïÂêéÂèòÊàê 0xFFFFFFFF_FFFFFFFF      |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   |   È™åËØÅÂô®Â§ÑÁêÜ:                                                           | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |  ÊúâÁ¨¶Âè∑ËßÜËßí: smin = -128, smax = 127                            |   | |
|   |   |  Êó†Á¨¶Âè∑ËßÜËßí: ÂèØËÉΩÊòØ [0, 127] Êàñ [0xFFFF...80, 0xFFFF...FF]      |   | |
|   |   |                                                                 |   | |
|   |   |  ÂêåÊó∂ËøΩË∏™‰∏§ÁßçËßÜËßíÔºåÁ°Æ‰øùÊ≠£Á°ÆÂ§ÑÁêÜ                                 |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                    ÈóÆÈ¢ò 3: ËæπÁïåÊ£ÄÊü•È°∫Â∫è                                  | |
|   |                 Issue 3: Bounds Check Ordering                          | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ÈîôËØØ‰ª£Á†Å:                                                             | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |  r3 = r1 + r2             // ÂÖàËÆ°ÁÆóÂú∞ÂùÄ                         |   | |
|   |   |  if r2 > 100 goto error   // ÂêéÊ£ÄÊü•ËæπÁïå (Â§™Êôö‰∫Ü!)               |   | |
|   |   |  *(r3) = 0                // ÂèØËÉΩÂ∑≤ÁªèË∂äÁïå                       |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   |   Ê≠£Á°Æ‰ª£Á†Å:                                                             | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |  if r2 > 100 goto error   // ÂÖàÊ£ÄÊü•ËæπÁïå                         |   | |
|   |   |  r3 = r1 + r2             // ÂÜçËÆ°ÁÆóÂú∞ÂùÄ                         |   | |
|   |   |  *(r3) = 0                // Áé∞Âú®ÂÆâÂÖ®‰∫Ü                         |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## üéì Â∞èÁªì | Summary

Êú¨Á´†‰ªãÁªç‰∫Ü BPF È™åËØÅÂô®ÁöÑËæπÁïåÂàÜÊûêÁ≥ªÁªüÔºö

| Ê¶ÇÂøµ | ËØ¥Êòé | ‰ª£Á†Å‰ΩçÁΩÆ |
|------|------|---------|
| Êó†Á¨¶Âè∑ËæπÁïå | umin/umax | `bounds/scalar.rs` |
| ÊúâÁ¨¶Âè∑ËæπÁïå | smin/smax | `bounds/scalar.rs` |
| Tnum | ‰ΩçÁ∫ßÂà´ËøΩË∏™ | `bounds/tnum.rs` |
| ËæπÁïåÁªÜÂåñ | Êù°‰ª∂Ë∑≥ËΩ¨Êó∂Êî∂Á™ÑËæπÁïå | `bounds/range_refine.rs` |
| ËæπÁïå‰º†Êí≠ | ALU ËøêÁÆóÊõ¥Êñ∞ËæπÁïå | `bounds/insn_bounds.rs` |
| ËæπÁïåÂêåÊ≠• | ‰øùÊåÅ‰∏âÁßçËæπÁïå‰∏ÄËá¥ | `bounds/scalar.rs` |

---

## üìù ÁªÉ‰π† | Exercises

1. **Tnum ËÆ°ÁÆó**:
   - `Tnum{value:0x10, mask:0x0F}` Âä†‰∏ä `Tnum{value:0x01, mask:0x00}` ÁöÑÁªìÊûúÊòØ‰ªÄ‰πàÔºü
   
2. **ËæπÁïåÊé®ÂØº**:
   - Â∑≤Áü• `umin=100, umax=200`ÔºåÊâßË°å `r1 &= 0xFF` ÂêéËæπÁïåÂ¶Ç‰ΩïÂèòÂåñÔºü

3. **Êù°‰ª∂ÁªÜÂåñ**:
   - ÂØÑÂ≠òÂô® r1 ÁöÑËæπÁïå‰∏∫ `[0, 1000]`ÔºåÊâßË°å `if r1 < 500` ÂêéÔºåÁúüÂÅáÂàÜÊîØÂêÑÊòØ‰ªÄ‰πàËæπÁïåÔºü

---

## üîó ‰ª£Á†Å‰ΩçÁΩÆÁ¥¢Âºï | Code Location Index

| ÂäüËÉΩ | Êñá‰ª∂Ë∑ØÂæÑ |
|------|---------|
| Ê†áÈáèËæπÁïåÂÆö‰πâ | `bounds/scalar.rs` |
| Tnum ÂÆûÁé∞ | `bounds/tnum.rs` |
| ËæπÁïåÁªÜÂåñ | `bounds/range_refine.rs` |
| ALU ËæπÁïåÊõ¥Êñ∞ | `bounds/insn_bounds.rs` |
| ËæπÁïåÂêåÊ≠• | `bounds/scalar.rs` |

---

üëâ [‰∏ã‰∏ÄÁ´†ÔºöÁä∂ÊÄÅÂâ™Êûù | Next: State Pruning](08-state-pruning.md)
