# ç¬¬ä¹ç« ï¼šå¹³å°æŠ½è±¡ | Chapter 9: Platform Abstraction

```
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   "å¥½çš„æŠ½è±¡æ˜¯è½¯ä»¶å·¥ç¨‹çš„è‰ºæœ¯â€”â€”å®ƒéšè—å¤æ‚æ€§ï¼Œæš´éœ²æœ¬è´¨"                         |
|   "Good abstraction is the art of software engineeringâ€”                       |
|    it hides complexity and exposes essence"                                   |
|                                                                                   |
|   å¹³å°æŠ½è±¡è®©åŒä¸€ä»½éªŒè¯é€»è¾‘èƒ½åœ¨ä¸åŒç¯å¢ƒä¸­è¿è¡Œ                                  |
|   Platform abstraction allows the same verification logic                     |
|   to run in different environments                                            |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

## ğŸ¯ æœ¬ç« ç›®æ ‡ | Chapter Goals

å­¦å®Œè¿™ç« ï¼Œä½ ä¼šç†è§£ï¼š
- ä¸ºä»€ä¹ˆéœ€è¦å¹³å°æŠ½è±¡ (Why platform abstraction is needed)
- æ ¸å¿ƒ Trait çš„è®¾è®¡ (Core trait design)
- Linux å¹³å°çš„å®ç° (Linux platform implementation)
- å¦‚ä½•å®ç°è‡ªå®šä¹‰å¹³å° (How to implement custom platforms)

---

## ğŸ“ ä¸ºä»€ä¹ˆéœ€è¦å¹³å°æŠ½è±¡ | Why Platform Abstraction

```
+-----------------------------------------------------------------------------------+
|                          å¹³å°æŠ½è±¡çš„å¿…è¦æ€§                                      |
|                 The Necessity of Platform Abstraction                         |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   ä¸åŒ BPF è¿è¡Œæ—¶æœ‰ä¸åŒçš„ç‰¹æ€§:                                                |
|   Different BPF runtimes have different characteristics:                      |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   Linux å†…æ ¸                    è‡ªå®šä¹‰è¿è¡Œæ—¶                            | |
|   |   -----------------            -----------------                        | |
|   |   â€¢ 30+ ç¨‹åºç±»å‹               â€¢ è‡ªå®šä¹‰ç¨‹åºç±»å‹                         | |
|   |   â€¢ 200+ è¾…åŠ©å‡½æ•°              â€¢ è‡ªå®šä¹‰è¾…åŠ©å‡½æ•°                         | |
|   |   â€¢ å¤æ‚çš„ Map ç±»å‹            â€¢ ç®€åŒ–çš„ Map ç±»å‹                        | |
|   |   â€¢ ä¸¥æ ¼çš„å®‰å…¨çº¦æŸ             â€¢ å¯è°ƒæ•´çš„çº¦æŸ                           | |
|   |                                                                         | |
|   |   Windows eBPF                 ç”¨æˆ·æ€è¿è¡Œæ—¶                             | |
|   |   -----------------            -----------------                        | |
|   |   â€¢ Windows ç‰¹æœ‰ç±»å‹           â€¢ æ¨¡æ‹Ÿç¯å¢ƒ                               | |
|   |   â€¢ Windows API ç»‘å®š           â€¢ è°ƒè¯•ç›®çš„                               | |
|   |   â€¢ ä¸åŒçš„å®‰å…¨æ¨¡å‹             â€¢ æ•™å­¦ç”¨é€”                               | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   è§£å†³æ–¹æ¡ˆ: å°†é€šç”¨é€»è¾‘ä¸å¹³å°ç‰¹å®šä»£ç åˆ†ç¦»                                      |
|   Solution: Separate generic logic from platform-specific code                |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   é€šç”¨éªŒè¯é€»è¾‘ (bpf-verifier-core)                                      | |
|   |   -------------------------------------------------------------------   | |
|   |   â€¢ æŠ½è±¡è§£é‡Šç®—æ³•                                                        | |
|   |   â€¢ è¾¹ç•Œåˆ†æ                                                            | |
|   |   â€¢ çŠ¶æ€å‰ªæ                                                            | |
|   |   â€¢ ç±»å‹æ£€æŸ¥                                                            | |
|   |                                                                         | |
|   |   ä¸å¹³å°æ— å…³ï¼Œä½¿ç”¨ Trait å®šä¹‰æ¥å£                                       | |
|   |                                                                         | |
|   |   ---------------------------------------------------------------------   | |
|   |                                                                         | |
|   |   å¹³å°ç‰¹å®šå®ç°                                                          | |
|   |   -------------------------------------------------------------------   | |
|   |   â€¢ è¾…åŠ©å‡½æ•°å®šä¹‰                                                        | |
|   |   â€¢ ç¨‹åºç±»å‹å®šä¹‰                                                        | |
|   |   â€¢ ä¸Šä¸‹æ–‡è®¿é—®è§„åˆ™                                                      | |
|   |   â€¢ Map æ“ä½œå®šä¹‰                                                        | |
|   |                                                                         | |
|   |   æ¯ä¸ªå¹³å°æä¾›è‡ªå·±çš„å®ç°                                                | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡ | Architecture Design

```
+-----------------------------------------------------------------------------------+
|                           å¹³å°æŠ½è±¡æ¶æ„                                         |
|                    Platform Abstraction Architecture                          |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |                    bpf-verifier (é¡¶å±‚åŒ…è£…)                       |   | |
|   |   |                    Top-level Wrapper                            |   | |
|   |   |                                                                 |   | |
|   |   |   æä¾›ç®€å•çš„å…¬å…± APIï¼Œéšè—å†…éƒ¨å¤æ‚æ€§                             |   | |
|   |   |   Provides simple public API, hides internal complexity          |   | |
|   |   |                                                                 |   | |
|   |   +---------------------------+-------------------------------------+   | |
|   |                               |                                         | |
|   |                               v                                         | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |                  bpf-verifier-core (æ ¸å¿ƒåº“)                      |   | |
|   |   |                  Platform-Agnostic Core                         |   | |
|   |   |                                                                 |   | |
|   |   |   +-----------------------------------------------------------+ |   | |
|   |   |   |                    Platform Traits                        | |   | |
|   |   |   |   -----------------------------------------------------   | |   | |
|   |   |   |                                                           | |   | |
|   |   |   |   +-----------------+    +-----------------+              | |   | |
|   |   |   |   |  PlatformSpec   |    | HelperProvider  |              | |   | |
|   |   |   |   |                 |    |                 |              | |   | |
|   |   |   |   | â€¢ ProgType      |    | â€¢ get_helper    |              | |   | |
|   |   |   |   | â€¢ MapType       |    | â€¢ check_call    |              | |   | |
|   |   |   |   | â€¢ HelperId      |    | â€¢ simulate      |              | |   | |
|   |   |   |   +-----------------+    +-----------------+              | |   | |
|   |   |   |                                                           | |   | |
|   |   |   |   +-----------------+    +-----------------+              | |   | |
|   |   |   |   |  MapOperations  |    |  ContextAccess  |              | |   | |
|   |   |   |   |                 |    |                 |              | |   | |
|   |   |   |   | â€¢ lookup        |    | â€¢ check_offset  |              | |   | |
|   |   |   |   | â€¢ update        |    | â€¢ get_type      |              | |   | |
|   |   |   |   | â€¢ delete        |    | â€¢ get_size      |              | |   | |
|   |   |   |   +-----------------+    +-----------------+              | |   | |
|   |   |   |                                                           | |   | |
|   |   |   +-----------------------------------------------------------+ |   | |
|   |   |                                                                 |   | |
|   |   |   +-----------------------------------------------------------+ |   | |
|   |   |   |                 éªŒè¯æ ¸å¿ƒé€»è¾‘                               | |   | |
|   |   |   |              Core Verification Logic                      | |   | |
|   |   |   |                                                           | |   | |
|   |   |   |   â€¢ GenericVerifierEnv<P: PlatformSpec>                   | |   | |
|   |   |   |   â€¢ æŠ½è±¡è§£é‡Šã€è¾¹ç•Œåˆ†æã€çŠ¶æ€å‰ªæ...                        | |   | |
|   |   |   |                                                           | |   | |
|   |   |   +-----------------------------------------------------------+ |   | |
|   |   |                                                                 |   | |
|   |   +---------------------------+-------------------------------------+   | |
|   |                               |                                         | |
|   |           +-------------------+-------------------+                     | |
|   |           |                   |                   |                     | |
|   |           v                   v                   v                     | |
|   |   +---------------+   +---------------+   +---------------+             | |
|   |   |bpf-verifier-  |   |   Future      |   |    Custom     |             | |
|   |   |linux          |   |   Platform    |   |    Platform   |             | |
|   |   |               |   |               |   |               |             | |
|   |   | å®ç° Linux    |   |  Windows/     |   |   ç”¨æˆ·è‡ªå®šä¹‰  |             | |
|   |   | å†…æ ¸çš„æ‰€æœ‰    |   |  å…¶ä»–å¹³å°     |   |   å¹³å°å®ç°    |             | |
|   |   | Trait         |   |               |   |               |             | |
|   |   +---------------+   +---------------+   +---------------+             | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ“ æ ¸å¿ƒ Trait å®šä¹‰ | Core Trait Definitions

### PlatformSpec Trait

```
+-----------------------------------------------------------------------------------+
|                           PlatformSpec Trait                                  |
|                          å¹³å°è§„èŒƒç‰¹æ€§                                          |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   PlatformSpec å®šä¹‰äº† BPF è¿è¡Œæ—¶çš„åŸºæœ¬ç‰¹æ€§:                                   |
|   PlatformSpec defines basic characteristics of a BPF runtime:                |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   pub trait PlatformSpec {                                              | |
|   |       // ------------------------------------------------------------   | |
|   |       // å…³è”ç±»å‹ | Associated Types                                    | |
|   |       // ------------------------------------------------------------   | |
|   |                                                                         | |
|   |       /// ç¨‹åºç±»å‹æšä¸¾ (å¦‚ XDP, KPROBE, SOCKET_FILTER ç­‰)              | |
|   |       type ProgType: Copy + Clone + Eq + Debug;                         | |
|   |                                                                         | |
|   |       /// Map ç±»å‹æšä¸¾ (å¦‚ HASH, ARRAY, PERF_EVENT_ARRAY ç­‰)           | |
|   |       type MapType: Copy + Clone + Eq + Debug;                          | |
|   |                                                                         | |
|   |       /// è¾…åŠ©å‡½æ•° ID (å¦‚ bpf_map_lookup_elem ç­‰)                       | |
|   |       type HelperId: Copy + Clone + Eq + Debug;                         | |
|   |                                                                         | |
|   |       // ------------------------------------------------------------   | |
|   |       // å¿…éœ€æ–¹æ³• | Required Methods                                    | |
|   |       // ------------------------------------------------------------   | |
|   |                                                                         | |
|   |       /// è·å–ç¨‹åºç±»å‹åç§°                                              | |
|   |       fn prog_type_name(prog_type: Self::ProgType) -> &'static str;     | |
|   |                                                                         | |
|   |       /// æ£€æŸ¥ç¨‹åºç±»å‹æ˜¯å¦æ”¯æŒæŸè¾…åŠ©å‡½æ•°                                | |
|   |       fn prog_type_allows_helper(                                       | |
|   |           prog_type: Self::ProgType,                                    | |
|   |           helper: Self::HelperId,                                       | |
|   |       ) -> bool;                                                        | |
|   |                                                                         | |
|   |       // ------------------------------------------------------------   | |
|   |       // å¯é€‰æ–¹æ³•ï¼ˆæœ‰é»˜è®¤å€¼ï¼‰ | Optional Methods (with defaults)        | |
|   |       // ------------------------------------------------------------   | |
|   |                                                                         | |
|   |       /// æ ˆå¤§å°é™åˆ¶ (é»˜è®¤ 512 å­—èŠ‚)                                    | |
|   |       fn stack_size() -> usize { 512 }                                  | |
|   |                                                                         | |
|   |       /// æœ€å¤§æŒ‡ä»¤æ•° (é»˜è®¤ 100 ä¸‡)                                      | |
|   |       fn max_insns() -> usize { 1_000_000 }                             | |
|   |                                                                         | |
|   |       /// æœ€å¤§è°ƒç”¨æ·±åº¦ (é»˜è®¤ 8)                                         | |
|   |       fn max_call_depth() -> usize { 8 }                                | |
|   |   }                                                                     | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### HelperProvider Trait

```
+-----------------------------------------------------------------------------------+
|                          HelperProvider Trait                                 |
|                          è¾…åŠ©å‡½æ•°æä¾›è€…ç‰¹æ€§                                    |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   pub trait HelperProvider: PlatformSpec {                              | |
|   |                                                                         | |
|   |       /// è·å–è¾…åŠ©å‡½æ•°ä¿¡æ¯                                              | |
|   |       /// Get helper function information                               | |
|   |       fn get_helper_info(                                               | |
|   |           id: Self::HelperId                                            | |
|   |       ) -> Option<HelperInfo>;                                          | |
|   |                                                                         | |
|   |       /// æ£€æŸ¥è¾…åŠ©å‡½æ•°è°ƒç”¨æ˜¯å¦åˆæ³•                                      | |
|   |       /// Check if helper call is valid                                 | |
|   |       fn check_helper_call<P: PlatformSpec>(                            | |
|   |           env: &mut GenericVerifierEnv<P>,                              | |
|   |           helper_id: Self::HelperId,                                    | |
|   |       ) -> Result<()>;                                                  | |
|   |                                                                         | |
|   |       /// æ¨¡æ‹Ÿè¾…åŠ©å‡½æ•°çš„æ•ˆæœ                                            | |
|   |       /// Simulate helper function effects                              | |
|   |       fn simulate_helper<P: PlatformSpec>(                              | |
|   |           env: &mut GenericVerifierEnv<P>,                              | |
|   |           helper_id: Self::HelperId,                                    | |
|   |       ) -> Result<BpfRegState>;                                         | |
|   |   }                                                                     | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   è¾…åŠ©å‡½æ•°ä¿¡æ¯ç»“æ„ | Helper Info Structure:                                   |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   pub struct HelperInfo {                                               | |
|   |       /// å‡½æ•°åç§°                                                      | |
|   |       pub name: &'static str,                                           | |
|   |                                                                         | |
|   |       /// å‚æ•°ç±»å‹ (æœ€å¤š 5 ä¸ª)                                          | |
|   |       pub arg_types: [ArgType; 5],                                      | |
|   |                                                                         | |
|   |       /// è¿”å›ç±»å‹                                                      | |
|   |       pub ret_type: RetType,                                            | |
|   |   }                                                                     | |
|   |                                                                         | |
|   |   pub enum ArgType {                                                    | |
|   |       None,                      // æ— å‚æ•°                              | |
|   |       Scalar,                    // æ ‡é‡å€¼                              | |
|   |       PtrToMap,                  // Map æŒ‡é’ˆ                            | |
|   |       PtrToMapKey,               // Map key æŒ‡é’ˆ                        | |
|   |       PtrToMapValue,             // Map value æŒ‡é’ˆ                      | |
|   |       PtrToMem,                  // é€šç”¨å†…å­˜æŒ‡é’ˆ                        | |
|   |       PtrToStack,                // æ ˆæŒ‡é’ˆ                              | |
|   |       Size,                      // å¤§å°å‚æ•°                            | |
|   |   }                                                                     | |
|   |                                                                         | |
|   |   pub enum RetType {                                                    | |
|   |       Void,                      // æ— è¿”å›å€¼                            | |
|   |       Scalar,                    // æ ‡é‡è¿”å›                            | |
|   |       PtrToMapValueOrNull,       // Map value æŒ‡é’ˆæˆ– NULL              | |
|   |       PtrToMem,                  // å†…å­˜æŒ‡é’ˆ                            | |
|   |       Integer,                   // æ•´æ•° (0 = æˆåŠŸ, è´Ÿæ•° = é”™è¯¯)       | |
|   |   }                                                                     | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### MapOperations Trait

```
+-----------------------------------------------------------------------------------+
|                          MapOperations Trait                                  |
|                          Map æ“ä½œç‰¹æ€§                                         |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   pub trait MapOperations: PlatformSpec {                               | |
|   |                                                                         | |
|   |       /// Map å¥æŸ„ç±»å‹                                                  | |
|   |       type MapHandle;                                                   | |
|   |                                                                         | |
|   |       /// è·å– Map ä¿¡æ¯                                                 | |
|   |       fn get_map_info(handle: &Self::MapHandle) -> MapInfo;             | |
|   |                                                                         | |
|   |       /// æ£€æŸ¥ Map è®¿é—®æƒé™                                             | |
|   |       fn check_map_access(                                              | |
|   |           map_type: Self::MapType,                                      | |
|   |           access: MapAccessType,                                        | |
|   |       ) -> Result<()>;                                                  | |
|   |                                                                         | |
|   |       /// è·å– Map value æŒ‡é’ˆç±»å‹                                       | |
|   |       fn map_value_ptr_type(                                            | |
|   |           map_type: Self::MapType                                       | |
|   |       ) -> BpfRegType;                                                  | |
|   |   }                                                                     | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   Map ä¿¡æ¯ç»“æ„ | Map Info Structure:                                          |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   pub struct MapInfo {                                                  | |
|   |       pub map_type: u32,        // Map ç±»å‹ ID                          | |
|   |       pub key_size: u32,        // Key å¤§å° (å­—èŠ‚)                      | |
|   |       pub value_size: u32,      // Value å¤§å° (å­—èŠ‚)                    | |
|   |       pub max_entries: u32,     // æœ€å¤§æ¡ç›®æ•°                           | |
|   |       pub flags: u32,           // Map æ ‡å¿—                             | |
|   |   }                                                                     | |
|   |                                                                         | |
|   |   pub enum MapAccessType {                                              | |
|   |       Read,                     // è¯»å–                                 | |
|   |       Write,                    // å†™å…¥                                 | |
|   |       ReadWrite,                // è¯»å†™                                 | |
|   |   }                                                                     | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ§ Linux å¹³å°å®ç° | Linux Platform Implementation

### Linux å¹³å°ç±»å‹å®šä¹‰ | Linux Platform Type Definitions

```
+-----------------------------------------------------------------------------------+
|                        Linux å¹³å°å®ç°                                          |
|                   Linux Platform Implementation                               |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   ç¨‹åºç±»å‹ | Program Types:                                                   |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   #[derive(Clone, Copy, PartialEq, Eq, Debug)]                          | |
|   |   pub enum LinuxProgType {                                              | |
|   |       Unspec           = 0,   // æœªæŒ‡å®š                                 | |
|   |       SocketFilter     = 1,   // å¥—æ¥å­—è¿‡æ»¤å™¨                           | |
|   |       Kprobe           = 2,   // å†…æ ¸æ¢é’ˆ                               | |
|   |       SchedCls         = 3,   // æµé‡åˆ†ç±»                               | |
|   |       SchedAct         = 4,   // æµé‡åŠ¨ä½œ                               | |
|   |       Tracepoint       = 5,   // è·Ÿè¸ªç‚¹                                 | |
|   |       Xdp              = 6,   // XDP                                    | |
|   |       PerfEvent        = 7,   // æ€§èƒ½äº‹ä»¶                               | |
|   |       CgroupSkb        = 8,   // Cgroup å¥—æ¥å­—                          | |
|   |       CgroupSock       = 9,   // Cgroup å¥—æ¥å­—æ“ä½œ                      | |
|   |       LwtIn            = 10,  // è½»é‡çº§éš§é“å…¥                           | |
|   |       LwtOut           = 11,  // è½»é‡çº§éš§é“å‡º                           | |
|   |       LwtXmit          = 12,  // è½»é‡çº§éš§é“å‘é€                         | |
|   |       SockOps          = 13,  // å¥—æ¥å­—æ“ä½œ                             | |
|   |       SkSkb            = 14,  // å¥—æ¥å­—ç¼“å†²åŒº                           | |
|   |       CgroupDevice     = 15,  // Cgroup è®¾å¤‡                            | |
|   |       SkMsg            = 16,  // å¥—æ¥å­—æ¶ˆæ¯                             | |
|   |       RawTracepoint    = 17,  // åŸå§‹è·Ÿè¸ªç‚¹                             | |
|   |       CgroupSockAddr   = 18,  // Cgroup å¥—æ¥å­—åœ°å€                      | |
|   |       LwtSeg6Local     = 19,  // SRv6 æœ¬åœ°                              | |
|   |       LircMode2        = 20,  // LIRC                                   | |
|   |       SkReuseport      = 21,  // ç«¯å£å¤ç”¨                               | |
|   |       FlowDissector    = 22,  // æµè§£æ                                 | |
|   |       CgroupSysctl     = 23,  // Cgroup sysctl                          | |
|   |       RawTracepointWritable = 24,                                       | |
|   |       CgroupSockopt    = 25,  // Cgroup å¥—æ¥å­—é€‰é¡¹                      | |
|   |       Tracing          = 26,  // BTF è·Ÿè¸ª                               | |
|   |       StructOps        = 27,  // ç»“æ„æ“ä½œ                               | |
|   |       Ext              = 28,  // æ‰©å±•                                   | |
|   |       Lsm              = 29,  // LSM                                    | |
|   |       SkLookup         = 30,  // å¥—æ¥å­—æŸ¥æ‰¾                             | |
|   |       Syscall          = 31,  // ç³»ç»Ÿè°ƒç”¨                               | |
|   |       // ... Linux ä¸æ–­æ·»åŠ æ–°ç±»å‹                                       | |
|   |   }                                                                     | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   Map ç±»å‹ | Map Types:                                                       |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   #[derive(Clone, Copy, PartialEq, Eq, Debug)]                          | |
|   |   pub enum LinuxMapType {                                               | |
|   |       Unspec           = 0,   // æœªæŒ‡å®š                                 | |
|   |       Hash             = 1,   // å“ˆå¸Œè¡¨                                 | |
|   |       Array            = 2,   // æ•°ç»„                                   | |
|   |       ProgArray        = 3,   // ç¨‹åºæ•°ç»„                               | |
|   |       PerfEventArray   = 4,   // æ€§èƒ½äº‹ä»¶æ•°ç»„                           | |
|   |       PerCpuHash       = 5,   // Per-CPU å“ˆå¸Œ                          | |
|   |       PerCpuArray      = 6,   // Per-CPU æ•°ç»„                          | |
|   |       StackTrace       = 7,   // æ ˆè·Ÿè¸ª                                 | |
|   |       CgroupArray      = 8,   // Cgroup æ•°ç»„                            | |
|   |       LruHash          = 9,   // LRU å“ˆå¸Œ                               | |
|   |       LruPerCpuHash    = 10,  // Per-CPU LRU å“ˆå¸Œ                      | |
|   |       LpmTrie          = 11,  // LPM å‰ç¼€æ ‘                             | |
|   |       ArrayOfMaps      = 12,  // Map æ•°ç»„                               | |
|   |       HashOfMaps       = 13,  // Map å“ˆå¸Œ                               | |
|   |       DevMap           = 14,  // è®¾å¤‡ Map                               | |
|   |       SockMap          = 15,  // å¥—æ¥å­— Map                             | |
|   |       CpuMap           = 16,  // CPU Map                                | |
|   |       XskMap           = 17,  // XDP å¥—æ¥å­— Map                         | |
|   |       SockHash         = 18,  // å¥—æ¥å­—å“ˆå¸Œ                             | |
|   |       CgroupStorage    = 19,  // Cgroup å­˜å‚¨                            | |
|   |       ReuseportSockarray = 20,                                          | |
|   |       PerCpuCgroupStorage = 21,                                         | |
|   |       Queue            = 22,  // é˜Ÿåˆ—                                   | |
|   |       Stack            = 23,  // æ ˆ                                     | |
|   |       SkStorage        = 24,  // å¥—æ¥å­—å­˜å‚¨                             | |
|   |       DevMapHash       = 25,  // è®¾å¤‡ Map å“ˆå¸Œ                          | |
|   |       StructOps        = 26,  // ç»“æ„æ“ä½œ                               | |
|   |       RingBuf          = 27,  // ç¯å½¢ç¼“å†²åŒº                             | |
|   |       InodeStorage     = 28,  // Inode å­˜å‚¨                             | |
|   |       TaskStorage      = 29,  // ä»»åŠ¡å­˜å‚¨                               | |
|   |       BloomFilter      = 30,  // å¸ƒéš†è¿‡æ»¤å™¨                             | |
|   |       // ... Linux ä¸æ–­æ·»åŠ æ–°ç±»å‹                                       | |
|   |   }                                                                     | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### Linux è¾…åŠ©å‡½æ•° | Linux Helper Functions

```
+-----------------------------------------------------------------------------------+
|                        Linux è¾…åŠ©å‡½æ•°ç¤ºä¾‹                                      |
|                   Linux Helper Functions Examples                             |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   /// å¸¸ç”¨ Linux BPF è¾…åŠ©å‡½æ•°                                           | |
|   |   #[derive(Clone, Copy, PartialEq, Eq, Debug)]                          | |
|   |   pub enum LinuxHelperId {                                              | |
|   |       // ----------------------------------------------------------     | |
|   |       // Map æ“ä½œ | Map Operations                                      | |
|   |       // ----------------------------------------------------------     | |
|   |       MapLookupElem    = 1,   // bpf_map_lookup_elem                    | |
|   |       MapUpdateElem    = 2,   // bpf_map_update_elem                    | |
|   |       MapDeleteElem    = 3,   // bpf_map_delete_elem                    | |
|   |       MapPushElem      = 87,  // bpf_map_push_elem                      | |
|   |       MapPopElem       = 88,  // bpf_map_pop_elem                       | |
|   |       MapPeekElem      = 89,  // bpf_map_peek_elem                      | |
|   |                                                                         | |
|   |       // ----------------------------------------------------------     | |
|   |       // å†…æ ¸æ¢æµ‹ | Kernel Probing                                      | |
|   |       // ----------------------------------------------------------     | |
|   |       ProbeRead        = 4,   // bpf_probe_read                         | |
|   |       ProbeReadUser    = 112, // bpf_probe_read_user                    | |
|   |       ProbeReadKernel  = 113, // bpf_probe_read_kernel                  | |
|   |       ProbeReadStr     = 45,  // bpf_probe_read_str                     | |
|   |                                                                         | |
|   |       // ----------------------------------------------------------     | |
|   |       // æ—¶é—´/éšæœº | Time/Random                                        | |
|   |       // ----------------------------------------------------------     | |
|   |       KtimeGetNs       = 5,   // bpf_ktime_get_ns                       | |
|   |       KtimeGetBootNs   = 125, // bpf_ktime_get_boot_ns                  | |
|   |       GetPrandomU32    = 7,   // bpf_get_prandom_u32                    | |
|   |                                                                         | |
|   |       // ----------------------------------------------------------     | |
|   |       // è¿›ç¨‹ä¿¡æ¯ | Process Info                                        | |
|   |       // ----------------------------------------------------------     | |
|   |       GetCurrentPidTgid = 14, // bpf_get_current_pid_tgid               | |
|   |       GetCurrentUidGid  = 15, // bpf_get_current_uid_gid                | |
|   |       GetCurrentComm    = 16, // bpf_get_current_comm                   | |
|   |       GetCurrentTask    = 35, // bpf_get_current_task                   | |
|   |       GetCurrentTaskBtf = 127,// bpf_get_current_task_btf               | |
|   |                                                                         | |
|   |       // ----------------------------------------------------------     | |
|   |       // ç½‘ç»œ/XDP | Network/XDP                                         | |
|   |       // ----------------------------------------------------------     | |
|   |       XdpAdjustHead    = 44,  // bpf_xdp_adjust_head                    | |
|   |       XdpAdjustTail    = 65,  // bpf_xdp_adjust_tail                    | |
|   |       XdpAdjustMeta    = 54,  // bpf_xdp_adjust_meta                    | |
|   |       Redirect         = 23,  // bpf_redirect                           | |
|   |       RedirectMap      = 51,  // bpf_redirect_map                       | |
|   |                                                                         | |
|   |       // ----------------------------------------------------------     | |
|   |       // è°ƒè¯• | Debug                                                   | |
|   |       // ----------------------------------------------------------     | |
|   |       TracePrintk      = 6,   // bpf_trace_printk                       | |
|   |       TraceVprintk     = 177, // bpf_trace_vprintk                      | |
|   |                                                                         | |
|   |       // ... Linux å®šä¹‰äº† 200+ è¾…åŠ©å‡½æ•°                                 | |
|   |   }                                                                     | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   è¾…åŠ©å‡½æ•°ä¿¡æ¯å®ç° | Helper Info Implementation:                              |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   impl HelperProvider for LinuxPlatform {                               | |
|   |       fn get_helper_info(id: LinuxHelperId) -> Option<HelperInfo> {     | |
|   |           match id {                                                    | |
|   |               LinuxHelperId::MapLookupElem => Some(HelperInfo {         | |
|   |                   name: "bpf_map_lookup_elem",                          | |
|   |                   arg_types: [                                          | |
|   |                       ArgType::PtrToMap,      // å‚æ•°1: map æŒ‡é’ˆ        | |
|   |                       ArgType::PtrToMapKey,   // å‚æ•°2: key æŒ‡é’ˆ        | |
|   |                       ArgType::None,                                    | |
|   |                       ArgType::None,                                    | |
|   |                       ArgType::None,                                    | |
|   |                   ],                                                    | |
|   |                   ret_type: RetType::PtrToMapValueOrNull,               | |
|   |               }),                                                       | |
|   |                                                                         | |
|   |               LinuxHelperId::GetCurrentPidTgid => Some(HelperInfo {     | |
|   |                   name: "bpf_get_current_pid_tgid",                     | |
|   |                   arg_types: [ArgType::None; 5],  // æ— å‚æ•°             | |
|   |                   ret_type: RetType::Scalar,      // è¿”å› u64           | |
|   |               }),                                                       | |
|   |                                                                         | |
|   |               LinuxHelperId::KtimeGetNs => Some(HelperInfo {            | |
|   |                   name: "bpf_ktime_get_ns",                             | |
|   |                   arg_types: [ArgType::None; 5],                        | |
|   |                   ret_type: RetType::Scalar,                            | |
|   |               }),                                                       | |
|   |                                                                         | |
|   |               _ => None,                                                | |
|   |           }                                                             | |
|   |       }                                                                 | |
|   |   }                                                                     | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ”§ å®ç°è‡ªå®šä¹‰å¹³å° | Implementing Custom Platform

```
+-----------------------------------------------------------------------------------+
|                          è‡ªå®šä¹‰å¹³å°ç¤ºä¾‹                                        |
|                    Custom Platform Example                                    |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   // å®šä¹‰è‡ªå®šä¹‰å¹³å°                                                     | |
|   |   pub struct MinimalPlatform;                                           | |
|   |                                                                         | |
|   |   // å®šä¹‰ç¨‹åºç±»å‹                                                       | |
|   |   #[derive(Clone, Copy, PartialEq, Eq, Debug)]                          | |
|   |   pub enum MinimalProgType {                                            | |
|   |       Default = 0,                                                      | |
|   |   }                                                                     | |
|   |                                                                         | |
|   |   // å®šä¹‰ Map ç±»å‹                                                      | |
|   |   #[derive(Clone, Copy, PartialEq, Eq, Debug)]                          | |
|   |   pub enum MinimalMapType {                                             | |
|   |       Hash = 0,                                                         | |
|   |       Array = 1,                                                        | |
|   |   }                                                                     | |
|   |                                                                         | |
|   |   // å®šä¹‰è¾…åŠ©å‡½æ•° ID                                                    | |
|   |   #[derive(Clone, Copy, PartialEq, Eq, Debug)]                          | |
|   |   pub enum MinimalHelperId {                                            | |
|   |       Print = 1,     // ç®€å•æ‰“å°                                        | |
|   |       GetTime = 2,   // è·å–æ—¶é—´                                        | |
|   |       MapLookup = 3, // Map æŸ¥æ‰¾                                        | |
|   |   }                                                                     | |
|   |                                                                         | |
|   |   // å®ç° PlatformSpec                                                  | |
|   |   impl PlatformSpec for MinimalPlatform {                               | |
|   |       type ProgType = MinimalProgType;                                  | |
|   |       type MapType = MinimalMapType;                                    | |
|   |       type HelperId = MinimalHelperId;                                  | |
|   |                                                                         | |
|   |       fn prog_type_name(prog_type: Self::ProgType) -> &'static str {    | |
|   |           match prog_type {                                             | |
|   |               MinimalProgType::Default => "default",                    | |
|   |           }                                                             | |
|   |       }                                                                 | |
|   |                                                                         | |
|   |       fn prog_type_allows_helper(                                       | |
|   |           _prog_type: Self::ProgType,                                   | |
|   |           _helper: Self::HelperId,                                      | |
|   |       ) -> bool {                                                       | |
|   |           true // å…è®¸æ‰€æœ‰è¾…åŠ©å‡½æ•°                                      | |
|   |       }                                                                 | |
|   |                                                                         | |
|   |       // å¯é€‰: è‡ªå®šä¹‰é™åˆ¶                                               | |
|   |       fn stack_size() -> usize { 256 }     // æ›´å°çš„æ ˆ                  | |
|   |       fn max_insns() -> usize { 10_000 }   // æ›´å°‘çš„æŒ‡ä»¤                | |
|   |   }                                                                     | |
|   |                                                                         | |
|   |   // å®ç° HelperProvider                                                | |
|   |   impl HelperProvider for MinimalPlatform {                             | |
|   |       fn get_helper_info(id: Self::HelperId) -> Option<HelperInfo> {    | |
|   |           match id {                                                    | |
|   |               MinimalHelperId::Print => Some(HelperInfo {               | |
|   |                   name: "print",                                        | |
|   |                   arg_types: [ArgType::Scalar, ArgType::None,           | |
|   |                               ArgType::None, ArgType::None,             | |
|   |                               ArgType::None],                           | |
|   |                   ret_type: RetType::Void,                              | |
|   |               }),                                                       | |
|   |               MinimalHelperId::GetTime => Some(HelperInfo {             | |
|   |                   name: "get_time",                                     | |
|   |                   arg_types: [ArgType::None; 5],                        | |
|   |                   ret_type: RetType::Scalar,                            | |
|   |               }),                                                       | |
|   |               MinimalHelperId::MapLookup => Some(HelperInfo {           | |
|   |                   name: "map_lookup",                                   | |
|   |                   arg_types: [ArgType::PtrToMap, ArgType::PtrToMapKey,  | |
|   |                               ArgType::None, ArgType::None,             | |
|   |                               ArgType::None],                           | |
|   |                   ret_type: RetType::PtrToMapValueOrNull,               | |
|   |               }),                                                       | |
|   |           }                                                             | |
|   |       }                                                                 | |
|   |                                                                         | |
|   |       // ... å…¶ä»–æ–¹æ³•                                                   | |
|   |   }                                                                     | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ’ å¹³å°æŠ½è±¡çš„ä¼˜åŠ¿ | Benefits of Platform Abstraction

```
+-----------------------------------------------------------------------------------+
|                          å¹³å°æŠ½è±¡çš„ä¼˜åŠ¿                                        |
|                  Benefits of Platform Abstraction                             |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   1. ä»£ç å¤ç”¨ | Code Reuse                                              | |
|   |   -----------------------------------------------------------------    | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |                                                                 |   | |
|   |   |   æ ¸å¿ƒéªŒè¯é€»è¾‘åªå†™ä¸€æ¬¡:                                         |   | |
|   |   |   â€¢ è¾¹ç•Œåˆ†æç®—æ³•                                                |   | |
|   |   |   â€¢ Tnum è¿ç®—                                                   |   | |
|   |   |   â€¢ çŠ¶æ€å‰ªæé€»è¾‘                                                |   | |
|   |   |   â€¢ CFG æ„å»ºå’Œéå†                                              |   | |
|   |   |                                                                 |   | |
|   |   |   æ‰€æœ‰å¹³å°å…±äº«ç›¸åŒçš„é«˜è´¨é‡å®ç°                                  |   | |
|   |   |                                                                 |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   2. æ˜“äºæµ‹è¯• | Easy to Test                                            | |
|   |   -----------------------------------------------------------------    | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |                                                                 |   | |
|   |   |   å¯ä»¥åˆ›å»ºç®€åŒ–çš„æµ‹è¯•å¹³å°:                                       |   | |
|   |   |   â€¢ æœ€å°åŒ–çš„è¾…åŠ©å‡½æ•°é›†                                          |   | |
|   |   |   â€¢ å—æ§çš„ç¯å¢ƒ                                                  |   | |
|   |   |   â€¢ ç¡®å®šæ€§çš„è¡Œä¸º                                                |   | |
|   |   |                                                                 |   | |
|   |   |   ä¸éœ€è¦çœŸå®å†…æ ¸ç¯å¢ƒå°±èƒ½æµ‹è¯•æ ¸å¿ƒé€»è¾‘                            |   | |
|   |   |                                                                 |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   3. çµæ´»æ‰©å±• | Flexible Extension                                      | |
|   |   -----------------------------------------------------------------    | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |                                                                 |   | |
|   |   |   æ·»åŠ æ–°å¹³å°åªéœ€å®ç°ç›¸å…³ Trait:                                 |   | |
|   |   |   â€¢ ä¸ä¿®æ”¹æ ¸å¿ƒä»£ç                                               |   | |
|   |   |   â€¢ ç±»å‹å®‰å…¨ä¿è¯                                                |   | |
|   |   |   â€¢ ç¼–è¯‘æ—¶æ£€æŸ¥                                                  |   | |
|   |   |                                                                 |   | |
|   |   |   æ”¯æŒ Windows eBPF? å®ç° WindowsPlatform å³å¯                  |   | |
|   |   |   æ”¯æŒç”¨æˆ·æ€è¿è¡Œæ—¶? å®ç° UserspacePlatform å³å¯                 |   | |
|   |   |                                                                 |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   4. å…³æ³¨ç‚¹åˆ†ç¦» | Separation of Concerns                                | |
|   |   -----------------------------------------------------------------    | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |                                                                 |   | |
|   |   |   æ ¸å¿ƒéªŒè¯ vs å¹³å°ç»†èŠ‚ æ¸…æ™°åˆ†ç¦»:                                |   | |
|   |   |                                                                 |   | |
|   |   |   æ ¸å¿ƒå¼€å‘è€…:                                                   |   | |
|   |   |   â€¢ ä¸“æ³¨äºéªŒè¯ç®—æ³•çš„æ­£ç¡®æ€§å’Œæ•ˆç‡                                |   | |
|   |   |   â€¢ ä¸éœ€è¦äº†è§£å…·ä½“å¹³å°çš„ç»†èŠ‚                                    |   | |
|   |   |                                                                 |   | |
|   |   |   å¹³å°å¼€å‘è€…:                                                   |   | |
|   |   |   â€¢ ä¸“æ³¨äºå¹³å°ç‰¹å®šçš„å®šä¹‰                                        |   | |
|   |   |   â€¢ ä¸éœ€è¦äº†è§£éªŒè¯ç®—æ³•çš„å®ç°                                    |   | |
|   |   |                                                                 |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ“ å°ç»“ | Summary

æœ¬ç« ä»‹ç»äº†å¹³å°æŠ½è±¡è®¾è®¡ï¼š

| ç»„ä»¶ | è¯´æ˜ | ä»£ç ä½ç½® |
|------|------|---------|
| PlatformSpec | å¹³å°åŸºæœ¬è§„èŒƒ | `platform/mod.rs` |
| HelperProvider | è¾…åŠ©å‡½æ•°æä¾› | `platform/mod.rs` |
| MapOperations | Map æ“ä½œæ¥å£ | `platform/mod.rs` |
| LinuxPlatform | Linux å®ç° | `bpf-verifier-linux/` |

---

## ğŸ“ ç»ƒä¹  | Exercises

1. **å®ç°ç®€å•å¹³å°**: åˆ›å»ºä¸€ä¸ªåªæ”¯æŒç®—æœ¯è¿ç®—çš„æœ€å°å¹³å°
2. **æ·»åŠ è¾…åŠ©å‡½æ•°**: ä¸º Linux å¹³å°æ·»åŠ ä¸€ä¸ªæ–°çš„è¾…åŠ©å‡½æ•°
3. **è‡ªå®šä¹‰æ£€æŸ¥**: ä¸ºè‡ªå®šä¹‰å¹³å°å®ç°ä¸Šä¸‹æ–‡è®¿é—®æ£€æŸ¥

---

## ğŸ”— ä»£ç ä½ç½®ç´¢å¼• | Code Location Index

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ |
|------|---------|
| å¹³å° Trait | `core/src/platform/mod.rs` |
| Linux å®ç° | `linux/src/lib.rs` |
| ç¨‹åºç±»å‹ | `linux/src/prog_type.rs` |
| è¾…åŠ©å‡½æ•° | `linux/src/helpers.rs` |

---

ğŸ‘‰ [ä¸‹ä¸€ç« ï¼šåŠ¨æ‰‹å®è·µ | Next: Hands-on Practice](10-hands-on.md)
