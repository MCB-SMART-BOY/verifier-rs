# 第四章：项目架构总览

# Chapter 4: Project Architecture Overview

```
+-----------------------------------------------------------------------------------+
|                                                                                   |
|     █████+ ██████+  ██████+██+  ██+██+████████+███████+ ██████+████████+          |
|    ██+--██+██+--██+██+----+██|  ██|██|+--██+--+██+----+██+----++--██+--+          |
|    ███████|██████++██|     ███████|██|   ██|   █████+  ██|        ██|             |
|    ██+--██|██+--██+██|     ██+--██|██|   ██|   ██+--+  ██|        ██|             |
|    ██|  ██|██|  ██|+██████+██|  ██|██|   ██|   ███████++██████+   ██|             |
|    +-+  +-++-+  +-+ +-----++-+  +-++-+   +-+   +------+ +-----+   +-+             |
|                                                                                   |
|                            现在我们进入代码的世界！                               |
|                     Now we enter the world of code!                               |
|                                                                                   |
|          这章会给你一个整体的地图，让你知道每个部分在哪里，做什么用               |
+-----------------------------------------------------------------------------------+
```

## 本章目标 | Chapter Goals

学完这章，你将能够：
- 了解项目的完整目录结构
- 知道每个 crate 的职责和依赖关系
- 理解模块之间的组织和数据流
- 快速定位任何功能对应的代码位置

---

## 项目目录结构 | Project Directory Structure

```
+-----------------------------------------------------------------------------------+
|                            项目目录结构                                           |
|                      Project Directory Structure                                  |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   verifier-rs/                                                                    |
|   |                                                                               |
|   +-- Cargo.toml                    # 工作区配置 (Workspace config)               |
|   |                                                                               |
|   +-- crates/                       # 所有的 Rust crate                           |
|   |   |                                                                           |
|   |   +-- bpf-verifier-core/        # 核心库 (平台无关)                           |
|   |   |   |                          Core library (platform-agnostic)             |
|   |   |   +-- Cargo.toml                                                          |
|   |   |   +-- src/                                                                |
|   |   |       +-- lib.rs            # 库入口                                      |
|   |   |       +-- core/             # 基础类型和指令                              |
|   |   |       +-- state/            # 验证器状态管理                              |
|   |   |       +-- bounds/           # 边界分析算法                                |
|   |   |       +-- analysis/         # 程序静态分析                                |
|   |   |       +-- check/            # 指令验证检查                                |
|   |   |       +-- mem/              # 内存访问验证                                |
|   |   |       +-- special/          # 特殊类型处理                                |
|   |   |       +-- btf/              # BTF 类型系统                                |
|   |   |       +-- opt/              # 优化通道                                    |
|   |   |       +-- sanitize/         # 安全检查                                    |
|   |   |       +-- verifier/         # 验证器主逻辑                                |
|   |   |       +-- platform/         # 平台抽象接口                                |
|   |   |                                                                           |
|   |   +-- bpf-verifier-linux/       # Linux 平台实现                              |
|   |   |   |                          Linux platform implementation                |
|   |   |   +-- Cargo.toml                                                          |
|   |   |   +-- src/                                                                |
|   |   |       +-- lib.rs            # Linux 入口                                  |
|   |   |       +-- spec.rs           # LinuxSpec 实现                              |
|   |   |       +-- helper_db.rs      # 211+ Helper 函数定义                        |
|   |   |       +-- prog_types.rs     # 30+ 程序类型定义                            |
|   |   |       +-- kfuncs.rs         # 85+ Kfunc 定义                              |
|   |   |       +-- map_types.rs      # 20+ Map 类型定义                            |
|   |   |       +-- context.rs        # 上下文结构定义                              |
|   |   |       +-- kernel/           # 内核集成 (可选)                             |
|   |   |                                                                           |
|   |   +-- bpf-verifier/             # 便捷包装库                                  |
|   |       |                          Convenience wrapper                          |
|   |       +-- Cargo.toml                                                          |
|   |       +-- src/lib.rs            # 重导出                                      |
|   |       +-- tests/                # 集成测试                                    |
|   |                                                                               |
|   +-- docs/                         # 文档                                        |
|   |   +-- CHANGELOG.md                                                            |
|   |   +-- PERFORMANCE.md                                                          |
|   |   +-- UNSAFE_AUDIT.md                                                         |
|   |   +-- tutorial/                 # 你正在读的教程!                             |
|   |                                                                               |
|   +-- README.md                                                                   |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## 三个 Crate 的关系 | Three Crate Relationships

```
+-----------------------------------------------------------------------------------+
|                              Crate 依赖关系图                                     |
|                         Crate Dependency Diagram                                  |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|                                                                                   |
|                       +------------------------------------+                      |
|                       |                                    |                      |
|                       |        bpf-verifier                |                      |
|                       |        便捷包装库                   |                      |
|                       |                                    |                      |
|                       |   +----------------------------+   |                      |
|                       |   | // 一行代码使用全部功能    |   |                      |
|                       |   | use bpf_verifier::*;       |   |                      |
|                       |   +----------------------------+   |                      |
|                       |                                    |                      |
|                       |   • 重导出 core 和 linux           |                      |
|                       |   • 提供便捷 API                   |                      |
|                       |   • 包含集成测试                   |                      |
|                       |                                    |                      |
|                       +----------------+-------------------+                      |
|                                        |                                          |
|                           +------------+------------+                             |
|                           |                         |                             |
|                           v                         v                             |
|   +------------------------------------+  +------------------------------------+  |
|   |                                    |  |                                    |  |
|   |    bpf-verifier-linux              |  |    bpf-verifier-core               |  |
|   |    Linux 平台实现                   |  |    核心逻辑库                       |  |
|   |                                    |  |                                    |  |
|   | +--------------------------------+ |  | +--------------------------------+ |  |
|   | |                                | |  | |                                | |  |
|   | |  实现平台抽象 trait:           | |  | |  定义平台抽象 trait:           | |  |
|   | |                                | |  | |                                | |  |
|   | |  • PlatformSpec              |----->|  • trait PlatformSpec           | |  |
|   | |  • HelperProvider             | |  | |  • trait HelperProvider        | |  |
|   | |  • ProgTypeProvider           | |  | |  • trait ProgTypeProvider      | |  |
|   | |  • KfuncProvider              | |  | |  • trait KfuncProvider         | |  |
|   | |  • MapProvider                | |  | |  • trait MapProvider           | |  |
|   | |  • ContextProvider            | |  | |  • trait ContextProvider       | |  |
|   | |                                | |  | |                                | |  |
|   | +--------------------------------+ |  | +--------------------------------+ |  |
|   |                                    |  |                                    |  |
|   | +--------------------------------+ |  | +--------------------------------+ |  |
|   | |                                | |  | |                                | |  |
|   | |  Linux 特定内容:               | |  | |  平台无关算法:                 | |  |
|   | |                                | |  | |                                | |  |
|   | |  • 211 个 Helper 函数          | |  | |  • 验证器状态机                | |  |
|   | |  • 30+ 程序类型                | |  | |  • 边界分析                    | |  |
|   | |  • 85+ Kfunc                   | |  | |  • 状态剪枝                    | |  |
|   | |  • 20+ Map 类型                | |  | |  • 内存检查                    | |  |
|   | |  • 上下文结构                  | |  | |  • 类型追踪                    | |  |
|   | |                                | |  | |                                | |  |
|   | +--------------------------------+ |  | +--------------------------------+ |  |
|   |                                    |  |                                    |  |
|   +------------------------------------+  +------------------------------------+  |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### 为什么这样设计？| Why This Design?

```
+-----------------------------------------------------------------------------------+
|                           平台无关设计的优势                                      |
|                   Benefits of Platform-Agnostic Design                            |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   bpf-verifier-core 不依赖任何 Linux 特定的东西，这意味着：                       |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |   1. 跨平台开发和测试                                                  |      |
|   |      -------------------                                               |      |
|   |      可以在 Windows/macOS 上开发和测试验证器逻辑                       |      |
|   |                                                                        |      |
|   |      $ cargo test --package bpf-verifier-core                         |      |
|   |      # 在任何平台上都能跑!                                             |      |
|   |                                                                        |      |
|   |   2. 支持其他操作系统                                                  |      |
|   |      -------------------                                               |      |
|   |      为 FreeBSD/Windows 等实现 BPF 验证器                             |      |
|   |                                                                        |      |
|   |      +------------------+  +------------------+  +------------------+  |      |
|   |      | bpf-verifier-    |  | bpf-verifier-    |  | bpf-verifier-    |  |      |
|   |      | linux            |  | freebsd          |  | windows          |  |      |
|   |      +--------+---------+  +--------+---------+  +--------+---------+  |      |
|   |               |                     |                     |           |      |
|   |               +---------------------+---------------------+           |      |
|   |                                     |                                 |      |
|   |                                     v                                 |      |
|   |                          +------------------+                         |      |
|   |                          | bpf-verifier-    |                         |      |
|   |                          | core             |                         |      |
|   |                          | (共享核心逻辑)    |                         |      |
|   |                          +------------------+                         |      |
|   |                                                                        |      |
|   |   3. 嵌入式运行时                                                      |      |
|   |      ---------------                                                   |      |
|   |      把验证器嵌入非 Linux 的 BPF 运行时（如 uBPF）                     |      |
|   |                                                                        |      |
|   |   4. 更好的测试                                                        |      |
|   |      -----------                                                       |      |
|   |      可以使用简化的 MockPlatform 进行单元测试                          |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   代码示例:                                                                       |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |  // 使用 Linux 平台                                                    |      |
|   |  use bpf_verifier_core::verifier::*;                                   |      |
|   |  use bpf_verifier_linux::LinuxSpec;                                    |      |
|   |                                                                        |      |
|   |  let platform = LinuxSpec::new();                                      |      |
|   |  let env = GenericVerifierEnv::new(platform, insns, prog_type)?;      |      |
|   |                                                                        |      |
|   |  // ----------------------------------------------------------------   |      |
|   |                                                                        |      |
|   |  // 使用你自己的平台                                                   |      |
|   |  use my_platform::MyAwesomeSpec;                                       |      |
|   |                                                                        |      |
|   |  let platform = MyAwesomeSpec::new();                                  |      |
|   |  let env = GenericVerifierEnv::new(platform, insns, prog_type)?;      |      |
|   |  // 同样的验证逻辑，不同的平台!                                        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## bpf-verifier-core 模块详解 | Core Module Details

```
+-----------------------------------------------------------------------------------+
|                         bpf-verifier-core 模块结构                                |
|                      bpf-verifier-core Module Structure                           |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   bpf-verifier-core/src/                                                          |
|   |                                                                               |
|   +-- lib.rs                  # 库入口，模块声明                                  |
|   |                                                                               |
|   +-------------------------------------------------------------------------------|
|   |                                                                               |
|   |   +--------------------------------------------------------------------+      |
|   |   |                     core/ 基础设施                                 |      |
|   |   |                     Foundation Module                               |      |
|   |   +--------------------------------------------------------------------+      |
|   |                                                                               |
|   +-- core/                                                                       |
|   |   +-- mod.rs                                                                  |
|   |   +-- types.rs           # 常量、标志位、基础类型定义                         |
|   |   |                       BPF_ALU, BPF_JMP, 操作码常量等                      |
|   |   +-- insn.rs            # BpfInsn 结构定义                                  |
|   |   |                       指令的编码和解码                                    |
|   |   +-- insn_verify.rs     # 指令合法性检查                                    |
|   |   |                       操作码有效性、寄存器范围等                          |
|   |   +-- disasm.rs          # 反汇编器 (调试用)                                 |
|   |   |                       将字节码转为可读格式                                |
|   |   +-- error.rs           # 错误类型定义                                      |
|   |   |                       VerifierError 枚举                                  |
|   |   +-- log.rs             # 日志系统                                          |
|   |                           验证过程的详细日志                                  |
|   |                                                                               |
|   +-------------------------------------------------------------------------------|
|   |                                                                               |
|   |   +--------------------------------------------------------------------+      |
|   |   |                     state/ 状态管理                                |      |
|   |   |                     State Management                                |      |
|   |   +--------------------------------------------------------------------+      |
|   |                                                                               |
|   +-- state/                                                                      |
|   |   +-- mod.rs                                                                  |
|   |   +-- reg_state.rs       # 寄存器状态 (核心!)                                |
|   |   |                       BpfRegState, BpfRegType                             |
|   |   |                       每个寄存器的类型和值范围                            |
|   |   +-- stack_state.rs     # 栈状态                                            |
|   |   |                       栈槽的类型追踪                                      |
|   |   +-- verifier_state.rs  # 整体验证器状态 (核心!)                            |
|   |   |                       BpfVerifierState                                    |
|   |   |                       寄存器 + 栈 + 引用 的完整快照                       |
|   |   +-- reference.rs       # 引用追踪                                          |
|   |   |                       追踪资源的获取和释放                                |
|   |   +-- lock_state.rs      # 锁状态追踪                                        |
|   |   |                       bpf_spin_lock 等                                    |
|   |   +-- idmap.rs           # ID 映射 (用于剪枝)                                |
|   |   |                       状态比较时的 ID 规范化                              |
|   |   +-- snapshot.rs        # 状态快照                                          |
|   |   |                       保存和恢复状态                                      |
|   |   +-- spill_fill.rs      # 寄存器溢出/恢复                                   |
|   |                           寄存器存到栈上再读回来                              |
|   |                                                                               |
|   +-------------------------------------------------------------------------------|
|   |                                                                               |
|   |   +--------------------------------------------------------------------+      |
|   |   |                     bounds/ 边界分析                               |      |
|   |   |                     Bounds Analysis                                 |      |
|   |   +--------------------------------------------------------------------+      |
|   |                                                                               |
|   +-- bounds/                                                                     |
|   |   +-- mod.rs                                                                  |
|   |   +-- scalar.rs          # 标量边界 (核心!)                                  |
|   |   |                       umin/umax, smin/smax                                |
|   |   |                       无符号和有符号范围追踪                              |
|   |   +-- tnum.rs            # Tracked Number (核心!)                            |
|   |   |                       位级别的值追踪                                      |
|   |   |                       知道哪些位是确定的                                  |
|   |   +-- range_refine.rs    # 范围细化                                          |
|   |   |                       条件跳转后收窄范围                                  |
|   |   +-- insn_bounds.rs     # 指令级边界更新                                    |
|   |                           ADD/SUB/AND 等对边界的影响                          |
|   |                                                                               |
|   +-------------------------------------------------------------------------------|
|   |                                                                               |
|   |   +--------------------------------------------------------------------+      |
|   |   |                     analysis/ 程序分析                             |      |
|   |   |                     Program Analysis                                |      |
|   |   +--------------------------------------------------------------------+      |
|   |                                                                               |
|   +-- analysis/                                                                   |
|   |   +-- mod.rs                                                                  |
|   |   +-- cfg.rs             # 控制流图                                          |
|   |   |                       基本块和边的构建                                    |
|   |   +-- scc.rs             # 强连通分量                                        |
|   |   |                       循环检测                                            |
|   |   +-- prune.rs           # 状态剪枝 (核心!)                                  |
|   |   |                       避免重复验证等价状态                                |
|   |   +-- states_equal.rs    # 状态等价性判断                                    |
|   |   |                       两个状态是否可以剪枝                                |
|   |   +-- precision.rs       # 精度传播                                          |
|   |   |                       哪些值需要精确追踪                                  |
|   |   +-- liveness.rs        # 活性分析                                          |
|   |   |                       哪些寄存器会被使用                                  |
|   |   +-- state_merge.rs     # 状态合并                                          |
|   |   |                       多路径汇合点的处理                                  |
|   |   +-- loop_check.rs      # 循环检查                                          |
|   |   |                       有界循环验证                                        |
|   |   +-- leak_detector.rs   # 资源泄漏检测                                      |
|   |   |                       引用未释放                                          |
|   |   +-- race_detector.rs   # 竞态检测                                          |
|   |                           并发访问问题                                        |
|   |                                                                               |
|   +-------------------------------------------------------------------------------|
|   |                                                                               |
|   |   +--------------------------------------------------------------------+      |
|   |   |                     check/ 指令检查                                |      |
|   |   |                     Instruction Checking                            |      |
|   |   +--------------------------------------------------------------------+      |
|   |                                                                               |
|   +-- check/                                                                      |
|   |   +-- mod.rs                                                                  |
|   |   +-- alu.rs             # 算术/逻辑指令                                     |
|   |   |                       ADD, SUB, MUL, DIV, AND, OR, ...                    |
|   |   +-- load_store.rs      # 内存访问指令                                      |
|   |   |                       LDX, STX, LD_IMM64, ...                             |
|   |   +-- jump.rs            # 跳转指令                                          |
|   |   |                       JEQ, JNE, JGT, JA, ...                              |
|   |   +-- atomic.rs          # 原子指令                                          |
|   |   |                       XADD, XCHG, CMPXCHG, ...                            |
|   |   +-- helper.rs          # Helper 函数调用                                   |
|   |   |                       参数类型检查、返回值处理                            |
|   |   +-- kfunc.rs           # Kfunc 调用                                        |
|   |   |                       内核函数调用验证                                    |
|   |   +-- subprog.rs         # 子程序调用                                        |
|   |   |                       BPF-to-BPF 函数调用                                 |
|   |   +-- callback.rs        # 回调验证                                          |
|   |   |                       bpf_for_each_map_elem 等                            |
|   |   +-- retval.rs          # 返回值检查                                        |
|   |                           程序返回值类型验证                                  |
|   |                                                                               |
|   +-------------------------------------------------------------------------------|
|   |                                                                               |
|   |   +--------------------------------------------------------------------+      |
|   |   |                     mem/ 内存访问                                  |      |
|   |   |                     Memory Access                                   |      |
|   |   +--------------------------------------------------------------------+      |
|   |                                                                               |
|   +-- mem/                                                                        |
|   |   +-- mod.rs                                                                  |
|   |   +-- memory.rs          # 内存访问验证主逻辑                                |
|   |   |                       check_mem_access() 入口                             |
|   |   +-- stack_access.rs    # 栈访问                                            |
|   |   |                       R10 + offset 范围检查                               |
|   |   +-- packet.rs          # 数据包访问                                        |
|   |   |                       data/data_end 边界检查                              |
|   |   +-- context.rs         # 上下文访问                                        |
|   |   |                       程序类型特定的字段访问                              |
|   |   +-- arena.rs           # Arena 内存                                        |
|   |   |                       bpf_arena 访问验证                                  |
|   |   +-- user.rs            # 用户空间内存                                      |
|   |                           bpf_probe_read_user 等                              |
|   |                                                                               |
|   +-------------------------------------------------------------------------------|
|   |                                                                               |
|   |   +--------------------------------------------------------------------+      |
|   |   |                     其他模块                                       |      |
|   |   |                     Other Modules                                   |      |
|   |   +--------------------------------------------------------------------+      |
|   |                                                                               |
|   +-- special/               # 特殊类型处理                                      |
|   |   +-- dynptr.rs          # 动态指针                                          |
|   |   +-- iter.rs            # 迭代器                                            |
|   |   +-- map_ops.rs         # Map 操作                                          |
|   |   +-- ...                                                                     |
|   |                                                                               |
|   +-- btf/                   # BTF 类型系统                                      |
|   |   +-- core.rs            # BTF 解析                                          |
|   |   +-- validation.rs      # 类型验证                                          |
|   |                                                                               |
|   +-- opt/                   # 优化                                              |
|   |   +-- dead_code.rs       # 死代码消除                                        |
|   |   +-- patching.rs        # 指令修补                                          |
|   |                                                                               |
|   +-- sanitize/              # 安全检查                                          |
|   |   +-- spectre.rs         # Spectre 缓解                                      |
|   |   +-- overflow.rs        # 溢出检查                                          |
|   |                                                                               |
|   +-- verifier/              # 验证器主体                                        |
|   |   +-- mod.rs                                                                  |
|   |   +-- env.rs             # 验证器环境                                        |
|   |   +-- generic_env.rs     # 泛型环境                                          |
|   |   +-- generic_verifier.rs# 泛型验证器                                        |
|   |   +-- main_loop.rs       # 主验证循环 (核心!)                                |
|   |   |                       do_check() 函数                                     |
|   |   +-- branch_state.rs    # 分支状态管理                                      |
|   |   +-- worklist.rs        # 工作列表                                          |
|   |                                                                               |
|   +-- platform/              # 平台抽象                                          |
|       +-- mod.rs                                                                  |
|       +-- spec.rs            # PlatformSpec trait                                 |
|       +-- helper.rs          # HelperProvider trait                               |
|       +-- prog_type.rs       # ProgTypeProvider trait                             |
|       +-- kfunc.rs           # KfuncProvider trait                                |
|       +-- map.rs             # MapProvider trait                                  |
|       +-- context.rs         # ContextProvider trait                              |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## 核心数据流 | Core Data Flow

```
+-----------------------------------------------------------------------------------+
|                             验证器数据流                                          |
|                        Verifier Data Flow                                         |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                           输入                                         |      |
|   |                          Input                                         |      |
|   |                                                                        |      |
|   |   +------------------+   +------------------+   +------------------+   |      |
|   |   |  BPF 指令序列    |   |    程序类型      |   |   平台规范       |   |      |
|   |   | Vec<BpfInsn>     |   |   ProgType       |   |  PlatformSpec    |   |      |
|   |   +--------+---------+   +--------+---------+   +--------+---------+   |      |
|   |            |                      |                      |            |      |
|   +------------+----------------------+----------------------+------------+      |
|                |                      |                      |                    |
|                +----------------------+----------------------+                    |
|                                       |                                           |
|                                       v                                           |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |                    GenericVerifierEnv<P>                               |      |
|   |                       验证器环境                                       |      |
|   |                                                                        |      |
|   |   +----------------------------------------------------------------+   |      |
|   |   |                                                                |   |      |
|   |   |   +------------------+     +-------------------------------+   |   |      |
|   |   |   |  PlatformSpec    |     |     BpfVerifierState          |   |   |      |
|   |   |   |  (Linux/...)     |     |                               |   |   |      |
|   |   |   |                  |     |  +-----------------------+    |   |   |      |
|   |   |   |  • Helper 信息   |     |  |   寄存器状态          |    |   |   |      |
|   |   |   |  • 程序类型信息  |     |  |   [BpfRegState; 11]   |    |   |   |      |
|   |   |   |  • Kfunc 信息    |     |  +-----------------------+    |   |   |      |
|   |   |   |  • Map 类型信息  |     |                               |   |   |      |
|   |   |   |                  |     |  +-----------------------+    |   |   |      |
|   |   |   +------------------+     |  |     栈状态            |    |   |   |      |
|   |   |                            |  |   BpfStackState       |    |   |   |      |
|   |   |                            |  +-----------------------+    |   |   |      |
|   |   |                            |                               |   |   |      |
|   |   |                            |  +-----------------------+    |   |   |      |
|   |   |                            |  |    引用追踪           |    |   |   |      |
|   |   |                            |  |   acquired_refs       |    |   |   |      |
|   |   |                            |  +-----------------------+    |   |   |      |
|   |   |                            |                               |   |   |      |
|   |   |                            +-------------------------------+   |   |      |
|   |   |                                                                |   |      |
|   |   |   +--------------------------------------------------------+   |   |      |
|   |   |   |                   StateCache                           |   |   |      |
|   |   |   |                   状态缓存                             |   |   |      |
|   |   |   |                                                        |   |   |      |
|   |   |   |   用于剪枝优化:                                        |   |   |      |
|   |   |   |   • 保存每个程序点的历史状态                           |   |   |      |
|   |   |   |   • 如果新状态被历史状态覆盖，跳过验证                 |   |   |      |
|   |   |   |                                                        |   |   |      |
|   |   |   +--------------------------------------------------------+   |   |      |
|   |   |                                                                |   |      |
|   |   +----------------------------------------------------------------+   |      |
|   |                                                                        |      |
|   +--------------------------------------+---------------------------------+      |
|                                          |                                        |
|                                          v                                        |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |                   GenericMainVerifier<P>                               |      |
|   |                      主验证循环                                        |      |
|   |                                                                        |      |
|   |   +----------------------------------------------------------------+   |      |
|   |   |                                                                |   |      |
|   |   |   do_check() 主循环:                                           |   |      |
|   |   |                                                                |   |      |
|   |   |   while 有待验证的状态:                                        |   |      |
|   |   |       |                                                        |   |      |
|   |   |       +--> 1. 获取当前指令                                     |   |      |
|   |   |       |                                                        |   |      |
|   |   |       +--> 2. 检查指令合法性                                   |   |      |
|   |   |       |       check_insn()                                     |   |      |
|   |   |       |                                                        |   |      |
|   |   |       +--> 3. 更新寄存器状态                                   |   |      |
|   |   |       |       adjust_reg_min_max()                             |   |      |
|   |   |       |                                                        |   |      |
|   |   |       +--> 4. 检查内存访问 (如果有)                            |   |      |
|   |   |       |       check_mem_access()                               |   |      |
|   |   |       |                                                        |   |      |
|   |   |       +--> 5. 处理分支                                         |   |      |
|   |   |       |       push_branch_state()                              |   |      |
|   |   |       |                                                        |   |      |
|   |   |       +--> 6. 尝试剪枝                                         |   |      |
|   |   |               states_maybe_looping()                           |   |      |
|   |   |                                                                |   |      |
|   |   +----------------------------------------------------------------+   |      |
|   |                                                                        |      |
|   +--------------------------------------+---------------------------------+      |
|                                          |                                        |
|                                          v                                        |
|   +------------------------------------------------------------------------+      |
|   |                           输出                                         |      |
|   |                          Output                                        |      |
|   |                                                                        |      |
|   |   +----------------------------------------------------------------+   |      |
|   |   |                                                                |   |      |
|   |   |   Result<VerifiedProgram, VerifierError>                       |   |      |
|   |   |                                                                |   |      |
|   |   |   +---------------------+     +-----------------------------+  |   |      |
|   |   |   |    Ok(...)          |     |     Err(...)                |  |   |      |
|   |   |   |                     |     |                             |  |   |      |
|   |   |   |  程序安全!          |     |  验证失败                   |  |   |      |
|   |   |   |                     |     |                             |  |   |      |
|   |   |   |  可以JIT编译并      |     |  • 越界访问                 |  |   |      |
|   |   |   |  在内核中运行       |     |  • 类型错误                 |  |   |      |
|   |   |   |                     |     |  • 无限循环                 |  |   |      |
|   |   |   |                     |     |  • 资源泄漏                 |  |   |      |
|   |   |   |                     |     |  • ...                      |  |   |      |
|   |   |   +---------------------+     +-----------------------------+  |   |      |
|   |   |                                                                |   |      |
|   |   +----------------------------------------------------------------+   |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## 代码定位指南 | Code Location Guide

```
+-----------------------------------------------------------------------------------+
|                              代码定位指南                                         |
|                         Code Location Guide                                       |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                         按功能查找                                     |      |
|   |                       Find by Feature                                  |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +-------------------------------+-----------------------------------------+     |
|   | 你想了解...                   | 去看这个文件                            |     |
|   +-------------------------------+-----------------------------------------+     |
|   | 寄存器怎么追踪的              | state/reg_state.rs                      |     |
|   | 边界怎么计算的                | bounds/scalar.rs, bounds/tnum.rs        |     |
|   | 状态怎么剪枝的                | analysis/prune.rs                       |     |
|   | 内存访问怎么检查的            | mem/memory.rs                           |     |
|   | 验证主循环在哪                | verifier/main_loop.rs                   |     |
|   | Helper 函数定义               | linux/src/helper_db.rs                  |     |
|   | 程序类型定义                  | linux/src/prog_types.rs                 |     |
|   | 条件跳转怎么细化范围          | bounds/range_refine.rs                  |     |
|   | 平台抽象接口                  | platform/spec.rs                        |     |
|   | 错误类型有哪些                | core/error.rs                           |     |
|   +-------------------------------+-----------------------------------------+     |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                       按指令类型查找                                   |      |
|   |                    Find by Instruction Type                            |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +-------------------------------+-----------------------------------------+     |
|   | 指令类型                      | 处理文件                                |     |
|   +-------------------------------+-----------------------------------------+     |
|   | ADD/SUB/MUL/DIV...            | check/alu.rs                            |     |
|   | LDX/STX                       | check/load_store.rs                     |     |
|   | JMP/JEQ/JNE/JGT...            | check/jump.rs                           |     |
|   | CALL (helper)                 | check/helper.rs                         |     |
|   | CALL (kfunc)                  | check/kfunc.rs                          |     |
|   | CALL (BPF func)               | check/subprog.rs                        |     |
|   | XADD/XCHG/CMPXCHG             | check/atomic.rs                         |     |
|   | EXIT                          | check/retval.rs                         |     |
|   +-------------------------------+-----------------------------------------+     |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                       按错误类型查找                                   |      |
|   |                     Find by Error Type                                 |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +-------------------------------+-----------------------------------------+     |
|   | 错误类型                      | 相关文件                                |     |
|   +-------------------------------+-----------------------------------------+     |
|   | 内存越界访问                  | mem/memory.rs, bounds/*                 |     |
|   | 无限循环                      | analysis/loop_check.rs                  |     |
|   | 类型错误                      | state/reg_state.rs                      |     |
|   | 资源泄漏                      | analysis/leak_detector.rs               |     |
|   | 除以零                        | check/alu.rs                            |     |
|   | 未初始化读取                  | state/reg_state.rs                      |     |
|   | Helper 参数错误               | check/helper.rs                         |     |
|   | 栈溢出                        | mem/stack_access.rs                     |     |
|   +-------------------------------+-----------------------------------------+     |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## Rust 特性说明 | Rust Features Used

```
+-----------------------------------------------------------------------------------+
|                           项目使用的 Rust 特性                                    |
|                        Rust Features Used in Project                              |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                            1. #![no_std]                               |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |  // 不使用标准库，只用 core 和 alloc                                   |      |
|   |  // 这样可以在内核中运行                                               |      |
|   |                                                                        |      |
|   |  #![no_std]                                                            |      |
|   |  extern crate alloc;                                                   |      |
|   |                                                                        |      |
|   |  use alloc::vec::Vec;                                                  |      |
|   |  use alloc::string::String;                                            |      |
|   |  use core::mem;                                                        |      |
|   |                                                                        |      |
|   |  // Vec, String 等可以用，但来自 alloc 而不是 std                      |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                         2. 泛型和 Trait                                |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |  // PlatformSpec 是一个 trait（接口定义）                              |      |
|   |  pub trait PlatformSpec {                                              |      |
|   |      type Helper: HelperProvider;                                      |      |
|   |      type ProgType: ProgTypeProvider;                                  |      |
|   |      type Kfunc: KfuncProvider;                                        |      |
|   |      type Map: MapProvider;                                            |      |
|   |      type Context: ContextProvider;                                    |      |
|   |      // ...                                                            |      |
|   |  }                                                                     |      |
|   |                                                                        |      |
|   |  // LinuxSpec 实现了这个 trait                                         |      |
|   |  impl PlatformSpec for LinuxSpec {                                     |      |
|   |      type Helper = LinuxHelperProvider;                                |      |
|   |      type ProgType = LinuxProgTypeProvider;                            |      |
|   |      // ...                                                            |      |
|   |  }                                                                     |      |
|   |                                                                        |      |
|   |  // 验证器用泛型，可以用任何平台                                       |      |
|   |  pub struct GenericVerifierEnv<P: PlatformSpec> {                      |      |
|   |      platform: P,                                                      |      |
|   |      state: BpfVerifierState,                                          |      |
|   |      // ...                                                            |      |
|   |  }                                                                     |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                           3. bitflags 宏                               |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |  // 使用 bitflags 宏定义标志位集合                                     |      |
|   |  bitflags! {                                                           |      |
|   |      pub struct BpfTypeFlag: u32 {                                     |      |
|   |          const PTR_MAYBE_NULL = 1 << 0;  // 指针可能为 NULL            |      |
|   |          const MEM_RDONLY = 1 << 1;      // 内存只读                   |      |
|   |          const MEM_RINGBUF = 1 << 2;     // 环形缓冲区内存             |      |
|   |          const MEM_USER = 1 << 3;        // 用户空间内存               |      |
|   |          // ...                                                        |      |
|   |      }                                                                 |      |
|   |  }                                                                     |      |
|   |                                                                        |      |
|   |  // 使用方式                                                           |      |
|   |  let flags = BpfTypeFlag::PTR_MAYBE_NULL | BpfTypeFlag::MEM_RDONLY;    |      |
|   |  if flags.contains(BpfTypeFlag::PTR_MAYBE_NULL) {                      |      |
|   |      // 需要 NULL 检查                                                 |      |
|   |  }                                                                     |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                         4. 结构体和枚举                                |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |  // 寄存器类型是一个枚举                                               |      |
|   |  #[derive(Debug, Clone, Copy, PartialEq, Eq)]                          |      |
|   |  pub enum BpfRegType {                                                 |      |
|   |      NotInit,           // 未初始化                                    |      |
|   |      ScalarValue,       // 标量（数字）                                |      |
|   |      PtrToCtx,          // 指向上下文的指针                            |      |
|   |      PtrToStack,        // 指向栈的指针                                |      |
|   |      PtrToMapKey,       // 指向 map key 的指针                         |      |
|   |      PtrToMapValue,     // 指向 map value 的指针                       |      |
|   |      PtrToMapValueOrNull, // 可能为 NULL 的 map value 指针             |      |
|   |      // ... 还有很多种指针类型                                         |      |
|   |  }                                                                     |      |
|   |                                                                        |      |
|   |  // #[derive(...)] 自动实现常用 trait                                  |      |
|   |  // Debug: 可以用 {:?} 格式化                                          |      |
|   |  // Clone: 可以调用 .clone()                                           |      |
|   |  // Copy: 可以按值复制（不需要 clone）                                 |      |
|   |  // PartialEq, Eq: 可以用 == 比较                                      |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## 章节小结 | Chapter Summary

```
+-----------------------------------------------------------------------------------+
|                                 本章要点                                          |
|                             Key Takeaways                                         |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   你现在知道了:                                                                   |
|                                                                                   |
|   1. 三个 Crate 的职责                                                            |
|      • bpf-verifier-core: 平台无关的核心验证逻辑                                  |
|      • bpf-verifier-linux: Linux 平台的具体实现                                   |
|      • bpf-verifier: 便捷的包装库                                                 |
|                                                                                   |
|   2. 核心模块划分                                                                 |
|      • core: 基础类型和指令定义                                                   |
|      • state: 寄存器和栈状态管理                                                  |
|      • bounds: 数值范围分析                                                       |
|      • analysis: 静态分析算法                                                     |
|      • check: 各类指令的验证                                                      |
|      • mem: 内存访问验证                                                          |
|      • verifier: 主验证循环                                                       |
|      • platform: 平台抽象接口                                                     |
|                                                                                   |
|   3. 数据流向                                                                     |
|      指令 -> 环境 -> 验证器 -> 结果                                               |
|                                                                                   |
|   4. 如何快速定位代码                                                             |
|      按功能、按指令类型、按错误类型查找                                           |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## 练习 | Exercises

1. 打开 `crates/bpf-verifier-core/src/lib.rs`，看看声明了哪些模块

2. 找到 `BpfRegState` 结构体，记录它有哪些主要字段

3. 找到 `LinuxSpec` 实现，看看它实现了哪些 trait 方法

4. 在 `check/` 目录下，找到处理 `ADD` 指令的代码位置

---

[⬅️ 上一章：为什么需要验证器？](03-why-verifier.md) | [返回目录](00-introduction.md) | [下一章：核心数据结构 ➡️](05-core-data-structures.md)
