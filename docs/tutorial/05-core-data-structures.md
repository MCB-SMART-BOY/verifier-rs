# ç¬¬äº”ç« ï¼šæ ¸å¿ƒæ•°æ®ç»“æ„ | Chapter 5: Core Data Structures

```
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   "æ•°æ®ç»“æ„æ˜¯ç¨‹åºçš„éª¨æ¶ï¼Œç®—æ³•æ˜¯ç¨‹åºçš„çµé­‚"                                        |
|   "Data structures are the skeleton of a program,                                 |
|    algorithms are the soul"                                                       |
|                                                                                   |
|   ç†è§£äº†æ•°æ®ç»“æ„ï¼Œä»£ç å°±è‡ªç„¶è¯»æ‡‚äº†ã€‚                                              |
|   Understand the data structures, and the code becomes clear.                     |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

## ğŸ¯ æœ¬ç« ç›®æ ‡ | Chapter Goals

å­¦å®Œè¿™ç« ï¼Œä½ ä¼šç†è§£ï¼š
- éªŒè¯å™¨å¦‚ä½•è¡¨ç¤ºå¯„å­˜å™¨çŠ¶æ€ (Register state representation)
- éªŒè¯å™¨å¦‚ä½•è¿½è¸ªæ•°å€¼èŒƒå›´ (Numeric bounds tracking)
- Tnum å¦‚ä½•ç²¾ç¡®è¿½è¸ªä½çº§åˆ«ä¿¡æ¯ (Bit-level tracking with Tnum)
- éªŒè¯å™¨å¦‚ä½•ç®¡ç†æ•´ä½“çŠ¶æ€ (Overall state management)
- è¿™äº›æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³» (Relationships between structures)

---

## ğŸ“Š æ•°æ®ç»“æ„æ€»è§ˆ | Data Structure Overview

```
+-----------------------------------------------------------------------------------+
|                           æ ¸å¿ƒæ•°æ®ç»“æ„å±‚æ¬¡å›¾                                      |
|                       Core Data Structure Hierarchy                               |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +----------------------------------------------------------------------------+  |
|   |                        GenericVerifierEnv<P>                               |  |
|   |                        (éªŒè¯å™¨ç¯å¢ƒ | Verifier Environment)                 |  |
|   |                                                                            |  |
|   |   +--------------------------------------------------------------------+   |  |
|   |   |                     BpfVerifierState                               |   |  |
|   |   |                     (éªŒè¯å™¨çŠ¶æ€ | Verifier State)                  |   |  |
|   |   |                                                                    |   |  |
|   |   |   +------------------------------------------------------------+   |   |  |
|   |   |   |                 BpfFuncState [8 å¸§]                        |   |   |  |
|   |   |   |                 (å‡½æ•°å¸§çŠ¶æ€ | Function Frame State)        |   |   |  |
|   |   |   |                                                            |   |   |  |
|   |   |   |   +--------------------------------------------------+     |   |   |  |
|   |   |   |   |            BpfRegState [11 ä¸ªå¯„å­˜å™¨]             |     |   |   |  |
|   |   |   |   |            (å¯„å­˜å™¨çŠ¶æ€ | Register State)         |     |   |   |  |
|   |   |   |   |                                                  |     |   |   |  |
|   |   |   |   |   +------------------------------------------+   |     |   |   |  |
|   |   |   |   |   |  ScalarBounds                            |   |     |   |   |  |
|   |   |   |   |   |  +-- umin/umax (æ— ç¬¦å·è¾¹ç•Œ)              |   |     |   |   |  |
|   |   |   |   |   |  +-- smin/smax (æœ‰ç¬¦å·è¾¹ç•Œ)              |   |     |   |   |  |
|   |   |   |   |   |  +-- Tnum (ä½çº§åˆ«è¿½è¸ª)                   |   |     |   |   |  |
|   |   |   |   |   +------------------------------------------+   |     |   |   |  |
|   |   |   |   |                                                  |     |   |   |  |
|   |   |   |   +--------------------------------------------------+     |   |   |  |
|   |   |   |                                                            |   |   |  |
|   |   |   |   +--------------------------------------------------+     |   |   |  |
|   |   |   |   |            BpfStackState [512 å­—èŠ‚]              |     |   |   |  |
|   |   |   |   |            (æ ˆçŠ¶æ€ | Stack State)                |     |   |   |  |
|   |   |   |   |                                                  |     |   |   |  |
|   |   |   |   |   +------------------------------------------+   |     |   |   |  |
|   |   |   |   |   |  BpfStackSlot [64 ä¸ªæ§½]                  |   |     |   |   |  |
|   |   |   |   |   |  (æ ˆæ§½ | Stack Slots)                    |   |     |   |   |  |
|   |   |   |   |   +------------------------------------------+   |     |   |   |  |
|   |   |   |   |                                                  |     |   |   |  |
|   |   |   |   +--------------------------------------------------+     |   |   |  |
|   |   |   |                                                            |   |   |  |
|   |   |   +------------------------------------------------------------+   |   |  |
|   |   |                                                                    |   |  |
|   |   |   refs: Vec<BpfReference>      (å¼•ç”¨è¿½è¸ª | Reference tracking)     |   |  |
|   |   |   active_locks: u32            (é”çŠ¶æ€ | Lock state)               |   |  |
|   |   |                                                                    |   |  |
|   |   +--------------------------------------------------------------------+   |  |
|   |                                                                            |  |
|   |   insns: Vec<BpfInsn>              (æŒ‡ä»¤åºåˆ— | Instructions)              |  |
|   |   insn_aux: Vec<InsnAuxData>       (è¾…åŠ©æ•°æ® | Auxiliary data)            |  |
|   |   state_cache: StateCache          (çŠ¶æ€ç¼“å­˜ | State cache)               |  |
|   |                                                                            |  |
|   +----------------------------------------------------------------------------+  |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ“ BpfRegStateï¼šå¯„å­˜å™¨çŠ¶æ€ | Register State

è¿™æ˜¯æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„ï¼Œè¿½è¸ªæ¯ä¸ªå¯„å­˜å™¨çš„ç±»å‹å’Œå€¼èŒƒå›´ã€‚

### ç»“æ„å®šä¹‰ | Structure Definition

```rust
// æ–‡ä»¶ï¼šcrates/bpf-verifier-core/src/state/reg_state.rs

/// BPF å¯„å­˜å™¨çŠ¶æ€ - è¿½è¸ªå•ä¸ªå¯„å­˜å™¨çš„å®Œæ•´ä¿¡æ¯
/// BPF register state - tracks complete information for a single register
#[derive(Debug, Clone)]
pub struct BpfRegState {
    // -----------------------------------------------------------
    // ç±»å‹ä¿¡æ¯ | Type Information
    // -----------------------------------------------------------
    
    /// å¯„å­˜å™¨ç±»å‹ï¼ˆæ ‡é‡ã€å„ç§æŒ‡é’ˆç±»å‹ã€æœªåˆå§‹åŒ–...ï¼‰
    /// Register type (scalar, various pointer types, uninitialized...)
    pub reg_type: BpfRegType,
    
    /// ç±»å‹æ ‡å¿—ï¼ˆå¯ç©ºã€åªè¯»ã€å¯ä¿¡ä»»...ï¼‰
    /// Type flags (nullable, read-only, trusted...)
    pub type_flags: BpfTypeFlag,
    
    // -----------------------------------------------------------
    // 64ä½æ•°å€¼è¾¹ç•Œ | 64-bit Numeric Bounds
    // -----------------------------------------------------------
    
    /// 64ä½æ— ç¬¦å·æœ€å°å€¼ (0 â‰¤ value)
    pub umin_value: u64,
    
    /// 64ä½æ— ç¬¦å·æœ€å¤§å€¼ (value â‰¤ 2^64-1)
    pub umax_value: u64,
    
    /// 64ä½æœ‰ç¬¦å·æœ€å°å€¼ (-2^63 â‰¤ value)
    pub smin_value: i64,
    
    /// 64ä½æœ‰ç¬¦å·æœ€å¤§å€¼ (value â‰¤ 2^63-1)
    pub smax_value: i64,
    
    // -----------------------------------------------------------
    // 32ä½æ•°å€¼è¾¹ç•Œ | 32-bit Numeric Bounds
    // -----------------------------------------------------------
    
    /// 32ä½æ— ç¬¦å·è¾¹ç•Œ (ç”¨äº 32 ä½æ“ä½œ)
    pub u32_min_value: u32,
    pub u32_max_value: u32,
    
    /// 32ä½æœ‰ç¬¦å·è¾¹ç•Œ
    pub s32_min_value: i32,
    pub s32_max_value: i32,
    
    // -----------------------------------------------------------
    // ä½çº§åˆ«è¿½è¸ª | Bit-level Tracking
    // -----------------------------------------------------------
    
    /// Tnumï¼šç²¾ç¡®è¿½è¸ªå“ªäº›ä½æ˜¯å·²çŸ¥çš„
    /// Tnum: precisely tracks which bits are known
    pub var_off: Tnum,
    
    // -----------------------------------------------------------
    // æŒ‡é’ˆä¿¡æ¯ | Pointer Information
    // -----------------------------------------------------------
    
    /// ç›¸å¯¹äºåŸºå€çš„é™æ€åç§» (ç¼–è¯‘æ—¶å·²çŸ¥)
    /// Static offset from base (known at compile time)
    pub off: i32,
    
    /// å”¯ä¸€ IDï¼ˆç”¨äºå…³è”è¿½è¸ªï¼Œå¦‚æ¡ä»¶åˆ†æ”¯ï¼‰
    /// Unique ID (for correlation tracking, e.g., conditional branches)
    pub id: u32,
    
    /// å¼•ç”¨å¯¹è±¡ IDï¼ˆå¦‚æœæŒæœ‰å¼•ç”¨ï¼‰
    /// Reference object ID (if holding a reference)
    pub ref_obj_id: u32,
    
    // -----------------------------------------------------------
    // ç²¾åº¦è¿½è¸ª | Precision Tracking
    // -----------------------------------------------------------
    
    /// è¿™ä¸ªå¯„å­˜å™¨æ˜¯å¦éœ€è¦ç²¾ç¡®è¿½è¸ªï¼ˆç”¨äºå‰ªæï¼‰
    /// Whether this register needs precise tracking (for pruning)
    pub precise: bool,
}
```

### å¯„å­˜å™¨ç±»å‹è¯¦è§£ | Register Types Explained

```
+-----------------------------------------------------------------------------------+
|                             BpfRegType å¯„å­˜å™¨ç±»å‹                                 |
|                             Register Type Categories                              |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +----------------------------------------------------------------------------+  |
|   |                            ç‰¹æ®Šç±»å‹ | Special Types                       |  |
|   +----------------------------------------------------------------------------+  |
|   |  NotInit        | æœªåˆå§‹åŒ–ï¼Œè¯»å–ä¼šæŠ¥é”™                                     |  |
|   |                 | Uninitialized, reading causes error                      |  |
|   +-----------------+----------------------------------------------------------+  |
|   |  ScalarValue    | æ™®é€šæ ‡é‡å€¼ï¼ˆæ•°å­—ï¼‰ï¼Œå¯ä»¥å‚ä¸è¿ç®—                         |  |
|   |                 | Plain scalar (number), can participate in operations     |  |
|   +-----------------+----------------------------------------------------------+  |
|                                                                                   |
|   +----------------------------------------------------------------------------+  |
|   |                         å†…æ ¸æŒ‡é’ˆç±»å‹ | Kernel Pointer Types                |  |
|   +----------------------------------------------------------------------------+  |
|   |  PtrToCtx       | æŒ‡å‘ç¨‹åºä¸Šä¸‹æ–‡ (R1 åˆå§‹å€¼)                               |  |
|   |                 | Points to program context (initial R1 value)             |  |
|   +-----------------+----------------------------------------------------------+  |
|   |  PtrToStack     | æŒ‡å‘ BPF æ ˆ (R10 çš„ç±»å‹)                                 |  |
|   |                 | Points to BPF stack (R10's type)                         |  |
|   +-----------------+----------------------------------------------------------+  |
|   |  PtrToMapKey    | æŒ‡å‘ map çš„ key                                          |  |
|   |                 | Points to map key                                        |  |
|   +-----------------+----------------------------------------------------------+  |
|   |  PtrToMapValue  | æŒ‡å‘ map çš„ value (map_lookup_elem è¿”å›å€¼)               |  |
|   |                 | Points to map value (map_lookup_elem return value)       |  |
|   +-----------------+----------------------------------------------------------+  |
|                                                                                   |
|   +----------------------------------------------------------------------------+  |
|   |                         ç½‘ç»œæŒ‡é’ˆç±»å‹ | Network Pointer Types               |  |
|   +----------------------------------------------------------------------------+  |
|   |  PtrToPacket    | æŒ‡å‘ç½‘ç»œåŒ…æ•°æ®èµ·å§‹ä½ç½®                                   |  |
|   |                 | Points to start of packet data                           |  |
|   +-----------------+----------------------------------------------------------+  |
|   |  PtrToPacketEnd | æŒ‡å‘ç½‘ç»œåŒ…æ•°æ®ç»“æŸä½ç½®                                   |  |
|   |                 | Points to end of packet data                             |  |
|   +-----------------+----------------------------------------------------------+  |
|   |  PtrToPacketMeta| æŒ‡å‘ç½‘ç»œåŒ…å…ƒæ•°æ®                                         |  |
|   |                 | Points to packet metadata                                |  |
|   +-----------------+----------------------------------------------------------+  |
|                                                                                   |
|   +----------------------------------------------------------------------------+  |
|   |                         å†…å­˜æŒ‡é’ˆç±»å‹ | Memory Pointer Types                |  |
|   +----------------------------------------------------------------------------+  |
|   |  PtrToMem       | æŒ‡å‘é€šç”¨å†…å­˜åŒºåŸŸ (æœ‰ BTF ç±»å‹ä¿¡æ¯)                       |  |
|   |                 | Points to generic memory (with BTF type info)            |  |
|   +-----------------+----------------------------------------------------------+  |
|   |  PtrToBuf       | æŒ‡å‘ç¼“å†²åŒº                                               |  |
|   |                 | Points to buffer                                         |  |
|   +-----------------+----------------------------------------------------------+  |
|   |  PtrToFunc      | æŒ‡å‘ BPF å‡½æ•°                                            |  |
|   |                 | Points to BPF function                                   |  |
|   +-----------------+----------------------------------------------------------+  |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### å¯„å­˜å™¨çŠ¶æ€å˜åŒ–è¿½è¸ªç¤ºä¾‹ | Register State Change Tracking Example

```
+-----------------------------------------------------------------------------------+
|                         å¯„å­˜å™¨çŠ¶æ€è¿½è¸ªç¤ºä¾‹                                        |
|                     Register State Tracking Example                               |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   ç¨‹åºä»£ç  | Program Code:                                                        |
|   +------------------------------------------------------------------------+      |
|   |  0: mov r1, 100         // R1 = 100                                    |      |
|   |  1: jlt r1, 50, skip    // if R1 < 50, goto skip                       |      |
|   |  2: add r1, 10          // R1 += 10                                    |      |
|   |  3: skip: mov r0, r1    // R0 = R1                                     |      |
|   |  4: exit                // return R0                                   |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   ------------------------------------------------------------------------------- |
|                                                                                   |
|   æŒ‡ä»¤ 0: mov r1, 100                                                             |
|   +------------------------------------------------------------------------+      |
|   |  Before: R1 = { type: NotInit }                                        |      |
|   |                                                                        |      |
|   |  After:  R1 = {                                                        |      |
|   |            type:      ScalarValue,                                     |      |
|   |            umin:      100,        umax:      100,                      |      |
|   |            smin:      100,        smax:      100,                      |      |
|   |            var_off:   { value: 100, mask: 0 }  <- æ‰€æœ‰ä½å·²çŸ¥           |      |
|   |          }                                                             |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   ------------------------------------------------------------------------------- |
|                                                                                   |
|   æŒ‡ä»¤ 1: jlt r1, 50, skip                                                        |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |  æ¡ä»¶åˆ¤æ–­: R1 < 50 ?                                                   |      |
|   |                                                                        |      |
|   |         å½“å‰ R1 âˆˆ [100, 100]                                           |      |
|   |                    |                                                   |      |
|   |         +----------+----------+                                        |      |
|   |         v                     v                                        |      |
|   |    true åˆ†æ”¯              false åˆ†æ”¯                                   |      |
|   |    R1 < 50                R1 >= 50                                     |      |
|   |         |                     |                                        |      |
|   |    [100,100] âˆ© [0,49]    [100,100] âˆ© [50,âˆ)                            |      |
|   |         |                     |                                        |      |
|   |         v                     v                                        |      |
|   |      ç©ºé›† âŒ              [100,100] âœ“                                  |      |
|   |    (ä¸å¯èƒ½!)             (ç»§ç»­éªŒè¯)                                    |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   ------------------------------------------------------------------------------- |
|                                                                                   |
|   æŒ‡ä»¤ 2: add r1, 10                                                              |
|   +------------------------------------------------------------------------+      |
|   |  Before: R1 = { umin: 100, umax: 100, ... }                            |      |
|   |                                                                        |      |
|   |  è®¡ç®—:   100 + 10 = 110                                                |      |
|   |                                                                        |      |
|   |  After:  R1 = {                                                        |      |
|   |            umin:      110,        umax:      110,                      |      |
|   |            smin:      110,        smax:      110,                      |      |
|   |            var_off:   { value: 110, mask: 0 }                          |      |
|   |          }                                                             |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   ------------------------------------------------------------------------------- |
|                                                                                   |
|   æŒ‡ä»¤ 3-4: mov r0, r1; exit                                                      |
|   +------------------------------------------------------------------------+      |
|   |  R0 = R1 = 110                                                         |      |
|   |  ç¨‹åºè¿”å›å€¼: 110                                                       |      |
|   |  éªŒè¯é€šè¿‡ âœ“                                                            |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ“ Tnumï¼šè¿½è¸ªå·²çŸ¥çš„ä½ | Tnum: Tracking Known Bits

`Tnum`ï¼ˆTracked Numberï¼‰æ˜¯éªŒè¯å™¨ä¸­æœ€ç²¾å·§çš„æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œå®ƒèƒ½ç²¾ç¡®è¿½è¸ªæ¯ä¸ªä½æ˜¯å·²çŸ¥è¿˜æ˜¯æœªçŸ¥ã€‚

### ç»“æ„å®šä¹‰ | Structure Definition

```rust
// æ–‡ä»¶ï¼šcrates/bpf-verifier-core/src/bounds/tnum.rs

/// è¿½è¸ªæ•°å­—ï¼šè®°å½•å“ªäº›ä½å·²çŸ¥ï¼Œå“ªäº›ä½æœªçŸ¥
/// Tracked Number: records which bits are known and which are unknown
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub struct Tnum {
    /// å·²çŸ¥ä½çš„å€¼ï¼ˆåªæœ‰ mask ä¸º 0 çš„ä½æœ‰æ•ˆï¼‰
    /// Known bit values (only valid where mask is 0)
    pub value: u64,
    
    /// æœªçŸ¥ä½çš„æ©ç ï¼ˆ1 = æœªçŸ¥ï¼Œ0 = å·²çŸ¥ï¼‰
    /// Unknown bit mask (1 = unknown, 0 = known)
    pub mask: u64,
}
```

### Tnum å·¥ä½œåŸç† | How Tnum Works

```
+-----------------------------------------------------------------------------------+
|                               Tnum å·¥ä½œåŸç†å›¾è§£                                   |
|                            How Tnum Works Illustrated                             |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                        ä¾‹ 1: å®Œå…¨å·²çŸ¥çš„å€¼ 42                           |      |
|   |                        Example 1: Fully Known Value 42                 |      |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |   äºŒè¿›åˆ¶: 42 = 0b00101010                                              |      |
|   |                                                                        |      |
|   |   ä½ä½ç½®:    7   6   5   4   3   2   1   0                             |      |
|   |           +---+---+---+---+---+---+---+---+                             |      |
|   |   value:  | 0 | 0 | 1 | 0 | 1 | 0 | 1 | 0 |  = 42                       |      |
|   |           +---+---+---+---+---+---+---+---+                             |      |
|   |           +---+---+---+---+---+---+---+---+                             |      |
|   |   mask:   | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |  = 0 (å…¨å·²çŸ¥)               |      |
|   |           +---+---+---+---+---+---+---+---+                             |      |
|   |                                                                        |      |
|   |   è¡¨ç¤ºï¼šè¿™ä¸ªæ•°å°±æ˜¯ 42ï¼Œæ²¡æœ‰ä»»ä½•ä¸ç¡®å®šæ€§                                |      |
|   |   Meaning: The number is exactly 42, no uncertainty                    |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                      ä¾‹ 2: éƒ¨åˆ†å·²çŸ¥ï¼ˆä½ 3 ä½æœªçŸ¥ï¼‰                      |      |
|   |                      Example 2: Partially Known (Low 3 Bits Unknown)   |      |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |   ä½ä½ç½®:    7   6   5   4   3   2   1   0                             |      |
|   |           +---+---+---+---+---+---+---+---+                             |      |
|   |   value:  | 0 | 0 | 1 | 0 | 1 | 0 | 0 | 0 |  = 40                       |      |
|   |           +---+---+---+---+---+---+---+---+                             |      |
|   |           +---+---+---+---+---+---+---+---+                             |      |
|   |   mask:   | 0 | 0 | 0 | 0 | 0 | 1 | 1 | 1 |  = 7                        |      |
|   |           +---+---+---+---+---+---+---+---+                             |      |
|   |             å·²çŸ¥  å·²çŸ¥ å·²çŸ¥ å·²çŸ¥ å·²çŸ¥  ?   ?   ?                         |      |
|   |                                                                        |      |
|   |   è¡¨ç¤ºï¼šè¿™ä¸ªæ•°æ˜¯ 0b00101xxxï¼Œå³ 40 åˆ° 47                               |      |
|   |   Meaning: The number is 0b00101xxx, i.e., 40 to 47                    |      |
|   |                                                                        |      |
|   |   å¯èƒ½çš„å€¼: 40, 41, 42, 43, 44, 45, 46, 47                             |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                        ä¾‹ 3: å®Œå…¨æœªçŸ¥                                  |      |
|   |                        Example 3: Completely Unknown                   |      |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |           +---+---+---+---+---+---+---+---+                             |      |
|   |   value:  | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |  = 0                        |      |
|   |           +---+---+---+---+---+---+---+---+                             |      |
|   |           +---+---+---+---+---+---+---+---+                             |      |
|   |   mask:   | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 |  = 0xFF...                  |      |
|   |           +---+---+---+---+---+---+---+---+                             |      |
|   |             ?   ?   ?   ?   ?   ?   ?   ?                               |      |
|   |                                                                        |      |
|   |   è¡¨ç¤ºï¼šè¿™ä¸ªæ•°å¯ä»¥æ˜¯ä»»æ„ 64 ä½å€¼                                       |      |
|   |   Meaning: The number can be any 64-bit value                          |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### Tnum è¿ç®— | Tnum Operations

```rust
impl Tnum {
    /// åˆ›å»ºå¸¸é‡ Tnum
    pub const fn const_value(value: u64) -> Self {
        Tnum { value, mask: 0 }
    }
    
    /// åˆ›å»ºå®Œå…¨æœªçŸ¥çš„ Tnum
    pub const fn unknown() -> Self {
        Tnum { value: 0, mask: u64::MAX }
    }
    
    /// ä¸¤ä¸ª Tnum ç›¸åŠ 
    pub fn add(self, other: Tnum) -> Tnum {
        // å…³é”®æ´å¯Ÿï¼šåŠ æ³•ä¸­ï¼Œè¿›ä½ä¼šä¼ æ’­ä¸ç¡®å®šæ€§
        // Key insight: in addition, carries propagate uncertainty
        
        let sm = self.mask.wrapping_add(other.mask);
        let sv = self.value.wrapping_add(other.value);
        let sigma = sm.wrapping_add(sv);
        let chi = sigma ^ sv;
        let mu = chi | self.mask | other.mask;
        
        Tnum {
            value: sv & !mu,
            mask: mu,
        }
    }
    
    /// ä¸¤ä¸ª Tnum æŒ‰ä½ä¸
    pub fn and(self, other: Tnum) -> Tnum {
        // å…³é”®æ´å¯Ÿï¼š
        // - 1 AND æœªçŸ¥ = æœªçŸ¥
        // - 0 AND ä»»ä½• = 0 (å·²çŸ¥!)
        let alpha = self.value | self.mask;
        let beta = other.value | other.mask;
        let v = self.value & other.value;
        
        Tnum {
            value: v,
            mask: (alpha & beta) & !v,
        }
    }
    
    /// ä¸¤ä¸ª Tnum æŒ‰ä½æˆ–
    pub fn or(self, other: Tnum) -> Tnum {
        // å…³é”®æ´å¯Ÿï¼š
        // - 0 OR æœªçŸ¥ = æœªçŸ¥
        // - 1 OR ä»»ä½• = 1 (å·²çŸ¥!)
        let v = self.value | other.value;
        let m = self.mask | other.mask;
        
        Tnum {
            value: v,
            mask: m & !v,
        }
    }
}
```

### ä¸ºä»€ä¹ˆéœ€è¦ Tnumï¼Ÿ| Why Do We Need Tnum?

```
+-----------------------------------------------------------------------------------+
|                             Tnum çš„ä¼˜åŠ¿åœºæ™¯                                       |
|                          Where Tnum Shines                                        |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   åœºæ™¯: éªŒè¯ä½æ“ä½œ | Scenario: Verifying Bit Operations                           |
|                                                                                   |
|   ä»£ç : and r1, 0x7     // R1 = R1 & 7                                            |
|                                                                                   |
|   å‡è®¾ R1 åˆå§‹å®Œå…¨æœªçŸ¥ [0, 2^64)                                                  |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                       ä»…ä½¿ç”¨èŒƒå›´è¿½è¸ª | Using Only Range Tracking       |      |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |   R1: [0, 2^64) & 7 = ???                                              |      |
|   |                                                                        |      |
|   |   èŒƒå›´è¿½è¸ªæ— æ³•å¤„ç†ä½æ“ä½œï¼                                             |      |
|   |   Range tracking can't handle bit operations!                          |      |
|   |                                                                        |      |
|   |   ç»“æœ: èŒƒå›´ä»ç„¶æ˜¯ [0, 2^64) âŒ                                        |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                       ä½¿ç”¨ Tnum è¿½è¸ª | Using Tnum Tracking             |      |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |   åˆå§‹ R1:                                                             |      |
|   |   Tnum { value: 0, mask: 0xFFFF_FFFF_FFFF_FFFF }                       |      |
|   |   (æ‰€æœ‰ä½æœªçŸ¥ | all bits unknown)                                      |      |
|   |                                                                        |      |
|   |   å¸¸é‡ 7:                                                              |      |
|   |   Tnum { value: 7, mask: 0 }                                           |      |
|   |   (æ‰€æœ‰ä½å·²çŸ¥ | all bits known)                                        |      |
|   |                                                                        |      |
|   |   æ‰§è¡Œ AND:                                                            |      |
|   |   ç»“æœ = Tnum { value: 0, mask: 7 }                                    |      |
|   |   (åªæœ‰ä½ 3 ä½æœªçŸ¥ | only low 3 bits unknown)                          |      |
|   |                                                                        |      |
|   |   è½¬æ¢ä¸ºèŒƒå›´: [0, 7] âœ“                                                 |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   ç»“è®º: Tnum èƒ½ç²¾ç¡®è¿½è¸ªä½çº§åˆ«æ“ä½œï¼                                               |
|   Conclusion: Tnum precisely tracks bit-level operations!                         |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### èŒƒå›´ä¸ Tnum çš„ååŒ | Range and Tnum Synergy

```
+-----------------------------------------------------------------------------------+
|                         èŒƒå›´ä¸ Tnum çš„ååŒå·¥ä½œ                                    |
|                       Range and Tnum Working Together                             |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   éªŒè¯å™¨åŒæ—¶ä½¿ç”¨ä¸¤ç§è¿½è¸ªæ–¹å¼ï¼Œäº’ç›¸åŠ å¼ºç²¾åº¦ï¼š                                      |
|   The verifier uses both tracking methods, reinforcing each other:                |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |                    +-------------+                                     |      |
|   |                    | BpfRegState |                                     |      |
|   |                    +------+------+                                     |      |
|   |                           |                                            |      |
|   |           +---------------+---------------+                            |      |
|   |           v               v               v                            |      |
|   |   +---------------+ +-----------+ +---------------+                    |      |
|   |   |  umin/umax    | |   Tnum    | |  smin/smax    |                    |      |
|   |   |  æ— ç¬¦å·èŒƒå›´   | |  ä½è¿½è¸ª   | |  æœ‰ç¬¦å·èŒƒå›´   |                    |      |
|   |   +-------+-------+ +-----+-----+ +-------+-------+                    |      |
|   |           |               |               |                            |      |
|   |           +---------------+---------------+                            |      |
|   |                           v                                            |      |
|   |                +----------------------+                                |      |
|   |                | reg_bounds_sync()    |                                |      |
|   |                | åŒæ­¥æ‰€æœ‰è¾¹ç•Œä¿¡æ¯     |                                |      |
|   |                +----------------------+                                |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   ç¤ºä¾‹: èŒƒå›´çº¦æŸ -> Tnum æ¨å¯¼                                                     |
|   Example: Range constraint -> Tnum derivation                                    |
|                                                                                   |
|   å·²çŸ¥: umax = 7  (å€¼æœ€å¤§æ˜¯ 7)                                                    |
|   æ¨å¯¼: é«˜ä½å¿…å®šä¸º 0ï¼                                                            |
|         mask çš„é«˜ä½å¯ä»¥æ¸…é›¶                                                       |
|                                                                                   |
|   ç¤ºä¾‹: Tnum -> èŒƒå›´æ¨å¯¼                                                          |
|   Example: Tnum -> Range derivation                                               |
|                                                                                   |
|   å·²çŸ¥: Tnum { value: 0b1000, mask: 0b0111 }                                      |
|   æ¨å¯¼: umin = 0b1000 = 8  (æœ€å°æ˜¯ 8)                                             |
|         umax = 0b1111 = 15 (æœ€å¤§æ˜¯ 15)                                            |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ“Š BpfFuncStateï¼šå‡½æ•°å¸§çŠ¶æ€ | Function Frame State

æ¯ä¸ªå‡½æ•°è°ƒç”¨ï¼ˆåŒ…æ‹¬ä¸»ç¨‹åºå’Œå­ç¨‹åºè°ƒç”¨ï¼‰éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„çŠ¶æ€ï¼š

### ç»“æ„å®šä¹‰ | Structure Definition

```rust
// æ–‡ä»¶ï¼šcrates/bpf-verifier-core/src/state/verifier_state.rs

/// å‡½æ•°å¸§çŠ¶æ€ - ä¿å­˜å•ä¸ªå‡½æ•°è°ƒç”¨çš„å®Œæ•´çŠ¶æ€
/// Function frame state - holds complete state for a single function call
#[derive(Debug, Clone)]
pub struct BpfFuncState {
    /// 11 ä¸ªå¯„å­˜å™¨çš„çŠ¶æ€
    /// State of all 11 registers
    pub regs: [BpfRegState; MAX_BPF_REG],  // MAX_BPF_REG = 11
    
    /// æ ˆçŠ¶æ€ï¼ˆæ¯ä¸ªå‡½æ•°å¸§ç‹¬ç«‹çš„æ ˆï¼‰
    /// Stack state (independent stack for each frame)
    pub stack: BpfStackState,
    
    /// è°ƒç”¨ç‚¹ï¼ˆä»å“ªæ¡æŒ‡ä»¤è°ƒç”¨è¿›æ¥çš„ï¼‰
    /// Call site (which instruction called this function)
    pub callsite: i32,
    
    /// BTF å‡½æ•° IDï¼ˆç”¨äºç±»å‹ä¿¡æ¯ï¼‰
    /// BTF function ID (for type information)
    pub btf_func_id: u32,
    
    /// å­ç¨‹åºç´¢å¼•
    /// Subprogram index
    pub subprogno: u32,
    
    /// æ˜¯å¦åœ¨å›è°ƒå‡½æ•°ä¸­
    /// Whether currently in a callback function
    pub in_callback_fn: bool,
    
    /// å›è°ƒçš„è¿”å›å€¼èŒƒå›´çº¦æŸ
    /// Return value range constraint for callbacks
    pub callback_ret_range: Option<(i64, i64)>,
}
```

### æ ˆçŠ¶æ€è¯¦è§£ | Stack State Details

```rust
/// æ ˆçŠ¶æ€
/// Stack state
#[derive(Debug, Clone)]
pub struct BpfStackState {
    /// æ ˆæ§½æ•°ç»„ï¼ˆæ¯ä¸ªæ§½ 8 å­—èŠ‚ï¼‰
    /// Stack slot array (each slot is 8 bytes)
    pub stack: Vec<BpfStackSlot>,
    
    /// å·²åˆ†é…çš„æ ˆå¤§å°
    /// Allocated stack size
    pub allocated_stack: u32,
}

/// å•ä¸ªæ ˆæ§½ï¼ˆ8 å­—èŠ‚ï¼‰
/// Single stack slot (8 bytes)
#[derive(Debug, Clone)]
pub struct BpfStackSlot {
    /// æ¯ä¸ªå­—èŠ‚çš„ç±»å‹
    /// Type of each byte
    pub slot_type: [BpfStackSlotType; BPF_REG_SIZE],  // BPF_REG_SIZE = 8
    
    /// å¦‚æœæ˜¯æº¢å‡ºçš„å¯„å­˜å™¨ï¼Œä¿å­˜å®Œæ•´çš„å¯„å­˜å™¨çŠ¶æ€
    /// If spilled register, saves complete register state
    pub spilled_ptr: BpfRegState,
}

/// æ ˆæ§½ç±»å‹
/// Stack slot types
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum BpfStackSlotType {
    Invalid,     // æœªå†™å…¥/æ— æ•ˆ | Not written/invalid
    Misc,        // å·²å†™å…¥ä½†æ— è¿½è¸ªä¿¡æ¯ | Written but no tracking info
    Zero,        // å·²çŸ¥æ˜¯é›¶ | Known to be zero
    Spill,       // æº¢å‡ºçš„å¯„å­˜å™¨ | Spilled register
    Iter,        // è¿­ä»£å™¨çŠ¶æ€ | Iterator state
    Dynptr,      // åŠ¨æ€æŒ‡é’ˆ | Dynamic pointer
}
```

### BPF æ ˆå¸ƒå±€å›¾ | BPF Stack Layout

```
+-----------------------------------------------------------------------------------+
|                                 BPF æ ˆå¸ƒå±€                                        |
|                               BPF Stack Layout                                    |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   R10 (å¸§æŒ‡é’ˆ | Frame Pointer)                                                    |
|       |                                                                           |
|       v                                                                           |
|   +---------------------------------------------------------------------+         |
|   | åç§» 0 (æ ˆé¡¶ | Stack Top)                                           |         |
|   +---------------------------------------------------------------------+         |
|   | -8  | Slot 0  | ç±»å‹: Spill   | æº¢å‡ºçš„ R6                          |         |
|   |     |         | spilled_ptr: { type: ScalarValue, ... }            |         |
|   +---------------------------------------------------------------------+         |
|   | -16 | Slot 1  | ç±»å‹: Misc    | å±€éƒ¨å˜é‡ (å€¼=42)                   |         |
|   |     |         |               |                                    |         |
|   +---------------------------------------------------------------------+         |
|   | -24 | Slot 2  | ç±»å‹: Zero    | é›¶åˆå§‹åŒ–çš„å˜é‡                     |         |
|   |     |         |               |                                    |         |
|   +---------------------------------------------------------------------+         |
|   | -32 | Slot 3  | ç±»å‹: Iter    | è¿­ä»£å™¨çŠ¶æ€                         |         |
|   |     |         |               |                                    |         |
|   +---------------------------------------------------------------------+         |
|   |     |  ...    |               |                                    |         |
|   +---------------------------------------------------------------------+         |
|   | -504| Slot 62 | ç±»å‹: Invalid | æœªä½¿ç”¨                             |         |
|   +---------------------------------------------------------------------+         |
|   | -512| Slot 63 | ç±»å‹: Invalid | æ ˆåº•                               |         |
|   +---------------------------------------------------------------------+         |
|                                                                                   |
|   ------------------------------------------------------------------------------- |
|                                                                                   |
|   æ ˆæ“ä½œç¤ºä¾‹ | Stack Operation Examples:                                          |
|                                                                                   |
|   æº¢å‡ºå¯„å­˜å™¨ | Spill register:                                                    |
|   +------------------------------------------------------------------------+      |
|   |  stxdw [r10-8], r6   // æŠŠ R6 ä¿å­˜åˆ°æ ˆä¸Š                               |      |
|   |                      // Save R6 to stack                               |      |
|   |                                                                        |      |
|   |  éªŒè¯å™¨åŠ¨ä½œ:                                                           |      |
|   |  1. æ£€æŸ¥ R6 æ˜¯å¦å·²åˆå§‹åŒ–                                               |      |
|   |  2. æ ‡è®° slot[0] ä¸º Spill ç±»å‹                                         |      |
|   |  3. å¤åˆ¶ R6 çš„å®Œæ•´çŠ¶æ€åˆ° slot[0].spilled_ptr                           |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   æ¢å¤å¯„å­˜å™¨ | Fill register:                                                     |
|   +------------------------------------------------------------------------+      |
|   |  ldxdw r6, [r10-8]   // ä»æ ˆä¸Šæ¢å¤ R6                                  |      |
|   |                      // Restore R6 from stack                          |      |
|   |                                                                        |      |
|   |  éªŒè¯å™¨åŠ¨ä½œ:                                                           |      |
|   |  1. æ£€æŸ¥ slot[0] æ˜¯å¦æ˜¯ Spill ç±»å‹                                     |      |
|   |  2. å¤åˆ¶ slot[0].spilled_ptr åˆ° R6                                     |      |
|   |  3. ä¿ç•™å®Œæ•´çš„ç±»å‹å’Œè¾¹ç•Œä¿¡æ¯ï¼                                         |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ­ BpfVerifierStateï¼šæ•´ä½“çŠ¶æ€ | Overall Verifier State

æœ€é¡¶å±‚çš„ç»“æ„ï¼ŒåŒ…å«éªŒè¯ä¸€ä¸ªç¨‹åºç‚¹æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼š

### ç»“æ„å®šä¹‰ | Structure Definition

```rust
// æ–‡ä»¶ï¼šcrates/bpf-verifier-core/src/state/verifier_state.rs

/// éªŒè¯å™¨æ•´ä½“çŠ¶æ€ - åŒ…å«éªŒè¯ä¸€ä¸ªç¨‹åºç‚¹çš„å®Œæ•´ä¿¡æ¯
/// Verifier state - contains complete information for verifying a program point
#[derive(Debug, Clone)]
pub struct BpfVerifierState {
    // -----------------------------------------------------------
    // å‡½æ•°è°ƒç”¨æ ˆ | Function Call Stack
    // -----------------------------------------------------------
    
    /// å‡½æ•°å¸§æ ˆï¼ˆæœ€å¤š 8 å±‚åµŒå¥—ï¼‰
    /// Function frame stack (max 8 nesting levels)
    pub frame: [Option<Box<BpfFuncState>>; MAX_CALL_FRAMES],  // MAX_CALL_FRAMES = 8
    
    /// å½“å‰å¸§ç´¢å¼•ï¼ˆ0 = ä¸»ç¨‹åºï¼‰
    /// Current frame index (0 = main program)
    pub curframe: usize,
    
    // -----------------------------------------------------------
    // ç¨‹åºä½ç½® | Program Location
    // -----------------------------------------------------------
    
    /// å½“å‰æŒ‡ä»¤ç´¢å¼•
    /// Current instruction index
    pub insn_idx: usize,
    
    // -----------------------------------------------------------
    // èµ„æºè¿½è¸ª | Resource Tracking
    // -----------------------------------------------------------
    
    /// è·å–çš„å¼•ç”¨åˆ—è¡¨ï¼ˆå¿…é¡»åœ¨é€€å‡ºå‰é‡Šæ”¾ï¼‰
    /// Acquired references (must be released before exit)
    pub refs: Vec<BpfReference>,
    
    /// æ´»è·ƒé”çŠ¶æ€ï¼ˆå¿…é¡»åœ¨é€€å‡ºå‰é‡Šæ”¾ï¼‰
    /// Active locks (must be released before exit)
    pub active_locks: u32,
    
    // -----------------------------------------------------------
    // ç‰¹æ®ŠçŠ¶æ€ | Special State
    // -----------------------------------------------------------
    
    /// may_goto æ·±åº¦ï¼ˆç”¨äºæœ‰ç•Œå¾ªç¯ï¼‰
    /// may_goto depth (for bounded loops)
    pub may_goto_depth: u32,
    
    /// å›è°ƒå±•å¼€æ·±åº¦
    /// Callback unroll depth
    pub callback_unroll_depth: u32,
    
    /// æ˜¯å¦åœ¨å¼‚å¸¸å¤„ç†è·¯å¾„
    /// Whether in exception handling path
    pub in_exception: bool,
}
```

### å¼•ç”¨è¿½è¸ª | Reference Tracking

```rust
/// å¼•ç”¨ä¿¡æ¯ - è¿½è¸ª BPF ç¨‹åºè·å–çš„èµ„æº
/// Reference info - tracks resources acquired by BPF program
#[derive(Debug, Clone)]
pub struct BpfReference {
    /// å¼•ç”¨ IDï¼ˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼‰
    /// Reference ID (unique identifier)
    pub id: u32,
    
    /// å¼•ç”¨ç±»å‹
    /// Reference type
    pub ref_type: BpfRefType,
    
    /// è·å–å¼•ç”¨æ—¶çš„æŒ‡ä»¤ç´¢å¼•ï¼ˆç”¨äºé”™è¯¯æŠ¥å‘Šï¼‰
    /// Instruction index when reference was acquired (for error reporting)
    pub insn_idx: usize,
}

/// å¼•ç”¨ç±»å‹
/// Reference types
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum BpfRefType {
    /// Map lookup è¿”å›çš„æŒ‡é’ˆï¼ˆéœ€è¦æ£€æŸ¥ NULLï¼‰
    /// Pointer returned by map_lookup (needs NULL check)
    PtrToMapValue,
    
    /// RCU è¯»é”ï¼ˆå¿…é¡»é‡Šæ”¾ï¼‰
    /// RCU read lock (must be released)
    RcuReadLock,
    
    /// è‡ªæ—‹é”ï¼ˆå¿…é¡»é‡Šæ”¾ï¼‰
    /// Spin lock (must be released)
    SpinLock,
    
    /// åˆ†é…çš„å†…å­˜ï¼ˆå¿…é¡»é‡Šæ”¾ï¼‰
    /// Allocated memory (must be freed)
    AllocMem,
    
    /// Socket å¼•ç”¨
    /// Socket reference
    Socket,
    
    /// percpu æ•°æ®å¼•ç”¨
    /// percpu data reference
    Percpu,
}
```

### å‡½æ•°è°ƒç”¨æ ˆç¤ºä¾‹ | Function Call Stack Example

```
+-----------------------------------------------------------------------------------+
|                              å‡½æ•°è°ƒç”¨æ ˆç¤ºä¾‹                                       |
|                        Function Call Stack Example                                |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   ç¨‹åºæ‰§è¡Œæµç¨‹:                                                                   |
|   +------------------------------------------------------------------------+      |
|   |  main:                                                                 |      |
|   |    0: mov r1, 10                                                       |      |
|   |    1: call subprog_a        --------------------------+                |      |
|   |    2: add r0, 5             <-------------------------+---+            |      |
|   |    3: exit                                            |   |            |      |
|   |                                                       |   |            |      |
|   |  subprog_a:                 <-------------------------+   |            |      |
|   |    4: mov r2, r1                                          |            |      |
|   |    5: call subprog_b        --------------------------+   |            |      |
|   |    6: add r0, r2            <-------------------------+---+---+        |      |
|   |    7: exit (è¿”å› main)      --------------------------+---+   |        |      |
|   |                                                       |       |        |      |
|   |  subprog_b:                 <-------------------------+       |        |      |
|   |    8: mov r0, 100                                             |        |      |
|   |    9: exit (è¿”å› subprog_a) ----------------------------------+        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   ------------------------------------------------------------------------------- |
|                                                                                   |
|   åœ¨ subprog_b æ‰§è¡Œæ—¶çš„è°ƒç”¨æ ˆçŠ¶æ€:                                                |
|   Call stack state when executing subprog_b:                                      |
|                                                                                   |
|   curframe = 2                                                                    |
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   | frame[2]: BpfFuncState (subprog_b)                           <-- å½“å‰ |      |
|   |   +-- regs[11]: å½“å‰å¯„å­˜å™¨çŠ¶æ€                                         |      |
|   |   +-- stack: å½“å‰æ ˆçŠ¶æ€                                                |      |
|   |   +-- callsite: 5 (ä»ç¬¬ 5 æ¡æŒ‡ä»¤è°ƒç”¨è¿›æ¥)                              |      |
|   |   +-- subprogno: 2                                                     |      |
|   +------------------------------------------------------------------------+      |
|   | frame[1]: BpfFuncState (subprog_a)                           <-- çˆ¶å¸§ |      |
|   |   +-- regs[11]: è°ƒç”¨å‰çš„å¯„å­˜å™¨çŠ¶æ€                                     |      |
|   |   +-- stack: è°ƒç”¨å‰çš„æ ˆçŠ¶æ€                                            |      |
|   |   +-- callsite: 1 (ä»ç¬¬ 1 æ¡æŒ‡ä»¤è°ƒç”¨è¿›æ¥)                              |      |
|   |   +-- subprogno: 1                                                     |      |
|   +------------------------------------------------------------------------+      |
|   | frame[0]: BpfFuncState (main)                                <-- æ ¹å¸§ |      |
|   |   +-- regs[11]: ç¨‹åºå…¥å£çš„å¯„å­˜å™¨çŠ¶æ€                                   |      |
|   |   +-- stack: ä¸»ç¨‹åºçš„æ ˆçŠ¶æ€                                            |      |
|   |   +-- callsite: -1 (å…¥å£ç‚¹)                                            |      |
|   |   +-- subprogno: 0                                                     |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
|   frame[3..7]: None (æœªä½¿ç”¨)                                                      |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### çŠ¶æ€çš„ç”Ÿå‘½å‘¨æœŸ | State Lifecycle

```
+-----------------------------------------------------------------------------------+
|                               çŠ¶æ€çš„ç”Ÿå‘½å‘¨æœŸ                                      |
|                              State Lifecycle                                      |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +------------------------------------------------------------------------+      |
|   |  1. åˆå§‹åŒ– | Initialization                                            |      |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |  BpfVerifierState::new() åˆ›å»ºåˆå§‹çŠ¶æ€:                                 |      |
|   |                                                                        |      |
|   |  å¯„å­˜å™¨:                                                               |      |
|   |  +------------------------------------------------------------------+  |      |
|   |  | R0  = NotInit           (è¿”å›å€¼ï¼Œæœªè®¾ç½®)                         |  |      |
|   |  | R1  = PtrToCtx          (ä¸Šä¸‹æ–‡æŒ‡é’ˆï¼Œç¨‹åºå…¥å£å‚æ•°)               |  |      |
|   |  | R2  = NotInit           (æœªåˆå§‹åŒ–)                               |  |      |
|   |  | ...                                                              |  |      |
|   |  | R9  = NotInit           (æœªåˆå§‹åŒ–)                               |  |      |
|   |  | R10 = PtrToStack        (æ ˆå¸§æŒ‡é’ˆï¼Œåªè¯»)                         |  |      |
|   |  +------------------------------------------------------------------+  |      |
|   |                                                                        |      |
|   |  æ ˆ: æ‰€æœ‰æ§½éƒ½æ˜¯ Invalid                                                |      |
|   |  å¼•ç”¨: ç©ºåˆ—è¡¨                                                          |      |
|   |  é”: æ— æ´»è·ƒé”                                                          |      |
|   |                                                                        |      |
|                               |                                               |
|                               v                                               |
|   +------------------------------------------------------------------------+      |
|   |  2. éªŒè¯è¿‡ç¨‹ | Verification Process                                    |      |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |  æ¯æ¡æŒ‡ä»¤æ›´æ–°çŠ¶æ€:                                                     |      |
|   |                                                                        |      |
|   |  +-----------------+----------------------------------------------+    |      |
|   |  | æŒ‡ä»¤ç±»å‹        | çŠ¶æ€å˜åŒ–                                     |    |      |
|   |  +-----------------+----------------------------------------------+    |      |
|   |  | ALU æŒ‡ä»¤        | æ›´æ–°ç›®æ ‡å¯„å­˜å™¨çš„ç±»å‹å’Œè¾¹ç•Œ                   |    |      |
|   |  | (add, mul, ...) |                                              |    |      |
|   |  +-----------------+----------------------------------------------+    |      |
|   |  | å†…å­˜è¯»å–        | æ ¹æ®æºæŒ‡é’ˆç±»å‹è®¾ç½®ç›®æ ‡å¯„å­˜å™¨ç±»å‹             |    |      |
|   |  | (ldx)           |                                              |    |      |
|   |  +-----------------+----------------------------------------------+    |      |
|   |  | å†…å­˜å†™å…¥        | æ›´æ–°æ ˆæ§½æˆ–éªŒè¯ç›®æ ‡å†…å­˜å¯å†™                   |    |      |
|   |  | (stx)           |                                              |    |      |
|   |  +-----------------+----------------------------------------------+    |      |
|   |  | æ¡ä»¶åˆ†æ”¯        | çŠ¶æ€åˆ†è£‚ï¼Œæ¯ä¸ªåˆ†æ”¯ç‹¬ç«‹ç»†åŒ–è¾¹ç•Œ               |    |      |
|   |  | (jeq, jgt, ...) |                                              |    |      |
|   |  +-----------------+----------------------------------------------+    |      |
|   |  | å‡½æ•°è°ƒç”¨        | ä¿å­˜å½“å‰å¸§ï¼Œåˆ›å»ºæ–°å¸§                         |    |      |
|   |  | (call)          |                                              |    |      |
|   |  +-----------------+----------------------------------------------+    |      |
|   |  | Helper è°ƒç”¨     | æ ¹æ® helper å®šä¹‰æ›´æ–°å¯„å­˜å™¨å’Œæ·»åŠ å¼•ç”¨         |    |      |
|   |  | (call imm)      |                                              |    |      |
|   |  +-----------------+----------------------------------------------+    |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                               |                                               |
|                               v                                               |
|   +------------------------------------------------------------------------+      |
|   |  3. åˆ†æ”¯æ—¶ | At Branches                                               |      |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |           åŸçŠ¶æ€: R1 âˆˆ [0, 100]                                        |      |
|   |                      |                                                 |      |
|   |           jgt r1, 50, else_branch                                      |      |
|   |                      |                                                 |      |
|   |              +-------+-------+                                         |      |
|   |              v               v                                         |      |
|   |        true åˆ†æ”¯        false åˆ†æ”¯                                     |      |
|   |        (R1 > 50)        (R1 <= 50)                                     |      |
|   |              |               |                                         |      |
|   |              v               v                                         |      |
|   |        çŠ¶æ€å…‹éš† +       çŠ¶æ€å…‹éš† +                                     |      |
|   |        R1 âˆˆ [51,100]   R1 âˆˆ [0,50]                                     |      |
|   |                                                                        |      |
|   |   ä¸¤ä¸ªåˆ†æ”¯ç‹¬ç«‹éªŒè¯ï¼Œå„è‡ªç»´æŠ¤è‡ªå·±çš„çŠ¶æ€                                 |      |
|   |   Both branches verified independently, each with own state            |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                               |                                               |
|                               v                                               |
|   +------------------------------------------------------------------------+      |
|   |  4. é€€å‡ºæ—¶æ£€æŸ¥ | Exit Checks                                           |      |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |  å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ‰èƒ½é€šè¿‡éªŒè¯:                                         |      |
|   |                                                                        |      |
|   |  +------------------------------------------------------------------+  |      |
|   |  | âœ“ æ‰€æœ‰è·å–çš„å¼•ç”¨éƒ½å·²é‡Šæ”¾ (refs ä¸ºç©º)                             |  |      |
|   |  | âœ“ æ‰€æœ‰è·å–çš„é”éƒ½å·²é‡Šæ”¾ (active_locks == 0)                       |  |      |
|   |  | âœ“ R0 åŒ…å«æœ‰æ•ˆçš„è¿”å›å€¼ (ä¸æ˜¯ NotInit)                             |  |      |
|   |  | âœ“ å·²å›åˆ° frame[0] (curframe == 0)                                |  |      |
|   |  +------------------------------------------------------------------+  |      |
|   |                                                                        |      |
|   |  å¦‚æœä»»ä½•æ¡ä»¶ä¸æ»¡è¶³ï¼ŒéªŒè¯å¤±è´¥ï¼                                        |      |
|   |  If any condition fails, verification fails!                           |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ”„ æ•°æ®ç»“æ„å®Œæ•´å…³ç³»å›¾ | Complete Data Structure Relationships

```
+-----------------------------------------------------------------------------------+
|                            æ•°æ®ç»“æ„å®Œæ•´å…³ç³»å›¾                                     |
|                     Complete Data Structure Relationships                         |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   GenericVerifierEnv<P: PlatformSpec>                                             |
|   +------------------------------------------------------------------------+      |
|   |                                                                        |      |
|   |   platform: P                          +----------------------------+  |      |
|   |   +-- get_helper_info()          ------>| HelperInfo               |  |      |
|   |   +-- get_map_info()             ------>| MapInfo                  |  |      |
|   |   +-- get_type_info()            ------>| BtfTypeInfo              |  |      |
|   |                                         +----------------------------+  |      |
|   |                                                                        |      |
|   |   insns: &[BpfInsn]                    +----------------------------+  |      |
|   |   +-- opcode                     ------>| æ“ä½œç                     |  |      |
|   |   +-- dst_reg / src_reg          ------>| å¯„å­˜å™¨ç¼–å· 0-10          |  |      |
|   |   +-- off                        ------>| 16ä½åç§»                 |  |      |
|   |   +-- imm                        ------>| 32ä½ç«‹å³æ•°               |  |      |
|   |                                         +----------------------------+  |      |
|   |                                                                        |      |
|   |   insn_aux: Vec<InsnAuxData>           +----------------------------+  |      |
|   |   +-- map_ptr                    ------>| Map å¼•ç”¨                  |  |      |
|   |   +-- func_ptr                   ------>| å‡½æ•°å¼•ç”¨                  |  |      |
|   |   +-- sanitize_off               ------>| æ¶ˆæ¯’æ ‡è®°                  |  |      |
|   |                                         +----------------------------+  |      |
|   |                                                                        |      |
|   |   state: BpfVerifierState                                              |      |
|   |   +------------------------------------------------------------------+ |      |
|   |   |                                                                  | |      |
|   |   |   frame[0..8]: Option<Box<BpfFuncState>>                         | |      |
|   |   |   +--------------------------------------------------------------+|      |
|   |   |   |                                                              ||      |
|   |   |   |   regs[0..11]: BpfRegState                                   ||      |
|   |   |   |   +--------------------------------------------------------+ ||      |
|   |   |   |   | reg_type: BpfRegType                                   | ||      |
|   |   |   |   | type_flags: BpfTypeFlag                                | ||      |
|   |   |   |   | umin/umax, smin/smax: æ•°å€¼è¾¹ç•Œ                         | ||      |
|   |   |   |   | u32_min/max, s32_min/max: 32ä½è¾¹ç•Œ                     | ||      |
|   |   |   |   | var_off: Tnum { value, mask }                          | ||      |
|   |   |   |   | off: i32 (é™æ€åç§»)                                    | ||      |
|   |   |   |   | id: u32 (å…³è”ID)                                       | ||      |
|   |   |   |   | ref_obj_id: u32 (å¼•ç”¨ID)                               | ||      |
|   |   |   |   | precise: bool (ç²¾åº¦æ ‡è®°)                               | ||      |
|   |   |   |   +--------------------------------------------------------+ ||      |
|   |   |   |                                                              ||      |
|   |   |   |   stack: BpfStackState                                       ||      |
|   |   |   |   +--------------------------------------------------------+ ||      |
|   |   |   |   | stack[0..64]: BpfStackSlot                             | ||      |
|   |   |   |   |   +-- slot_type[8]: BpfStackSlotType                   | ||      |
|   |   |   |   |   +-- spilled_ptr: BpfRegState                         | ||      |
|   |   |   |   | allocated_stack: u32                                   | ||      |
|   |   |   |   +--------------------------------------------------------+ ||      |
|   |   |   |                                                              ||      |
|   |   |   +--------------------------------------------------------------+|      |
|   |   |                                                                  | |      |
|   |   |   curframe: usize (å½“å‰å¸§ç´¢å¼•)                                   | |      |
|   |   |   insn_idx: usize (å½“å‰æŒ‡ä»¤)                                     | |      |
|   |   |                                                                  | |      |
|   |   |   refs: Vec<BpfReference>                                        | |      |
|   |   |   +------------------------------------------------------------+ | |      |
|   |   |   | id, ref_type, insn_idx                                     | | |      |
|   |   |   +------------------------------------------------------------+ | |      |
|   |   |                                                                  | |      |
|   |   |   active_locks: u32                                              | |      |
|   |   |   may_goto_depth: u32                                            | |      |
|   |   |   callback_unroll_depth: u32                                     | |      |
|   |   |   in_exception: bool                                             | |      |
|   |   |                                                                  | |      |
|   |   +------------------------------------------------------------------+ |      |
|   |                                                                        |      |
|   |   state_cache: StateCache               +----------------------------+ |      |
|   |   +-- çŠ¶æ€å‰ªæç¼“å­˜                ------>| å·²éªŒè¯çŠ¶æ€çš„å¿«ç…§          | |      |
|   |                                         +----------------------------+ |      |
|   |                                                                        |      |
|   +------------------------------------------------------------------------+      |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ’¡ å®é™…ä»£ç ç¤ºä¾‹ | Practical Code Examples

### ç¤ºä¾‹ 1: æ£€æŸ¥å¯„å­˜å™¨ç±»å‹ | Example 1: Checking Register Type

```rust
// æ£€æŸ¥å¯„å­˜å™¨æ˜¯å¦å¯ä»¥ç”¨ä½œå†…å­˜è®¿é—®çš„åŸºå€
fn check_mem_access_base(state: &BpfVerifierState, regno: usize) -> Result<()> {
    let reg = &state.cur_func()?.regs[regno];
    
    match reg.reg_type {
        // è¿™äº›ç±»å‹å¯ä»¥ä½œä¸ºåŸºå€
        BpfRegType::PtrToStack |
        BpfRegType::PtrToMapValue |
        BpfRegType::PtrToCtx |
        BpfRegType::PtrToPacket => {
            // è¿˜éœ€è¦æ£€æŸ¥åç§»æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
            check_offset_in_bounds(reg)?;
            Ok(())
        }
        
        // æ ‡é‡ä¸èƒ½ä½œä¸ºæŒ‡é’ˆ
        BpfRegType::ScalarValue => {
            Err(VerifierError::ScalarUsedAsPointer { regno })
        }
        
        // æœªåˆå§‹åŒ–çš„å¯„å­˜å™¨ä¸èƒ½ä½¿ç”¨
        BpfRegType::NotInit => {
            Err(VerifierError::UninitializedRegister { regno })
        }
        
        // å…¶ä»–ç±»å‹æ ¹æ®å…·ä½“æƒ…å†µå¤„ç†
        _ => {
            Err(VerifierError::InvalidPointerType { 
                regno,
                actual: reg.reg_type,
            })
        }
    }
}
```

### ç¤ºä¾‹ 2: æ›´æ–°åŠ æ³•åçš„è¾¹ç•Œ | Example 2: Updating Bounds After Addition

```rust
// æ‰§è¡Œ add dst, src åæ›´æ–°ç›®æ ‡å¯„å­˜å™¨çš„è¾¹ç•Œ
fn update_bounds_after_add(dst: &mut BpfRegState, src: &BpfRegState) {
    // 1. æ›´æ–°æ— ç¬¦å·è¾¹ç•Œ
    let (new_umin, overflow1) = dst.umin_value.overflowing_add(src.umin_value);
    let (new_umax, overflow2) = dst.umax_value.overflowing_add(src.umax_value);
    
    if overflow1 || overflow2 || new_umax < new_umin {
        // å¯èƒ½æº¢å‡ºï¼ŒèŒƒå›´å˜æˆå®Œå…¨æœªçŸ¥
        dst.umin_value = 0;
        dst.umax_value = u64::MAX;
    } else {
        dst.umin_value = new_umin;
        dst.umax_value = new_umax;
    }
    
    // 2. æ›´æ–°æœ‰ç¬¦å·è¾¹ç•Œï¼ˆç±»ä¼¼é€»è¾‘ï¼‰
    let (new_smin, soverflow1) = dst.smin_value.overflowing_add(src.smin_value);
    let (new_smax, soverflow2) = dst.smax_value.overflowing_add(src.smax_value);
    
    if soverflow1 || soverflow2 {
        dst.smin_value = i64::MIN;
        dst.smax_value = i64::MAX;
    } else {
        dst.smin_value = new_smin;
        dst.smax_value = new_smax;
    }
    
    // 3. æ›´æ–° Tnum (ä½çº§åˆ«è¿½è¸ª)
    dst.var_off = dst.var_off.add(src.var_off);
    
    // 4. åŒæ­¥æ‰€æœ‰è¾¹ç•Œï¼Œç¡®ä¿ä¸€è‡´æ€§
    reg_bounds_sync(dst);
}

// åŒæ­¥è¾¹ç•Œï¼šç¡®ä¿èŒƒå›´å’Œ Tnum ä¿¡æ¯ä¸€è‡´
fn reg_bounds_sync(reg: &mut BpfRegState) {
    // ä» Tnum æ¨å¯¼èŒƒå›´çº¦æŸ
    let tnum_umin = reg.var_off.value;
    let tnum_umax = reg.var_off.value | reg.var_off.mask;
    
    // å–æ›´ç´§çš„è¾¹ç•Œ
    reg.umin_value = reg.umin_value.max(tnum_umin);
    reg.umax_value = reg.umax_value.min(tnum_umax);
    
    // åè¿‡æ¥ï¼Œä»èŒƒå›´çº¦æŸæ›´æ–° Tnum
    // å¦‚æœèŒƒå›´çº¦æŸè¡¨æ˜é«˜ä½å¿…å®šä¸º 0ï¼Œåˆ™æ›´æ–° Tnum.mask
    // ...
}
```

### ç¤ºä¾‹ 3: å¤„ç†æ¡ä»¶åˆ†æ”¯ | Example 3: Handling Conditional Branches

```rust
// å¤„ç† jgt r1, r2, target åˆ†æ”¯
fn process_jgt_branch(
    true_state: &mut BpfVerifierState,   // r1 > r2 çš„çŠ¶æ€
    false_state: &mut BpfVerifierState,  // r1 <= r2 çš„çŠ¶æ€
    r1_idx: usize,
    r2_idx: usize,
) -> Result<()> {
    let r1_true = &mut true_state.cur_func_mut()?.regs[r1_idx];
    let r2_true = &mut true_state.cur_func_mut()?.regs[r2_idx];
    let r1_false = &mut false_state.cur_func_mut()?.regs[r1_idx];
    let r2_false = &mut false_state.cur_func_mut()?.regs[r2_idx];
    
    // True åˆ†æ”¯: r1 > r2
    // r1 çš„æœ€å°å€¼è‡³å°‘æ˜¯ r2 çš„æœ€å°å€¼ + 1
    r1_true.umin_value = r1_true.umin_value.max(r2_true.umin_value.saturating_add(1));
    // r2 çš„æœ€å¤§å€¼æœ€å¤šæ˜¯ r1 çš„æœ€å¤§å€¼ - 1
    r2_true.umax_value = r2_true.umax_value.min(r1_true.umax_value.saturating_sub(1));
    
    // False åˆ†æ”¯: r1 <= r2
    // r1 çš„æœ€å¤§å€¼æœ€å¤šæ˜¯ r2 çš„æœ€å¤§å€¼
    r1_false.umax_value = r1_false.umax_value.min(r2_false.umax_value);
    // r2 çš„æœ€å°å€¼è‡³å°‘æ˜¯ r1 çš„æœ€å°å€¼
    r2_false.umin_value = r2_false.umin_value.max(r1_false.umin_value);
    
    // æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å¯è¾¾
    if r1_true.umin_value > r1_true.umax_value {
        // True åˆ†æ”¯ä¸å¯è¾¾ (r1 ä¸å¯èƒ½ > r2)
        true_state.mark_unreachable();
    }
    if r1_false.umin_value > r1_false.umax_value {
        // False åˆ†æ”¯ä¸å¯è¾¾
        false_state.mark_unreachable();
    }
    
    Ok(())
}
```

---

## ğŸ“ å°ç»“ | Summary

ç°åœ¨ä½ ç†è§£äº†éªŒè¯å™¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š

| æ•°æ®ç»“æ„ | ç”¨é€” | å…³é”®å­—æ®µ |
|---------|------|---------|
| **BpfRegState** | è¿½è¸ªå•ä¸ªå¯„å­˜å™¨ | reg_type, umin/umax, var_off |
| **Tnum** | ä½çº§åˆ«ç²¾åº¦è¿½è¸ª | value, mask |
| **BpfFuncState** | å‡½æ•°å¸§çŠ¶æ€ | regs[11], stack |
| **BpfStackState** | æ ˆçŠ¶æ€ | slots[], allocated_stack |
| **BpfVerifierState** | æ•´ä½“çŠ¶æ€ | frame[8], refs, active_locks |

---

## ğŸ“ ç»ƒä¹  | Exercises

1. æ‰“å¼€ `state/reg_state.rs`ï¼Œæ‰¾åˆ° `BpfRegState` çš„å®Œæ•´å®šä¹‰
2. åœ¨ `bounds/tnum.rs` ä¸­ï¼Œç†è§£ `Tnum::and()` çš„å®ç°é€»è¾‘
3. æ‰¾åˆ° `reg_bounds_sync()` å‡½æ•°ï¼Œç†è§£èŒƒå›´å’Œ Tnum å¦‚ä½•ç›¸äº’çº¦æŸ
4. æ€è€ƒï¼šä¸ºä»€ä¹ˆéœ€è¦åŒæ—¶è¿½è¸ª 64 ä½å’Œ 32 ä½è¾¹ç•Œï¼Ÿ

---

## ğŸ”— ä»£ç ä½ç½®ç´¢å¼• | Code Location Index

| æ•°æ®ç»“æ„ | æ–‡ä»¶ä½ç½® |
|---------|---------|
| BpfRegState | `state/reg_state.rs` |
| BpfRegType | `state/reg_state.rs` |
| Tnum | `bounds/tnum.rs` |
| ScalarBounds | `bounds/scalar.rs` |
| BpfStackState | `state/stack_state.rs` |
| BpfStackSlot | `state/stack_state.rs` |
| BpfFuncState | `state/verifier_state.rs` |
| BpfVerifierState | `state/verifier_state.rs` |
| BpfReference | `state/reference.rs` |

---

ğŸ‘‰ [ä¸‹ä¸€ç« ï¼šéªŒè¯æµç¨‹è¯¦è§£ | Next: Verification Flow](06-verification-flow.md)
