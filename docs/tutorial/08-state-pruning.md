# ç¬¬å…«ç« ï¼šçŠ¶æ€å‰ªæ | Chapter 8: State Pruning

```
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   "çŠ¶æ€å‰ªææ˜¯éªŒè¯å™¨çš„åŠ é€Ÿå™¨â€”â€”å®ƒè®©æŒ‡æ•°çº§é—®é¢˜å˜å¾—å¯è§£"                         |
|   "State pruning is the verifier's acceleratorâ€”it makes                       |
|    exponential problems tractable"                                            |
|                                                                                   |
|   æ²¡æœ‰å‰ªæï¼ŒéªŒè¯ä¸€ä¸ª 20 ä¸ªåˆ†æ”¯çš„ç¨‹åºéœ€è¦éªŒè¯ 100 ä¸‡æ¡è·¯å¾„                     |
|   Without pruning, verifying a program with 20 branches would                 |
|   require verifying 1 million paths                                           |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

## ğŸ¯ æœ¬ç« ç›®æ ‡ | Chapter Goals

å­¦å®Œè¿™ç« ï¼Œä½ ä¼šç†è§£ï¼š
- è·¯å¾„çˆ†ç‚¸é—®é¢˜çš„æœ¬è´¨ (The nature of path explosion)
- çŠ¶æ€å‰ªæå¦‚ä½•å·¥ä½œ (How state pruning works)
- çŠ¶æ€æ¯”è¾ƒçš„ç²¾ç¡®è§„åˆ™ (Precise rules for state comparison)
- ç²¾ç¡®è¿½è¸ªçš„å¿…è¦æ€§ (The necessity of precision tracking)
- çŠ¶æ€åˆå¹¶ç­–ç•¥ (State merging strategies)

---

## ğŸ’¥ è·¯å¾„çˆ†ç‚¸é—®é¢˜ | Path Explosion Problem

```
+-----------------------------------------------------------------------------------+
|                          è·¯å¾„çˆ†ç‚¸é—®é¢˜                                          |
|                       Path Explosion Problem                                  |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   é—®é¢˜æè¿° | Problem Description:                                             |
|                                                                                   |
|   è€ƒè™‘ä¸€ä¸ªæœ‰å¤šä¸ªæ¡ä»¶åˆ†æ”¯çš„ç¨‹åº:                                               |
|   Consider a program with multiple conditional branches:                      |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   if (c1) { ... }     <- 2 æ¡è·¯å¾„                                        | |
|   |   if (c2) { ... }     <- 2 Ã— 2 = 4 æ¡è·¯å¾„                                | |
|   |   if (c3) { ... }     <- 4 Ã— 2 = 8 æ¡è·¯å¾„                                | |
|   |   ...                                                                   | |
|   |   if (c10) { ... }    <- 2^10 = 1,024 æ¡è·¯å¾„                             | |
|   |   ...                                                                   | |
|   |   if (c20) { ... }    <- 2^20 = 1,048,576 æ¡è·¯å¾„!                        | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   æ¯ä¸ªæ¡ä»¶åˆ†æ”¯ä½¿è·¯å¾„æ•°ç¿»å€ï¼                                                  |
|   Each conditional branch doubles the number of paths!                        |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   è·¯å¾„çˆ†ç‚¸å¯è§†åŒ– | Path Explosion Visualization:                              |
|                                                                                   |
|                              +---+                                            |
|                              | 1 | ç¨‹åºå…¥å£                                   |
|                              +-+-+                                            |
|                    +-----------+-----------+                                  |
|                    v                       v                                  |
|                 +---+                   +---+                                 |
|                 | 2 |                   | 3 |                                 |
|                 +-+-+                   +-+-+                                 |
|            +-----+-----+           +-----+-----+                              |
|            v           v           v           v                              |
|         +---+       +---+       +---+       +---+                             |
|         | 4 |       | 5 |       | 6 |       | 7 |                             |
|         +-+-+       +-+-+       +-+-+       +-+-+                             |
|        +--+--+     +--+--+     +--+--+     +--+--+                            |
|        v     v     v     v     v     v     v     v                            |
|       ...   ...   ...   ...   ...   ...   ...   ...                           |
|                                                                                   |
|       ç»§ç»­ä¸‹å»ï¼Œè·¯å¾„æ•°å‘ˆæŒ‡æ•°å¢é•¿...                                           |
|       Paths grow exponentially...                                             |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ’¡ å‰ªæçš„æ ¸å¿ƒæ€æƒ³ | Core Idea of Pruning

```
+-----------------------------------------------------------------------------------+
|                          å‰ªææ ¸å¿ƒæ€æƒ³                                          |
|                       Core Idea of Pruning                                    |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   å…³é”®æ´å¯Ÿ | Key Insight:                                                     |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   å¦‚æœæˆ‘ä»¬å·²ç»éªŒè¯è¿‡ä¸€ä¸ª"å®½æ³›"çš„çŠ¶æ€ S_oldï¼Œ                            | |
|   |   åæ¥é‡åˆ°ä¸€ä¸ª"æ›´ä¸¥æ ¼"çš„çŠ¶æ€ S_newï¼Œ                                    | |
|   |   é‚£ä¹ˆ S_new ä¸éœ€è¦é‡æ–°éªŒè¯ï¼                                           | |
|   |                                                                         | |
|   |   If we've already verified a "wide" state S_old,                       | |
|   |   and later encounter a "narrower" state S_new,                         | |
|   |   then S_new doesn't need to be re-verified!                            | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   ä¸ºä»€ä¹ˆè¿™æ˜¯æ­£ç¡®çš„ï¼Ÿ| Why is this correct?                                    |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   è®¾:                                                                   | |
|   |   S_old = { r1 âˆˆ [0, 100] }    (å·²éªŒè¯å®‰å…¨)                             | |
|   |   S_new = { r1 âˆˆ [10, 50] }    (å¾…éªŒè¯)                                 | |
|   |                                                                         | |
|   |   å› ä¸º [10, 50] âŠ‚ [0, 100]ï¼š                                            | |
|   |   â€¢ S_new ä¸­ r1 çš„æ¯ä¸ªå¯èƒ½å€¼éƒ½åœ¨ S_old çš„èŒƒå›´å†…                         | |
|   |   â€¢ S_old èƒ½å®‰å…¨å¤„ç† [0, 100] ä¸­çš„ä»»ä½•å€¼                                | |
|   |   â€¢ æ‰€ä»¥ S_old ä¹Ÿèƒ½å®‰å…¨å¤„ç† [10, 50] ä¸­çš„ä»»ä½•å€¼                         | |
|   |   â€¢ å› æ­¤ S_new ä¹Ÿä¸€å®šå®‰å…¨ï¼                                             | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   å›¾ç¤º | Illustration:                                                        |
|                                                                                   |
|   S_old çš„å€¼åŸŸ (å·²éªŒè¯):                                                      |
|   +-------------------------------------------------------------------------+ |
|   | [0----------------------------------------------------------------100] | |
|   |                                                                         | |
|   |         +---------------------------------------+                       | |
|   |         |      [10-------------------50]       | S_new çš„å€¼åŸŸ           | |
|   |         |                                       | (åŒ…å«äº S_old)        | |
|   |         +---------------------------------------+                       | |
|   |                                                                         | |
|   |         S_new âŠ‚ S_old -> S_new å¯ä»¥è¢«å‰ªæ âœ“                              | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ”„ å‰ªææœºåˆ¶è¯¦è§£ | Pruning Mechanism Details

### å‰ªææ£€æŸ¥æµç¨‹ | Pruning Check Flow

```
+-----------------------------------------------------------------------------------+
|                          å‰ªææ£€æŸ¥æµç¨‹                                          |
|                       Pruning Check Flow                                      |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   Step 1: åˆ°è¾¾ç¨‹åºç‚¹ P                                                  | |
|   |   -------------------------------------------------------               | |
|   |   éªŒè¯å™¨æ‰§è¡Œåˆ°ç¨‹åºä½ç½® Pï¼Œå¸¦ç€å½“å‰çŠ¶æ€ S_cur                            | |
|   |                                                                         | |
|   |                 v                                                       | |
|   |                                                                         | |
|   |   Step 2: æŸ¥æ‰¾å†å²çŠ¶æ€                                                  | |
|   |   -------------------------------------------------------               | |
|   |   åœ¨çŠ¶æ€ç¼“å­˜ä¸­æŸ¥æ‰¾ç¨‹åºç‚¹ P çš„æ‰€æœ‰å†å²çŠ¶æ€                               | |
|   |   å†å²çŠ¶æ€åˆ—è¡¨: [S_1, S_2, ..., S_n]                                    | |
|   |                                                                         | |
|   |                 v                                                       | |
|   |                                                                         | |
|   |   Step 3: é€ä¸ªæ¯”è¾ƒ                                                      | |
|   |   -------------------------------------------------------               | |
|   |   for each S_old in å†å²çŠ¶æ€:                                           | |
|   |       if S_old âŠ‡ S_cur:     // S_old è¦†ç›– S_cur                         | |
|   |           -> å‰ªææˆåŠŸï¼è·³è¿‡éªŒè¯                                          | |
|   |                                                                         | |
|   |                 v                                                       | |
|   |                                                                         | |
|   |   Step 4: æ²¡æœ‰åŒ¹é…                                                      | |
|   |   -------------------------------------------------------               | |
|   |   â€¢ ä¿å­˜å½“å‰çŠ¶æ€ S_cur åˆ°ç¼“å­˜                                           | |
|   |   â€¢ ç»§ç»­æ­£å¸¸éªŒè¯                                                        | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   æµç¨‹å›¾ | Flow Chart:                                                        |
|                                                                                   |
|           +-------------------+                                               |
|           |  åˆ°è¾¾ç¨‹åºç‚¹ P     |                                               |
|           |  with çŠ¶æ€ S_cur  |                                               |
|           +---------+---------+                                               |
|                     |                                                         |
|                     v                                                         |
|           +-------------------+                                               |
|           | æŸ¥æ‰¾ P çš„å†å²çŠ¶æ€ |                                               |
|           +---------+---------+                                               |
|                     |                                                         |
|                     v                                                         |
|           +-------------------+     æ˜¯    +-------------------+               |
|           | å­˜åœ¨ S_old âŠ‡ S_cur| --------->|    å‰ªææˆåŠŸï¼     |               |
|           |        ?          |           |  è·³è¿‡åç»­éªŒè¯     |               |
|           +---------+---------+           +-------------------+               |
|                     | å¦                                                      |
|                     v                                                         |
|           +-------------------+                                               |
|           | ä¿å­˜ S_cur åˆ°ç¼“å­˜ |                                               |
|           |    ç»§ç»­éªŒè¯       |                                               |
|           +-------------------+                                               |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### çŠ¶æ€æ¯”è¾ƒè§„åˆ™ | State Comparison Rules

```
+-----------------------------------------------------------------------------------+
|                          çŠ¶æ€æ¯”è¾ƒè§„åˆ™                                          |
|                    State Comparison Rules                                     |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   åˆ¤æ–­ S_old æ˜¯å¦è¦†ç›– S_cur (S_old âŠ‡ S_cur) éœ€è¦æ»¡è¶³æ‰€æœ‰æ¡ä»¶:                 |
|   To determine if S_old covers S_cur (S_old âŠ‡ S_cur), ALL conditions:         |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   æ¡ä»¶ 1: è°ƒç”¨æ ˆæ·±åº¦ç›¸åŒ                                                | |
|   |   Condition 1: Same call stack depth                                    | |
|   |   -----------------------------------------------------------------    | |
|   |   old.curframe == cur.curframe                                          | |
|   |                                                                         | |
|   |   åŸå› : ä¸åŒè°ƒç”¨æ·±åº¦çš„çŠ¶æ€ä¸å¯æ¯”                                        | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   æ¡ä»¶ 2: æ¯ä¸ªå¯„å­˜å™¨éƒ½æ»¡è¶³è¦†ç›–å…³ç³»                                      | |
|   |   Condition 2: Each register satisfies coverage                         | |
|   |   -----------------------------------------------------------------    | |
|   |   for i in 0..11:                                                       | |
|   |       regsafe(old.regs[i], cur.regs[i]) == true                         | |
|   |                                                                         | |
|   |   regsafe è§„åˆ™:                                                         | |
|   |   +-----------------------------------------------------------------+   | |
|   |   | â€¢ old æ˜¯ NOT_INIT -> ä»»ä½• cur éƒ½å¯ä»¥ âœ“                           |   | |
|   |   | â€¢ old å’Œ cur ç±»å‹å¿…é¡»ç›¸åŒ                                       |   | |
|   |   | â€¢ å¯¹äºæ ‡é‡: old çš„èŒƒå›´å¿…é¡» âŠ‡ cur çš„èŒƒå›´                         |   | |
|   |   | â€¢ å¯¹äºæŒ‡é’ˆ: åç§»å’Œ ID å¿…é¡»åŒ¹é…                                  |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   æ¡ä»¶ 3: æ ˆçŠ¶æ€æ»¡è¶³è¦†ç›–å…³ç³»                                            | |
|   |   Condition 3: Stack state satisfies coverage                           | |
|   |   -----------------------------------------------------------------    | |
|   |   stacksafe(old.stack, cur.stack) == true                               | |
|   |                                                                         | |
|   |   stacksafe è§„åˆ™:                                                       | |
|   |   +-----------------------------------------------------------------+   | |
|   |   | â€¢ old çš„æ ˆæ§½æ˜¯ INVALID -> ä»»ä½• cur éƒ½å¯ä»¥ âœ“                      |   | |
|   |   | â€¢ ç›¸åŒçš„ SPILL æ§½: æº¢å‡ºçš„å¯„å­˜å™¨çŠ¶æ€å¿…é¡»æ»¡è¶³ regsafe              |   | |
|   |   | â€¢ ç›¸åŒçš„ MISC/ZERO æ§½: ç›´æ¥åŒ¹é…                                 |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   æ¡ä»¶ 4: å¼•ç”¨çŠ¶æ€æ»¡è¶³è¦†ç›–å…³ç³»                                          | |
|   |   Condition 4: Reference state satisfies coverage                       | |
|   |   -----------------------------------------------------------------    | |
|   |   refs_safe(old.refs, cur.refs) == true                                 | |
|   |                                                                         | |
|   |   refs_safe è§„åˆ™:                                                       | |
|   |   +-----------------------------------------------------------------+   | |
|   |   | â€¢ cur çš„æ‰€æœ‰å¼•ç”¨å¿…é¡»åœ¨ old ä¸­æœ‰å¯¹åº”                             |   | |
|   |   | â€¢ å¼•ç”¨ç±»å‹å¿…é¡»åŒ¹é…                                              |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### çŠ¶æ€æ¯”è¾ƒä»£ç  | State Comparison Code

```rust
// æ–‡ä»¶ä½ç½®: crates/bpf-verifier-core/src/analysis/states_equal.rs

/// æ£€æŸ¥ old_state æ˜¯å¦è¦†ç›– cur_state (å¯ä»¥å‰ªæ)
/// Check if old_state covers cur_state (can prune)
pub fn states_equal(
    old: &BpfVerifierState,
    cur: &BpfVerifierState,
) -> bool {
    // æ¡ä»¶ 1: è°ƒç”¨æ ˆæ·±åº¦ç›¸åŒ
    if old.curframe != cur.curframe {
        return false;
    }
    
    // æ¡ä»¶ 2: æ¯ä¸ªæ ˆå¸§éƒ½åŒ¹é…
    for i in 0..=old.curframe {
        if let (Some(old_frame), Some(cur_frame)) = 
            (&old.frame[i], &cur.frame[i]) {
            if !func_states_equal(old_frame, cur_frame) {
                return false;
            }
        }
    }
    
    // æ¡ä»¶ 3: å¼•ç”¨åŒ¹é…
    if !refs_safe(&old.refs, &cur.refs) {
        return false;
    }
    
    true
}

/// æ¯”è¾ƒå‡½æ•°å¸§çŠ¶æ€
/// Compare function frame states
fn func_states_equal(
    old: &BpfFuncState,
    cur: &BpfFuncState,
) -> bool {
    // æ¯”è¾ƒæ‰€æœ‰å¯„å­˜å™¨
    for i in 0..MAX_BPF_REG {
        if !regsafe(&old.regs[i], &cur.regs[i]) {
            return false;
        }
    }
    
    // æ¯”è¾ƒæ ˆçŠ¶æ€
    if !stacksafe(&old.stack, &cur.stack) {
        return false;
    }
    
    true
}

/// æ¯”è¾ƒå•ä¸ªå¯„å­˜å™¨çŠ¶æ€
/// Compare single register state
fn regsafe(old: &BpfRegState, cur: &BpfRegState) -> bool {
    // NOT_INIT å¯ä»¥è¦†ç›–ä»»ä½•çŠ¶æ€
    if old.reg_type == BpfRegType::NotInit {
        return true;
    }
    
    // ç±»å‹å¿…é¡»ç›¸åŒ
    if old.reg_type != cur.reg_type {
        return false;
    }
    
    match old.reg_type {
        BpfRegType::ScalarValue => {
            // æ ‡é‡: old èŒƒå›´å¿…é¡» âŠ‡ cur èŒƒå›´
            if old.umin_value > cur.umin_value ||
               old.umax_value < cur.umax_value {
                return false;
            }
            if old.smin_value > cur.smin_value ||
               old.smax_value < cur.smax_value {
                return false;
            }
            // Tnum æ£€æŸ¥
            if !tnum_in(cur.var_off, old.var_off) {
                return false;
            }
            // ç²¾åº¦æ£€æŸ¥
            if old.precise && !cur.precise {
                return false;
            }
            true
        }
        _ if is_ptr_type(old.reg_type) => {
            // æŒ‡é’ˆ: åç§»å’Œ ID å¿…é¡»åŒ¹é…
            old.off == cur.off && old.id == cur.id
        }
        _ => old == cur,
    }
}
```

---

## ğŸ“Š å‰ªæç¤ºä¾‹ | Pruning Examples

### ç¤ºä¾‹ 1ï¼šç®€å•åˆ†æ”¯å‰ªæ | Example 1: Simple Branch Pruning

```
+-----------------------------------------------------------------------------------+
|                          ç®€å•åˆ†æ”¯å‰ªæç¤ºä¾‹                                      |
|                   Simple Branch Pruning Example                               |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   ç¨‹åº | Program:                                                             |
|   +-------------------------------------------------------------------------+ |
|   |  0: r0 = r1                                                             | |
|   |  1: if r1 > 10 goto 4   // åˆ†æ”¯ç‚¹                                       | |
|   |  2: r0 = r0 + 1                                                         | |
|   |  3: goto 5                                                              | |
|   |  4: r0 = r0 - 1                                                         | |
|   |  5: exit                // æ±‡åˆç‚¹                                       | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   æ‰§è¡Œè·¯å¾„ | Execution Paths:                                                 |
|                                                                                   |
|                    +---------------+                                          |
|                    |  æŒ‡ä»¤ 0-1     |                                          |
|                    |  r0 = r1      |                                          |
|                    |  if r1 > 10   |                                          |
|                    +-------+-------+                                          |
|                            |                                                  |
|              +-------------+-------------+                                    |
|              |                           |                                    |
|         r1 <= 10                    r1 > 10                                   |
|              |                           |                                    |
|              v                           v                                    |
|   +---------------------+     +---------------------+                         |
|   |  è·¯å¾„ A: æŒ‡ä»¤ 2-3   |     |  è·¯å¾„ B: æŒ‡ä»¤ 4     |                         |
|   |  r0 = r0 + 1        |     |  r0 = r0 - 1        |                         |
|   |  goto 5             |     |  (fall to 5)        |                         |
|   +----------+----------+     +----------+----------+                         |
|              |                           |                                    |
|              +-----------+---------------+                                    |
|                          |                                                    |
|                          v                                                    |
|              +---------------------+                                          |
|              |    æŒ‡ä»¤ 5: exit     | <-- æ±‡åˆç‚¹ (å‰ªæå€™é€‰)                    |
|              |                     |                                          |
|              +---------------------+                                          |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   å‡è®¾è·¯å¾„ A å…ˆæ‰§è¡Œ:                                                          |
|   +-------------------------------------------------------------------------+ |
|   |  åœ¨æŒ‡ä»¤ 5 ä¿å­˜çŠ¶æ€:                                                     | |
|   |  S_A = { r0 âˆˆ [ä»»æ„+1], r1 âˆˆ [0, 10] }                                  | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   è·¯å¾„ B åˆ°è¾¾æŒ‡ä»¤ 5:                                                          |
|   +-------------------------------------------------------------------------+ |
|   |  å½“å‰çŠ¶æ€:                                                              | |
|   |  S_B = { r0 âˆˆ [ä»»æ„-1], r1 âˆˆ [11, âˆ] }                                  | |
|   |                                                                         | |
|   |  æ¯”è¾ƒ S_A å’Œ S_B:                                                       | |
|   |  â€¢ r1 èŒƒå›´ä¸åŒ: [0, 10] vs [11, âˆ] -> ä¸èƒ½å‰ªæ                          | |
|   |                                                                         | |
|   |  ç»§ç»­éªŒè¯è·¯å¾„ B                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### ç¤ºä¾‹ 2ï¼šå¾ªç¯å‰ªæ | Example 2: Loop Pruning

```
+-----------------------------------------------------------------------------------+
|                          å¾ªç¯å‰ªæç¤ºä¾‹                                          |
|                       Loop Pruning Example                                    |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   ç¨‹åº (è®¡æ•°å¾ªç¯) | Program (counting loop):                                  |
|   +-------------------------------------------------------------------------+ |
|   |  0: r0 = 0              // åˆå§‹åŒ–è®¡æ•°å™¨                                 | |
|   |  1: r0 = r0 + 1         // å¾ªç¯ä½“                                       | |
|   |  2: if r0 < 100 goto 1  // å¾ªç¯æ¡ä»¶                                     | |
|   |  3: exit                                                                | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   å¦‚æœæ²¡æœ‰å‰ªæï¼Œéœ€è¦éªŒè¯ 100 æ¬¡è¿­ä»£ï¼                                         |
|   Without pruning, would need to verify 100 iterations!                       |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   å‰ªæè¿‡ç¨‹ | Pruning Process:                                                 |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   è¿­ä»£ 1: åˆ°è¾¾æŒ‡ä»¤ 1, r0 = 0                                            | |
|   |   ä¿å­˜çŠ¶æ€: S_1 = { r0 âˆˆ [0, 0] }                                       | |
|   |   æ‰§è¡Œ r0 += 1, r0 = 1                                                  | |
|   |   æ£€æŸ¥ r0 < 100: true, è·³å›æŒ‡ä»¤ 1                                       | |
|   |                                                                         | |
|   |   è¿­ä»£ 2: åˆ°è¾¾æŒ‡ä»¤ 1, r0 = 1                                            | |
|   |   æ¯”è¾ƒ S_1: [0,0] âŠ‡ [1,1]? å¦ (0 < 1)                                   | |
|   |   ä¿å­˜çŠ¶æ€: S_2 = { r0 âˆˆ [1, 1] }                                       | |
|   |   æ‰§è¡Œ r0 += 1, r0 = 2                                                  | |
|   |   æ£€æŸ¥ r0 < 100: true, è·³å›æŒ‡ä»¤ 1                                       | |
|   |                                                                         | |
|   |   ...                                                                   | |
|   |                                                                         | |
|   |   éªŒè¯å™¨å‘ç°æ¨¡å¼: æ¯æ¬¡è¿­ä»£ r0 å¢åŠ  1ï¼ŒèŒƒå›´æ‰©å±•                          | |
|   |   åˆå¹¶ç­–ç•¥: å°†å·²ä¿å­˜çŠ¶æ€åˆå¹¶ä¸º S_merged = { r0 âˆˆ [0, 99] }              | |
|   |                                                                         | |
|   |   åç»­è¿­ä»£åˆ°è¾¾æŒ‡ä»¤ 1:                                                   | |
|   |   å½“å‰çŠ¶æ€ r0 âˆˆ [k, k] where 0 <= k < 100                               | |
|   |   æ¯”è¾ƒ: [0, 99] âŠ‡ [k, k]? æ˜¯!                                           | |
|   |   -> å‰ªææˆåŠŸï¼ä¸éœ€è¦ç»§ç»­è¿­ä»£                                            | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   å¯è§†åŒ– | Visualization:                                                     |
|                                                                                   |
|       è¿­ä»£ 1      è¿­ä»£ 2      è¿­ä»£ 3     ...    åˆå¹¶å                        |
|                                                                                   |
|       [0]   ->    [1]    ->    [2]    ->  ...  -> [0-----------99]               |
|         \          \          \                     /                        |
|          \          \          \                   /                         |
|           +----------+----------+-----------------+                          |
|                              åˆå¹¶ä¸ºå®½èŒƒå›´                                     |
|                                                                                   |
|   åç»­ä»»ä½• r0 âˆˆ [0, 99] çš„çŠ¶æ€éƒ½å¯ä»¥è¢«å‰ªæ                                    |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ¯ ç²¾ç¡®è¿½è¸ª | Precision Tracking

### ä¸ºä»€ä¹ˆéœ€è¦ç²¾ç¡®è¿½è¸ª | Why Precision Tracking

```
+-----------------------------------------------------------------------------------+
|                          ç²¾ç¡®è¿½è¸ªçš„å¿…è¦æ€§                                      |
|                 The Necessity of Precision Tracking                           |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   é—®é¢˜åœºæ™¯ | Problem Scenario:                                                |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   r1 = *(u32*)(r0 + 0)    // r1 âˆˆ [0, 2^32-1]                          | |
|   |   if r1 > 100 goto error  // r1 âˆˆ [0, 100] (ç»è¿‡æ£€æŸ¥)                  | |
|   |   r2 = array + r1         // è®¡ç®—æ•°ç»„åœ°å€                               | |
|   |   r3 = *(u8*)(r2 + 0)     // éœ€è¦ r1 çš„ç²¾ç¡®è¾¹ç•Œ!                       | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   å¦‚æœç”¨å®½æ³›çš„è¾¹ç•Œ [0, 2^32-1] æ¥å‰ªæ:                                        |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   å‡è®¾åœ¨æŸä¸ªå‰ªæç‚¹ä¿å­˜äº†çŠ¶æ€:                                           | |
|   |   S_old = { r1 âˆˆ [0, 2^32-1] }  (å®½æ³›è¾¹ç•Œ)                              | |
|   |                                                                         | |
|   |   åæ¥åˆ°è¾¾åŒä¸€ç‚¹:                                                       | |
|   |   S_cur = { r1 âˆˆ [0, 100] }     (ç²¾ç¡®è¾¹ç•Œ)                              | |
|   |                                                                         | |
|   |   å¦‚æœä»…æ¯”è¾ƒèŒƒå›´: [0, 2^32-1] âŠ‡ [0, 100] -> å¯ä»¥å‰ªæ                    | |
|   |                                                                         | |
|   |   ä½†é—®é¢˜æ˜¯: S_old æ²¡æœ‰ç»è¿‡è¾¹ç•Œæ£€æŸ¥ï¼Œå¦‚æœå‰ªæï¼Œ                          | |
|   |   åç»­çš„æ•°ç»„è®¿é—®éªŒè¯ä¼šç”¨ [0, 2^32-1] èŒƒå›´ï¼Œä¼šå¤±è´¥!                      | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   è§£å†³æ–¹æ¡ˆ: ç²¾ç¡®è¿½è¸ª | Solution: Precision Tracking                           |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   å½“å¯„å­˜å™¨çš„å€¼ä¼šå½±å“å®‰å…¨å…³é”®æ“ä½œï¼ˆå¦‚å†…å­˜è®¿é—®ï¼‰æ—¶ï¼Œ                      | |
|   |   æ ‡è®°è¯¥å¯„å­˜å™¨ä¸º"éœ€è¦ç²¾ç¡®è¿½è¸ª"(precise = true)                          | |
|   |                                                                         | |
|   |   å‰ªææ—¶çš„é¢å¤–æ£€æŸ¥:                                                     | |
|   |   â€¢ å¦‚æœ old.precise == true è€Œ cur.precise == false -> ä¸èƒ½å‰ªæ        | |
|   |   â€¢ ç¡®ä¿ç²¾ç¡®è¾¹ç•Œä¿¡æ¯ä¸ä¼šåœ¨å‰ªæä¸­ä¸¢å¤±                                    | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### ç²¾ç¡®è¿½è¸ªä»£ç  | Precision Tracking Code

```rust
// æ–‡ä»¶ä½ç½®: crates/bpf-verifier-core/src/analysis/precision.rs

/// æ ‡è®°å¯„å­˜å™¨éœ€è¦ç²¾ç¡®è¿½è¸ª
/// Mark register as needing precision tracking
pub fn mark_precise<P: PlatformSpec>(
    env: &mut GenericVerifierEnv<P>,
    state: &mut BpfVerifierState,
    regno: usize,
) -> Result<()> {
    let reg = &mut state.cur_func_mut()?.regs[regno];
    
    // åªæœ‰æ ‡é‡éœ€è¦ç²¾ç¡®è¿½è¸ª
    if reg.reg_type != BpfRegType::ScalarValue {
        return Ok(());
    }
    
    // å·²ç»æ ‡è®°è¿‡
    if reg.precise {
        return Ok(());
    }
    
    // æ ‡è®°ä¸ºç²¾ç¡®
    reg.precise = true;
    
    // å›æº¯æ ‡è®°å½±å“è¿™ä¸ªå¯„å­˜å™¨çš„æ‰€æœ‰æºå¯„å­˜å™¨
    backtrack_precise(env, state, regno)
}

/// å›æº¯ä¼ æ’­ç²¾ç¡®æ€§è¦æ±‚
/// Backtrack to propagate precision requirement
fn backtrack_precise<P: PlatformSpec>(
    env: &mut GenericVerifierEnv<P>,
    state: &BpfVerifierState,
    regno: usize,
) -> Result<()> {
    let mut idx = state.insn_idx;
    
    // ä»å½“å‰æŒ‡ä»¤å‘å‰è¿½æº¯
    while idx > 0 {
        idx -= 1;
        let insn = &env.insns[idx];
        
        // å¦‚æœè¿™æ¡æŒ‡ä»¤å®šä¹‰äº†ç›®æ ‡å¯„å­˜å™¨
        if insn.dst_reg == regno as u8 {
            // æ£€æŸ¥æºæ“ä½œæ•°ç±»å‹
            let opcode_class = insn.code & 0x07;
            
            match opcode_class {
                BPF_ALU | BPF_ALU64 => {
                    // ALU æŒ‡ä»¤: æºå¯„å­˜å™¨ä¹Ÿéœ€è¦ç²¾ç¡®
                    if insn.code & 0x08 != 0 {
                        // å¯„å­˜å™¨æº
                        mark_precise(env, state, insn.src_reg as usize)?;
                    }
                }
                BPF_LDX => {
                    // å†…å­˜åŠ è½½: åŸºå€å¯„å­˜å™¨éœ€è¦ç²¾ç¡®
                    mark_precise(env, state, insn.src_reg as usize)?;
                }
                _ => {}
            }
            
            break;
        }
    }
    
    Ok(())
}
```

---

## ğŸ”€ çŠ¶æ€åˆå¹¶ | State Merging

### åˆå¹¶ç­–ç•¥ | Merging Strategy

```
+-----------------------------------------------------------------------------------+
|                            çŠ¶æ€åˆå¹¶ç­–ç•¥                                        |
|                      State Merging Strategy                                   |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   å½“å¤šæ¡è·¯å¾„åœ¨åŒä¸€ç‚¹æ±‡åˆæ—¶ï¼Œå¯ä»¥åˆå¹¶çŠ¶æ€ä»¥æé«˜å‰ªææ•ˆç‡:                       |
|   When multiple paths converge, states can be merged to improve pruning:      |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |                    è·¯å¾„ A                è·¯å¾„ B                         | |
|   |                      |                      |                           | |
|   |                      v                      v                           | |
|   |            +-----------------+    +-----------------+                   | |
|   |            | r1 âˆˆ [0, 50]   |    | r1 âˆˆ [30, 100]  |                   | |
|   |            +--------+--------+    +--------+--------+                   | |
|   |                     |                      |                            | |
|   |                     +----------+-----------+                            | |
|   |                                |                                        | |
|   |                                v                                        | |
|   |                     +---------------------+                             | |
|   |                     |   åˆå¹¶ç‚¹ (ç‚¹ P)     |                             | |
|   |                     |   Merge Point       |                             | |
|   |                     +---------------------+                             | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   --------------------------------------------------------------------------- |
|                                                                                   |
|   åˆå¹¶è§„åˆ™ | Merging Rules:                                                   |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   æ ‡é‡åˆå¹¶ | Scalar Merge:                                              | |
|   |   â€¢ å–èŒƒå›´çš„å¹¶é›†: [min(a_min, b_min), max(a_max, b_max)]               | |
|   |                                                                         | |
|   |   ç¤ºä¾‹:                                                                 | |
|   |   S_A: r1 âˆˆ [0, 50]                                                     | |
|   |   S_B: r1 âˆˆ [30, 100]                                                   | |
|   |   åˆå¹¶: r1 âˆˆ [0, 100]                                                   | |
|   |                                                                         | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |   [0-----------50]               S_A                           |   | |
|   |   |            [30------------100]   S_B                           |   | |
|   |   |   [0-----------------------100]  åˆå¹¶ç»“æœ                       |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   ç±»å‹ä¸åŒæ—¶ | When Types Differ:                                       | |
|   |   â€¢ é™çº§ä¸º ScalarValue æˆ–æ ‡è®°ä¸ºå†²çª                                     | |
|   |                                                                         | |
|   |   ç¤ºä¾‹:                                                                 | |
|   |   S_A: r1 = PTR_TO_STACK                                                | |
|   |   S_B: r1 = ScalarValue[0, 100]                                         | |
|   |   åˆå¹¶: r1 = ScalarValue[å…¨èŒƒå›´] (ä¸¢å¤±ç±»å‹ä¿¡æ¯)                         | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

### åˆå¹¶ä»£ç  | Merging Code

```rust
// æ–‡ä»¶ä½ç½®: crates/bpf-verifier-core/src/analysis/state_merge.rs

/// åˆå¹¶ä¸¤ä¸ªå¯„å­˜å™¨çŠ¶æ€
/// Merge two register states
pub fn merge_regs(r1: &BpfRegState, r2: &BpfRegState) -> BpfRegState {
    // ç±»å‹ä¸åŒ -> é™çº§ä¸ºæ ‡é‡
    if r1.reg_type != r2.reg_type {
        return BpfRegState {
            reg_type: BpfRegType::ScalarValue,
            umin_value: 0,
            umax_value: u64::MAX,
            smin_value: i64::MIN,
            smax_value: i64::MAX,
            var_off: Tnum::unknown(),
            precise: false,
            ..Default::default()
        };
    }
    
    // ç›¸åŒç±»å‹ -> åˆå¹¶è¾¹ç•Œ
    match r1.reg_type {
        BpfRegType::ScalarValue => {
            BpfRegState {
                reg_type: BpfRegType::ScalarValue,
                // å–å¹¶é›†
                umin_value: r1.umin_value.min(r2.umin_value),
                umax_value: r1.umax_value.max(r2.umax_value),
                smin_value: r1.smin_value.min(r2.smin_value),
                smax_value: r1.smax_value.max(r2.smax_value),
                var_off: r1.var_off.or(r2.var_off),
                // åªæœ‰ä¸¤è¾¹éƒ½ç²¾ç¡®ï¼Œåˆå¹¶åæ‰ç²¾ç¡®
                precise: r1.precise && r2.precise,
                ..Default::default()
            }
        }
        _ if is_ptr_type(r1.reg_type) => {
            // æŒ‡é’ˆ: åç§»å¿…é¡»ç›¸åŒ
            if r1.off == r2.off && r1.id == r2.id {
                r1.clone()
            } else {
                // åç§»ä¸åŒï¼Œé™çº§ä¸ºæ ‡é‡
                BpfRegState {
                    reg_type: BpfRegType::ScalarValue,
                    ..Default::default()
                }
            }
        }
        _ => r1.clone(),
    }
}
```

---

## âš ï¸ å¸¸è§é™·é˜± | Common Pitfalls

```
+-----------------------------------------------------------------------------------+
|                            å¸¸è§å‰ªæé™·é˜±                                        |
|                       Common Pruning Pitfalls                                 |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                      é™·é˜± 1: æŒ‡é’ˆåç§»å¿½ç•¥                                | |
|   |                   Pitfall 1: Ignoring Pointer Offset                    | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   é”™è¯¯çš„å‰ªæ:                                                           | |
|   |   old_state: r1 = PTR_TO_MAP_VALUE, off = 0                             | |
|   |   cur_state: r1 = PTR_TO_MAP_VALUE, off = 8   <- åç§»ä¸åŒ!               | |
|   |                                                                         | |
|   |   å¦‚æœå¿½ç•¥åç§»å·®å¼‚è¿›è¡Œå‰ªæ:                                             | |
|   |   åç»­è®¿é—® *(r1 + 0) å¯èƒ½è¶Šç•Œï¼                                         | |
|   |                                                                         | |
|   |   æ­£ç¡®åšæ³•: æŒ‡é’ˆåç§»å¿…é¡»ç²¾ç¡®åŒ¹é…                                        | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                   é™·é˜± 2: å¾ªç¯ä¸­ç²¾åº¦ä¸¢å¤±                                 | |
|   |               Pitfall 2: Precision Loss in Loops                        | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   é—®é¢˜ä»£ç :                                                             | |
|   |   +-----------------------------------------------------------------+   | |
|   |   |  loop:                                                          |   | |
|   |   |      r1 = r1 + 1                                                |   | |
|   |   |      if r1 < array_size goto loop                               |   | |
|   |   |      // æ­¤æ—¶ r1 å¯èƒ½å·²å¤±å»ç²¾ç¡®è¾¹ç•Œ                              |   | |
|   |   |      *(array + r1) = 0   // å¯èƒ½ä¸å®‰å…¨!                         |   | |
|   |   +-----------------------------------------------------------------+   | |
|   |                                                                         | |
|   |   ç»è¿‡å¤šæ¬¡å¾ªç¯åˆå¹¶åï¼Œr1 çš„è¾¹ç•Œå¯èƒ½å˜æˆ [0, âˆ)                          | |
|   |   å¤±å»äº†ç²¾ç¡®çš„ä¸Šç•Œä¿¡æ¯                                                  | |
|   |                                                                         | |
|   |   è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨ç²¾ç¡®è¿½è¸ªï¼Œé˜»æ­¢å¯¹å½±å“å®‰å…¨çš„å¯„å­˜å™¨è¿›è¡Œä¸å®‰å…¨åˆå¹¶          | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
|   +-------------------------------------------------------------------------+ |
|   |                    é™·é˜± 3: å¼•ç”¨è¿½è¸ªé—æ¼                                  | |
|   |                 Pitfall 3: Reference Tracking Miss                      | |
|   +-------------------------------------------------------------------------+ |
|   |                                                                         | |
|   |   é—®é¢˜åœºæ™¯:                                                             | |
|   |   old_state: æ— å¼•ç”¨                                                     | |
|   |   cur_state: æŒæœ‰ä¸€ä¸ª map_value å¼•ç”¨                                    | |
|   |                                                                         | |
|   |   å¦‚æœé”™è¯¯å‰ªæ:                                                         | |
|   |   cur_state çš„å¼•ç”¨æ°¸è¿œä¸ä¼šè¢«æ£€æŸ¥é‡Šæ”¾!                                   | |
|   |   å¯èƒ½å¯¼è‡´èµ„æºæ³„æ¼                                                      | |
|   |                                                                         | |
|   |   æ­£ç¡®åšæ³•: å¼•ç”¨å¿…é¡»ç²¾ç¡®åŒ¹é…æ‰èƒ½å‰ªæ                                    | |
|   |                                                                         | |
|   +-------------------------------------------------------------------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

---

## ğŸ“ å°ç»“ | Summary

æœ¬ç« ä»‹ç»äº†çŠ¶æ€å‰ªææœºåˆ¶ï¼š

| æ¦‚å¿µ | è¯´æ˜ | ä»£ç ä½ç½® |
|------|------|---------|
| å‰ªææ£€æŸ¥ | æ¯”è¾ƒæ–°æ—§çŠ¶æ€å†³å®šæ˜¯å¦è·³è¿‡ | `analysis/states_equal.rs` |
| å¯„å­˜å™¨æ¯”è¾ƒ | ç±»å‹å’Œè¾¹ç•ŒåŒ…å«å…³ç³» | `analysis/states_equal.rs` |
| æ ˆæ¯”è¾ƒ | æ ˆæ§½å†…å®¹åŒ¹é… | `analysis/states_equal.rs` |
| ç²¾ç¡®è¿½è¸ª | é˜²æ­¢å®‰å…¨å…³é”®è¾¹ç•Œä¸¢å¤± | `analysis/precision.rs` |
| çŠ¶æ€åˆå¹¶ | å¤šè·¯å¾„æ±‡åˆæ—¶åˆå¹¶çŠ¶æ€ | `analysis/state_merge.rs` |

---

## ğŸ“ ç»ƒä¹  | Exercises

1. **çŠ¶æ€è¦†ç›–åˆ¤æ–­**: åˆ¤æ–­ä»¥ä¸‹çŠ¶æ€èƒ½å¦å‰ªæ
   - å·²ä¿å­˜: r1 âˆˆ [0, 200], r2 = PTR_TO_STACK, off=0
   - å½“å‰: r1 âˆˆ [50, 150], r2 = PTR_TO_STACK, off=0

2. **çŠ¶æ€åˆå¹¶**: ä¸¤æ¡è·¯å¾„åˆ°è¾¾åŒä¸€ç‚¹ï¼š
   - è·¯å¾„ A: r1 = å¸¸é‡ 42
   - è·¯å¾„ B: r1 âˆˆ [0, 100]
   åˆå¹¶å r1 çš„çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Ÿ

3. **ç²¾ç¡®è¿½è¸ª**: ä»¥ä¸‹ä»£ç ä¸­å“ªäº›å¯„å­˜å™¨éœ€è¦ç²¾ç¡®è¿½è¸ªï¼Ÿ
   ```
   r1 = *(u32*)(r0 + 0)
   if r1 > 100 goto error
   r2 = array + r1
   r3 = *(u8*)(r2 + 0)
   ```

---

## ğŸ”— ä»£ç ä½ç½®ç´¢å¼• | Code Location Index

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ |
|------|---------|
| çŠ¶æ€æ¯”è¾ƒ | `analysis/states_equal.rs` |
| çŠ¶æ€åˆå¹¶ | `analysis/state_merge.rs` |
| ç²¾ç¡®è¿½è¸ª | `analysis/precision.rs` |
| å‰ªææ£€æŸ¥ | `analysis/prune.rs` |

---

ğŸ‘‰ [ä¸‹ä¸€ç« ï¼šå¹³å°æŠ½è±¡ | Next: Platform Abstraction](09-platform-abstraction.md)
