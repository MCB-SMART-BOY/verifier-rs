#!/usr/bin/expect -f
#
# Test the IOCTL interface of the BPF Verifier Rust kernel module
#
# This script:
# 1. Boots Alpine VM
# 2. Builds kernel module in VM
# 3. Loads the module
# 4. Compiles and runs IOCTL tests
#

set timeout 300
set VM_DIR [file dirname [info script]]
set DISK "$VM_DIR/alpine-disk.qcow2"
set PROJECT_DIR [file normalize "$VM_DIR/../.."]
set PASSWORD "test123"

# Check for required files
if {![file exists $DISK]} {
    puts "Error: $DISK not found"
    puts "Please run auto-install-alpine.exp first"
    exit 1
}

puts "=== Starting Alpine VM ==="
puts "Project directory: $PROJECT_DIR"

# Start QEMU with project directory mounted
spawn qemu-system-x86_64 \
    -m 2G \
    -smp 2 \
    -enable-kvm \
    -cpu host \
    -drive "file=$DISK,format=qcow2,if=virtio" \
    -virtfs "local,path=$PROJECT_DIR,mount_tag=host0,security_model=mapped-xattr,id=host0" \
    -nic user,model=virtio \
    -nographic

# Wait for login prompt
expect {
    "alpine-test login:" { }
    "login:" { }
    timeout { puts "Timeout waiting for login"; exit 1 }
}

# Login as root
send "root\r"
expect "Password:"
send "$PASSWORD\r"

# Wait for shell prompt
expect {
    "alpine-test:~#" { }
    "#" { }
    timeout { puts "Timeout waiting for shell"; exit 1 }
}

puts "\n=== Mounting project directory ==="
send "mkdir -p /mnt/verifier-rs && mount -t 9p -o trans=virtio host0 /mnt/verifier-rs\r"
expect "#"
sleep 1

puts "\n=== Installing build dependencies ==="
send "apk update && apk add build-base linux-virt-dev binutils\r"
expect {
    "#" { }
    timeout { puts "Timeout installing packages"; exit 1 }
}
sleep 2

puts "\n=== Processing Rust library ==="
send "cd /mnt/verifier-rs/kernel-module && sh strip-rust-lib.sh\r"
expect {
    "SUCCESS" { puts "\n=== No GOT relocations ==="  }
    "#" { }
}
sleep 1

send "\r"
expect "#"

puts "\n=== Building kernel module ==="
send "cd /mnt/verifier-rs/kernel-module && make KBUILD_MODPOST_WARN=1 module 2>&1 | tail -20\r"
expect {
    "#" { }
    timeout { puts "Timeout building module"; exit 1 }
}
sleep 2

send "\r"
expect "#"

puts "\n=== Loading kernel module ==="
send "insmod /mnt/verifier-rs/kernel-module/bpf_verifier_rs.ko 2>&1; echo \"INSMOD_RET=\$?\"\r"
expect {
    -re "INSMOD_RET=0" {
        puts "\n=== Module loaded successfully! ==="
    }
    -re "INSMOD_RET=(\[1-9\]\[0-9\]*)" {
        puts "\n=== Module load failed with code $expect_out(1,string) ==="
        send "dmesg | tail -20\r"
        expect "#"
        send "poweroff\r"
        expect eof
        exit 1
    }
    timeout { puts "Timeout loading module"; exit 1 }
}
sleep 1

send "\r"
expect "#"

# Verify device exists
send "ls -la /dev/bpf_verifier_rs\r"
expect "#"
sleep 1

puts "\n=== Compiling test program ==="
send "cd /mnt/verifier-rs/kernel-module/test && make clean && make 2>&1\r"
expect {
    "#" { }
    timeout { puts "Timeout compiling test"; exit 1 }
}
sleep 1

puts "\n=== Running simple test first ==="
send "/mnt/verifier-rs/kernel-module/test/test_simple 2>&1\r"
expect {
    "Test complete" {
        puts "\n=== Simple test completed ==="
    }
    "Segmentation fault" {
        puts "\n=== SEGFAULT detected ==="
    }
    timeout { puts "Timeout running tests"; exit 1 }
}
expect "#"
sleep 1

# Show dmesg for any kernel messages
puts "\n=== Kernel messages ==="
send "dmesg | tail -50\r"
expect "#"
sleep 1

# Unload module
puts "\n=== Unloading module ==="
send "rmmod bpf_verifier_rs 2>/dev/null; echo done\r"
expect "#"
sleep 1

# Shutdown
puts "\n=== Shutting down VM ==="
send "poweroff\r"

expect {
    "Power down" { }
    "reboot: Power down" { }
    eof { }
    timeout { }
}

puts "\n=========================================="
puts "  IOCTL Test completed!"
puts "=========================================="
