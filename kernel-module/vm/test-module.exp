#!/usr/bin/expect -f
#
# Test loading the pre-built kernel module in Alpine VM
# Assumes Rust library was already built on the host
#

set timeout 300
set VM_DIR [file dirname [info script]]
set DISK "$VM_DIR/alpine-disk.qcow2"
set PROJECT_DIR [file normalize "$VM_DIR/../.."]
set PASSWORD "test123"

# Start QEMU with project directory mounted
puts "=== Starting Alpine VM ==="
spawn qemu-system-x86_64 \
    -m 2G \
    -smp 2 \
    -enable-kvm \
    -cpu host \
    -drive "file=$DISK,format=qcow2,if=virtio" \
    -virtfs "local,path=$PROJECT_DIR,mount_tag=host0,security_model=mapped-xattr,id=host0" \
    -nic user,model=virtio \
    -nographic

# Wait for login prompt
expect {
    "alpine-test login:" { }
    "login:" { }
    timeout { puts "Timeout waiting for login"; exit 1 }
}

# Login as root
send "root\r"
expect "Password:"
send "$PASSWORD\r"

# Wait for shell prompt
expect {
    "alpine-test:~#" { }
    "#" { }
    timeout { puts "Timeout waiting for shell"; exit 1 }
}

puts "\n=== Mounting project directory ==="
send "mkdir -p /mnt/verifier-rs && mount -t 9p -o trans=virtio host0 /mnt/verifier-rs\r"
expect "#"
sleep 1

puts "\n=== Installing build dependencies ==="
send "apk update && apk add build-base linux-virt-dev binutils\r"
expect {
    "#" { }
    timeout { puts "Timeout installing packages"; exit 1 }
}
sleep 2

puts "\n=== Finding kernel version ==="
send "KVER=\$(ls /lib/modules/ | head -1) && echo \"Kernel: \$KVER\"\r"
expect "#"
sleep 1

puts "\n=== Checking Rust library ==="
send "ls -la /mnt/verifier-rs/target/x86_64-linux-kernel/release/libbpf_verifier.a 2>/dev/null && echo 'RUST_LIB_OK' || echo 'NO_RUST_LIB'\r"
expect {
    "RUST_LIB_OK" {
        puts "\n=== Rust library found ==="
    }
    "NO_RUST_LIB" {
        puts "\n=== ERROR: Rust library not found. Build it on host first! ==="
        send "poweroff\r"
        expect eof
        exit 1
    }
    "#" { }
}
sleep 1

puts "\n=== Processing Rust library ==="
send "cd /mnt/verifier-rs/kernel-module && sh strip-rust-lib.sh\r"
expect {
    "SUCCESS" {
        puts "\n=== No GOT relocations - ready for kernel! ==="
    }
    "WARNING" {
        puts "\n=== WARNING: GOT relocations still present ==="
    }
    "#" { }
}
sleep 1

send "\r"
expect "#"

puts "\n=== Building kernel module ==="
send "cd /mnt/verifier-rs/kernel-module && make KBUILD_MODPOST_WARN=1 module 2>&1 | tail -30\r"
expect {
    "#" { }
    timeout { puts "Timeout building module"; exit 1 }
}
sleep 2

# Check if module was created
puts "\n=== Checking for kernel module ==="
send "ls -la /mnt/verifier-rs/kernel-module/*.ko 2>/dev/null && echo 'MODULE_FOUND' || echo 'NO_MODULE'\r"
expect {
    "MODULE_FOUND" {
        puts "\n=== Kernel module file exists! ==="
    }
    "NO_MODULE" {
        puts "\n=== No .ko file found ==="
    }
    "#" { }
}
sleep 1

send "\r"
expect "#"

puts "\n=== Testing module load ==="
send "insmod /mnt/verifier-rs/kernel-module/bpf_verifier_rs.ko 2>&1; echo \"EXIT_CODE=\$?\"\r"
expect {
    "EXIT_CODE=0" {
        puts "\n=== MODULE LOADED SUCCESSFULLY! ==="
    }
    "EXIT_CODE=" {
        puts "\n=== Module load failed ==="
    }
    "#" { }
}
sleep 1

send "lsmod | grep bpf_verifier\r"
expect "#"
sleep 1

send "dmesg | tail -25\r"
expect "#"
sleep 1

puts "\n=== Checking device node ==="
send "ls -la /dev/bpf_verifier_rs 2>/dev/null && echo 'DEVICE_EXISTS' || echo 'NO_DEVICE'\r"
expect "#"
sleep 1

puts "\n=== Unloading module ==="
send "rmmod bpf_verifier_rs 2>/dev/null; echo done\r"
expect "#"
sleep 1

puts "\n=== Shutting down VM ==="
send "poweroff\r"

expect {
    "Power down" { }
    "reboot: Power down" { }
    eof { }
    timeout { }
}

puts "\n=========================================="
puts "  Test completed!"
puts "=========================================="
