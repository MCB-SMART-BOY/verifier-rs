From: Your Name <your@email.com>
Date: Thu, 1 Jan 2025 00:00:00 +0000
Subject: [PATCH 1/3] bpf: Add Rust BPF verifier infrastructure

Add the infrastructure for an optional Rust implementation of the BPF
verifier. This patch adds:

- Kconfig options to enable/disable the Rust verifier
- C glue code for interfacing with the kernel BPF subsystem
- Sysctl parameter for runtime verifier selection

The Rust verifier is disabled by default and can be enabled via:
  CONFIG_BPF_VERIFIER_RUST=y

When enabled, users can switch between C and Rust verifiers at runtime:
  echo 1 > /proc/sys/kernel/bpf_rust_verifier

Signed-off-by: Your Name <your@email.com>
---
 kernel/bpf/Kconfig                  |  3 ++
 kernel/bpf/Kconfig.rust             | 40 ++++++++++++++++
 kernel/bpf/Makefile                 |  1 +
 kernel/bpf/bpf_verifier_rust_glue.c | 85 +++++++++++++++++++++++++++++++++
 kernel/bpf/verifier.c               | 15 ++++++
 5 files changed, 144 insertions(+)
 create mode 100644 kernel/bpf/Kconfig.rust
 create mode 100644 kernel/bpf/bpf_verifier_rust_glue.c

diff --git a/kernel/bpf/Kconfig b/kernel/bpf/Kconfig
index xxxxxxx..xxxxxxx 100644
--- a/kernel/bpf/Kconfig
+++ b/kernel/bpf/Kconfig
@@ -xxx,4 +xxx,7 @@ config BPF_LSM
 	  If you are unsure how to answer this question, answer N.
 
+# Rust BPF verifier options
+source "kernel/bpf/Kconfig.rust"
+
 endmenu # "BPF subsystem"

diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c
index xxxxxxx..xxxxxxx 100644
--- a/kernel/bpf/verifier.c
+++ b/kernel/bpf/verifier.c
@@ -xxx,6 +xxx,13 @@
 #include <linux/bpf_lsm.h>
 #include <linux/btf_ids.h>
 
+#ifdef CONFIG_BPF_VERIFIER_RUST
+extern int bpf_rust_verify_prog(struct bpf_verifier_env *env);
+extern bool bpf_rust_verifier_enabled(void);
+#else
+static inline bool bpf_rust_verifier_enabled(void) { return false; }
+#endif
+
 /* ... */
 
 int bpf_check(struct bpf_prog **prog, union bpf_attr *attr,
@@ -xxx,6 +xxx,14 @@ int bpf_check(struct bpf_prog **prog, union bpf_attr *attr,
 
 	/* existing setup code ... */
 
+#ifdef CONFIG_BPF_VERIFIER_RUST
+	if (bpf_rust_verifier_enabled()) {
+		ret = bpf_rust_verify_prog(env);
+		if (ret != -ENOSYS)
+			goto cleanup;
+	}
+#endif
+
 	/* existing C verifier code ... */
--
2.43.0
